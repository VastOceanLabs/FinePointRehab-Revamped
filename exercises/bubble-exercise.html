<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKCCWBFKE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-RVKCCWBFKE');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Bubble Tap Therapy - Fine Motor Exercise | Fine Point Rehab</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="Interactive bubble therapy exercise designed by Fine Point Rehab to build fine motor control, reaction time, and finger isolation. Accessible, responsive, and evidence-informed rehabilitation tool.">
  <meta name="keywords" content="bubble exercise therapy, stroke hand exercises, fine motor rehabilitation, reaction time training, finger isolation therapy, hand-eye coordination, occupational therapy exercises, TBI recovery exercises, neurological rehabilitation">

  <!-- Open Graph Tags -->
  <meta property="og:title" content="Bubble Tap Therapy - Fine Motor Exercise for Fine Point Rehab">
  <meta property="og:description" content="Interactive bubble therapy exercise for motor skill development, featuring difficulty levels, personal best tracking, and mobile-friendly controls. Evidence-based tool for physical and occupational therapy.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://finepointrehab.com/exercises/bubble-tap-therapy">
  <meta property="og:image" content="https://finepointrehab.com/images/bubble-therapy-preview.jpg">

  <!-- Twitter Card Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Bubble Tap Therapy - Fine Motor Exercise | Fine Point Rehab">
  <meta name="twitter:description" content="Interactive rehabilitation exercise for reaction time and finger isolation with personal best tracking.">
  <meta name="twitter:image" content="https://finepointrehab.com/images/bubble-therapy-preview.jpg">

  <!-- Global tokens & base styles (root-relative) -->
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">

  <style>
    :root {
      --header-h: 64px;
      /* Force dark theme token overrides for proper visibility */
      --text-primary: #f9fafb;
      --text-secondary: #cbd5e1;
    }

    body {
      margin: 0;
      font-family: var(--font-family-sans);
      background: linear-gradient(180deg, #0a0e1a 0%, #1a1f3a 50%, #0f1524 100%);
      color: var(--text-primary);
      min-height: 100vh;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* Sticky header & nav */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: var(--space-4);
      height: var(--header-h);
      background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.2));
      backdrop-filter: blur(8px);
      padding: 0 var(--space-4);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .site-header h1 { font-size: var(--font-size-xl); margin: 0; }

    /* 2-column layout */
    .layout {
      display: grid;
      grid-template-columns: minmax(260px, 360px) 1fr;
      gap: var(--space-4);
      padding: var(--space-4);
      max-width: 1200px;
      margin: 0 auto;
    }
    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
    }

    /* Panels */
    .panel {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .settings-panel {
      padding: var(--space-5);
      overflow: auto;
      max-height: calc(100vh - var(--header-h) - 2 * var(--space-4));
    }

    .game-panel {
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* HUD Row */
    .hud {
      position: relative;
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap: var(--space-3);
      align-items: center;
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .timer-rail { position: relative; height: 8px; width: 100%; background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; }
    .timer-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; background: linear-gradient(90deg, var(--brand-aqua), #8ab4f8); transform-origin: left center; }

    .hud-stat { display: grid; gap: 4px; }
    .hud-stat .label { color: var(--text-secondary); font-size: var(--font-size-sm); }
    .hud-stat .value { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); }

    .hud-controls .btn { min-width: 88px; }

    /* Game container */
    #game-container {
      position: relative;
      width: 100%;
      /* height is managed by flex; keep a sensible minimum */
      min-height: 420px;
      flex: 1 1 auto;
      background:
        radial-gradient(ellipse at 20% 30%, rgba(40,20,80,0.35) 0%, transparent 40%),
        radial-gradient(ellipse at 80% 70%, rgba(20,40,80,0.25) 0%, transparent 40%);
    }

    #stars-container { position: absolute; inset: 0; z-index: 1; pointer-events: none; overflow: hidden; }

    /* Fallback starfield styles */
    .star { position: absolute; background: #fff; border-radius: 50%; opacity: 0.3; animation: twinkle 3s ease-in-out infinite; }
    @keyframes twinkle { 0%, 100% { opacity: 0.2; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.1); } }

    #playable-area { position: absolute; inset: var(--space-3); z-index: 2; border-radius: 16px; }

    .bubble {
      position: absolute;
      z-index: 3;
      width: 80px; height: 80px; /* default, overwritten by JS */
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), rgba(146, 197, 255, 0.85) 45%, rgba(52, 86, 169, 0.85) 60%, rgba(18, 28, 66, 0.9) 100%);
      box-shadow: 0 8px 24px rgba(0,0,0,0.35), inset 0 4px 8px rgba(255,255,255,0.35);
      border: 1px solid rgba(255,255,255,0.35);
      transition: transform 120ms ease;
    }
    .bubble:active { transform: scale(0.96); }

    /* Finger guide */
    #finger-guide { position: absolute; left: 12px; right: 12px; bottom: 12px; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 12px; z-index: 3; }
    .finger-legend { display: flex; gap: 10px; align-items: center; }
    .finger-item { display: flex; gap: 6px; align-items: center; }
    .finger-number { width: 22px; height: 22px; border-radius: 50%; background: rgba(255,255,255,0.12); display: grid; place-items: center; font-size: 12px; }

    /* Modal */
    .modal-overlay { position: absolute; inset: 0; display: none; place-items: center; background: rgba(0,0,0,0.4); z-index: 5; }
    .modal-overlay.open { display: grid; }
    .modal-card { background: rgba(10,12,24,0.95); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: var(--space-5); width: min(680px, calc(100% - 24px)); box-shadow: var(--shadow-lg); }
    .modal-card h2 { margin-top: 0; font-size: var(--font-size-2xl); }
    .modal-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin: var(--space-4) 0; }
    .score-highlight { color: var(--brand-aqua); font-weight: var(--font-weight-bold); }
    .xp-line { font-size: var(--font-size-sm); opacity: 0.9; }

    .hidden { display: none !important; }

    /* Forms & buttons */
    .settings-group { margin-bottom: var(--space-4); }
    .settings-label { display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold); color: var(--brand-aqua); }
    .setting-description { margin-top: 6px; font-size: var(--font-size-sm); color: var(--text-secondary); }

    .btn-row { display: flex; gap: var(--space-2); }

    .input, select, input[type="number"] { width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.14); border-radius: 10px; color: var(--text-primary); }

    .btn { display: inline-flex; align-items: center; justify-content: center; height: 44px; padding: 0 14px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; font-weight: var(--font-weight-semibold); background: rgba(255,255,255,0.06); color: var(--text-primary); }
    .btn:hover { filter: brightness(1.05); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: linear-gradient(90deg, var(--brand-aqua), #8ab4f8); color: #00131f; border-color: rgba(255,255,255,0.16); }
    .btn-outline { background: transparent; border-color: rgba(255,255,255,0.28); }
    .btn-ghost { background: transparent; border-color: transparent; color: var(--text-primary); }

    /* Responsive HUD: give stats room on small screens */
    @media (max-width: 600px) {
      .hud { grid-template-columns: 1fr 1fr; grid-auto-rows: minmax(44px, auto); row-gap: var(--space-2); }
      .hud-controls { grid-column: 1 / -1; display: flex; gap: var(--space-2); justify-content: flex-end; }
      .hud-stat .label { font-size: var(--font-size-xs); }
      .hud-stat .value { font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); }
    }

    /* One control cluster per viewport */
    @media (max-width: 980px) {
      .hud-controls { display: none; }
      .settings-panel .btn-row { display: flex; gap: var(--space-2); }
    }
    @media (min-width: 981px) {
      .hud-controls { display: inline-block; }
      .settings-panel .btn-row { display: none; }
    }

    /* Keep finger guide clear of controls */
    #finger-guide { bottom: calc(var(--space-4) + 8px); z-index: 4; }
  </style>
</head>
<body>
  <!-- Audio elements for feedback -->
  <audio id="pop" preload="auto">
    <source src="../audio/pop.mp3" type="audio/mpeg">
    <source src="../audio/pop.ogg" type="audio/ogg">
  </audio>
  <audio id="sessionComplete" preload="auto">
    <source src="../audio/session-complete.mp3" type="audio/mpeg">
    <source src="../audio/session-complete.ogg" type="audio/ogg">
  </audio>
  <audio id="personalBest" preload="auto">
    <source src="../audio/personal-best.mp3" type="audio/mpeg">
    <source src="../audio/personal-best.ogg" type="audio/ogg">
  </audio>

  <!-- Sticky Header & Nav -->
  <header class="site-header" role="banner">
    <a href="/" class="btn btn-ghost" aria-label="Go to Home">← Home</a>
    <h1>Bubble Tap</h1>
  </header>

  <main class="layout" role="main">
    <!-- Left: Settings panel -->
    <aside class="panel settings-panel" aria-labelledby="settings-title">
      <h2 id="settings-title" class="sr-only">Settings</h2>

      <div class="game-description panel" style="padding: var(--space-4); margin-bottom: var(--space-4);">
        <p><strong>About this exercise:</strong> Tap the moving bubble as quickly and accurately as you can. Adjust the bubble size for difficulty, pick a session duration, and choose which finger(s) you want to practice. Great for hand-eye coordination, reaction time, and finger precision.</p>
      </div>

      <div id="settings-panel" aria-live="polite">
        <div class="settings-group">
          <label class="settings-label" for="bubble-size">Bubble Size (difficulty)</label>
          <p class="setting-description">Larger bubbles are easier; smaller bubbles are harder.</p>
          <select id="bubble-size" class="input" autocomplete="off">
            <option value="large">Large (easy)</option>
            <option value="medium" selected>Medium (normal)</option>
            <option value="small">Small (hard)</option>
          </select>
        </div>

        <div class="settings-group">
          <label class="settings-label" for="session-duration">Session Duration (minutes)</label>
          <input id="session-duration" class="input" type="number" min="1" max="30" step="1" value="2">
        </div>

        <div class="settings-group">
          <label class="settings-label" for="finger-option">Finger Option</label>
          <p class="setting-description">Practice specific fingers in sequence or any finger.</p>
          <select id="finger-option" class="input" autocomplete="off">
            <option value="any" selected>Any finger</option>
            <option value="sequence">Thumb → Pinky (1→5)</option>
            <option value="single">Single finger only</option>
          </select>
        </div>

        <div class="settings-group" id="single-finger-select" style="display:none">
          <label class="settings-label" for="finger-number">Select finger</label>
          <select id="finger-number" class="input" autocomplete="off">
            <option value="1">Thumb (1)</option>
            <option value="2">Index (2)</option>
            <option value="3">Middle (3)</option>
            <option value="4">Ring (4)</option>
            <option value="5">Pinky (5)</option>
          </select>
        </div>

        <div class="settings-group">
          <div class="btn-row">
            <button id="start-btn" class="btn btn-primary" type="button" aria-label="Start session">Start</button>
            <button id="pause-btn" class="btn btn-outline" type="button" aria-label="Pause session" disabled>Pause</button>
            <button id="restart-btn" class="btn btn-outline" type="button" aria-label="Restart session" disabled>Restart</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Right: HUD + Game -->
    <section class="panel game-panel" aria-label="Game area">
      <div class="hud" role="region" aria-label="Game heads-up display">
        <div class="timer-rail" aria-hidden="true">
          <div id="timer-bar" class="timer-bar" style="width:100%"></div>
        </div>

        <div class="hud-stat" aria-live="polite">
          <span class="label">Score</span>
          <span id="score" class="value">0</span>
        </div>

        <div class="hud-stat" aria-live="polite">
          <span class="label">Personal Best</span>
          <span id="personal-best" class="value">0</span>
        </div>

        <div class="hud-stat">
          <span class="label">Difficulty</span>
          <span id="hud-difficulty" class="value">medium</span>
        </div>

        <div class="hud-controls">
          <button id="hud-start" class="btn btn-primary" type="button" aria-label="Start session (HUD)">Start</button>
          <button id="hud-pause" class="btn btn-outline" type="button" aria-label="Pause session (HUD)" disabled>Pause</button>
          <button id="hud-restart" class="btn btn-outline" type="button" aria-label="Restart session (HUD)" disabled>Restart</button>
        </div>
      </div>

      <!-- Game canvas -->
      <div id="game-container" role="application" aria-label="Bubble tap game">
        <div id="stars-container" aria-hidden="true"></div>
        <div id="playable-area" aria-hidden="true"></div>
        <button id="bubble" class="bubble" type="button" aria-label="Tap bubble" tabindex="0"></button>

        <!-- Finger guide -->
        <div id="finger-guide" class="hidden" role="note" aria-live="polite">
          <h3>Finger Guide</h3>
          <div class="finger-legend">
            <div class="finger-item"><div class="finger-number">1</div><span>Thumb</span></div>
            <div class="finger-item"><div class="finger-number">2</div><span>Index</span></div>
            <div class="finger-item"><div class="finger-number">3</div><span>Middle</span></div>
            <div class="finger-item"><div class="finger-number">4</div><span>Ring</span></div>
            <div class="finger-item"><div class="finger-number">5</div><span>Pinky</span></div>
          </div>
        </div>

        <!-- Completion Modal -->
        <div id="completion-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
          <div class="modal-card">
            <h2 id="modal-title">Session Complete</h2>
            <p>Great work! Here are your results:</p>

            <div class="modal-row">
              <div><strong>Score</strong><div id="final-score" class="score-highlight">0</div></div>
              <div><strong>Taps</strong><div id="final-taps">0</div></div>
              <div><strong>Avg Response</strong><div id="final-avg-time">0.00s</div></div>
              <div><strong>Accuracy</strong><div id="final-accuracy">0%</div></div>
            </div>
            <p id="xp-earned" class="xp-line">+0 XP</p>

            <div class="btn-row">
              <button id="modal-restart" class="btn btn-primary" type="button">Start New Session</button>
              <button id="modal-close" class="btn btn-outline" type="button">Close</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Core JavaScript modules -->
  <script type="module">
    // Guarded dynamic imports with graceful fallbacks
    const NullEnhancement = { initializeExercise(){}, handleSessionComplete(){} };
    const NullAudio = { play(){ /* no-op */ } };
    const storageFallback = {
      get:(k, def)=>{ try { return JSON.parse(localStorage.getItem(k)) ?? def; } catch { return def; } },
      set:(k,v)=>{ try { localStorage.setItem(k, JSON.stringify(v)); } catch {} }
    };

    let storage = storageFallback, starfield = null, initUtils = ()=>{}, audio = NullAudio, sessionEnhancement = NullEnhancement;
    let recordSession = (id, diff, score)=>{}, checkAndUnlockAchievements = ()=>{}, markExerciseTried = ()=>{};

    try {
      const u = await import('/js/utils.js');
      storage = u.storage ?? storage;
      starfield = u.starfield ?? starfield;
      initUtils = u.initUtils ?? initUtils;
      audio = u.audio ?? audio;
    } catch {}

    try {
      const s = await import('/js/session-enhancement.js');
      sessionEnhancement = s.sessionEnhancement ?? sessionEnhancement;
    } catch {}

    try {
      const p = await import('/js/progress.js');
      recordSession = p.recordSession ?? recordSession;
    } catch {}

    try {
      const a = await import('/js/achievements.js');
      checkAndUnlockAchievements = a.checkAndUnlockAchievements ?? checkAndUnlockAchievements;
      markExerciseTried = a.markExerciseTried ?? markExerciseTried;
    } catch {}

    // Force dark theme for proper visibility
    document.body.classList.add('dark-theme');
    initUtils();

    // DOM refs
    const bubble = document.getElementById('bubble');
    const starsContainer = document.getElementById('stars-container');
    const playableArea = document.getElementById('playable-area');

    const bubbleSizeSelect = document.getElementById('bubble-size');
    const sessionDurationInput = document.getElementById('session-duration');
    const fingerOptionSelect = document.getElementById('finger-option');

    const scoreEl = document.getElementById('score');
    const pbEl = document.getElementById('personal-best');
    const hudDifficultyEl = document.getElementById('hud-difficulty');
    const timerBar = document.getElementById('timer-bar');

    const fingerGuide = document.getElementById('finger-guide');

    // Buttons (settings panel)
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const restartBtn = document.getElementById('restart-btn');

    // Buttons (HUD)
    const hudStart = document.getElementById('hud-start');
    const hudPause = document.getElementById('hud-pause');
    const hudRestart = document.getElementById('hud-restart');

    // Modal
    const completionModal = document.getElementById('completion-modal');
    const finalScoreEl = document.getElementById('final-score');
    const finalTapsEl = document.getElementById('final-taps');
    const finalAvgTimeEl = document.getElementById('final-avg-time');
    const finalAccuracyEl = document.getElementById('final-accuracy');
    const xpEarnedEl = document.getElementById('xp-earned');
    const modalRestart = document.getElementById('modal-restart');
    const modalClose = document.getElementById('modal-close');

    // Sound fallbacks: try DOM <audio> first, then utils audio module
    const domSounds = {
      pop: document.getElementById('pop'),
      sessionComplete: document.getElementById('sessionComplete'),
      personalBest: document.getElementById('personalBest')
    };
    function playSound(key) {
      try { if (domSounds[key]) { domSounds[key].currentTime = 0; domSounds[key].play(); return; } } catch {}
      try { audio?.play?.(key); } catch {}
    }

    // Game state
    const EXERCISE_ID = 'bubble-tap';
    const bubbleSizes = { large: 90, medium: 70, small: 50 };

    let isActive = false;
    let isPaused = false;
    let taps = 0;
    let misses = 0;
    let score = 0;
    let lastTapTime = 0;
    let totalResponseTime = 0;
    let bubbleSize = bubbleSizes.medium;
    let sessionDurationMs = 2 * 60 * 1000; // default 2 min
    let timeRemaining = sessionDurationMs;
    let timerStart = 0;
    let timerInterval = null;
    let fingerMode = 'any';
    let fingerIndex = 1;

    // PB helpers
    function getPB() { return Number(storage.get('pb_' + EXERCISE_ID, 0)); }
    function setPB(val) {
      const current = getPB();
      if (val > current) { storage.set('pb_' + EXERCISE_ID, val); pbEl.textContent = String(val); return true; }
      pbEl.textContent = String(getPB());
      return false;
    }
    pbEl.textContent = String(getPB());

    // Difficulty into session-enhancement (for streaks/achievements)
    function difficultyLabel() { if (bubbleSize >= bubbleSizes.large) return 'easy'; if (bubbleSize <= bubbleSizes.small) return 'hard'; return 'medium'; }

    function updateHUD() { scoreEl.textContent = String(score); hudDifficultyEl.textContent = difficultyLabel(); }

    // Starfield (fallback if module missing)
    try { starfield?.(starsContainer); } catch {}

    // Ensure bubble is positioned inside playable area (DOM move)
    try { playableArea.appendChild(bubble); } catch {}

    // Bubble placement constrained to playable area
    function placeBubble(randomizeFinger = true) {
      const rect = playableArea.getBoundingClientRect();
      const x = Math.random() * (rect.width - bubbleSize);
      const y = Math.random() * (rect.height - bubbleSize);

      bubble.style.width = bubble.style.height = `${bubbleSize}px`;
      bubble.style.left = `${x}px`;
      bubble.style.top  = `${y}px`;

      if (fingerMode === 'sequence' && randomizeFinger) {
        fingerIndex = ((fingerIndex) % 5) + 1; // cycle 1..5
        showFingerGuide(fingerIndex);
      } else if (fingerMode === 'single') {
        showFingerGuide(Number(document.getElementById('finger-number').value || 1));
      } else {
        hideFingerGuide();
      }

      lastTapTime = performance.now();
    }

    function showFingerGuide(n) {
      fingerGuide.classList.remove('hidden');
      const labels = fingerGuide.querySelectorAll('.finger-item');
      labels.forEach((el, idx) => { el.style.opacity = (idx + 1) === n ? '1' : '0.5'; });
    }
    function hideFingerGuide() { fingerGuide.classList.add('hidden'); }

    function startTimer() {
      timerStart = performance.now();
      const endAt = timerStart + timeRemaining;
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const now = performance.now();
        timeRemaining = Math.max(0, endAt - now);
        const pct = (timeRemaining / sessionDurationMs);
        timerBar.style.transform = `scaleX(${pct})`;
        if (timeRemaining <= 0) { clearInterval(timerInterval); endSession(); }
      }, 100);
    }

    function handleBubbleTap() {
      if (!isActive || isPaused) return;
      const now = performance.now();
      taps++; score++;
      totalResponseTime += (now - lastTapTime);
      playSound('pop');
      placeBubble();
      updateHUD();
    }

    function togglePause() {
      if (!isActive) return;
      isPaused = !isPaused;
      if (isPaused) { clearInterval(timerInterval); timerInterval = null; }
      else { startTimer(); lastTapTime = performance.now(); }
      [pauseBtn, hudPause].forEach(b => { b.textContent = isPaused ? 'Resume' : 'Pause'; b.setAttribute('aria-label', isPaused ? 'Resume session' : 'Pause session'); });
    }

    function restartSession() { if (!isActive) return; clearInterval(timerInterval); isActive = false; isPaused = false; startSession(); }

    function endSession() {
      clearInterval(timerInterval);
      isActive = false; isPaused = false;

      // Stats
      const accuracy = taps > 0 ? Math.round((taps / (taps + misses)) * 100) : 0;
      const avgResponse = taps > 0 ? (totalResponseTime / taps / 1000) : 0;

      // Check for new personal best
      const isNewPB = setPB(score);
      if (isNewPB) {
        const note = document.createElement('div');
        note.textContent = '🎉 New Personal Best!';
        note.className = 'xp-line';
        note.style.position = 'absolute'; note.style.right = '12px'; note.style.top = '12px';
        note.style.background = 'rgba(0,0,0,0.35)'; note.style.padding = '6px 10px'; note.style.borderRadius = '8px';
        document.querySelector('.game-panel')?.appendChild(note);
        setTimeout(() => note.remove(), 2500);
        playSound('personalBest');
      }

      // Notify sessionEnhancement
      sessionEnhancement.handleSessionComplete({ score, difficulty: difficultyLabel(), extras: { taps, misses, accuracy, avg: avgResponse } });
      try { markExerciseTried(EXERCISE_ID); } catch {}
      try { checkAndUnlockAchievements(); } catch {}
      try { recordSession(EXERCISE_ID, difficultyLabel(), score, { accuracy, avg: avgResponse, taps }); } catch {}

      // Modal data
      finalScoreEl.textContent = String(score);
      finalTapsEl.textContent = String(taps);
      finalAvgTimeEl.textContent = `${avgResponse.toFixed(2)}s`;
      finalAccuracyEl.textContent = `${accuracy}%`;
      xpEarnedEl.textContent = `+${Math.max(5, Math.round(score / 2))} XP`;

      playSound('sessionComplete');
      completionModal.classList.add('open');

      // Reset buttons
      [pauseBtn, hudPause].forEach(b => b.disabled = true);
      [restartBtn, hudRestart].forEach(b => b.disabled = false);
      [startBtn, hudStart].forEach(b => b.disabled = false);
    }

    function startSession() {
      // Close any open completion modal
      completionModal.classList.remove('open');

      // Read settings
      bubbleSize = bubbleSizes[bubbleSizeSelect.value];
      sessionDurationMs = Math.max(1, parseInt(sessionDurationInput.value || '2', 10)) * 60 * 1000;
      timeRemaining = sessionDurationMs;
      fingerMode = fingerOptionSelect.value;

      // Reset state
      isActive = true; isPaused = false;
      taps = 0; misses = 0; score = 0; totalResponseTime = 0; fingerIndex = 1;

      hideFingerGuide();
      updateHUD();

      // Buttons
      [startBtn, hudStart].forEach(b => b.disabled = true);
      [pauseBtn, hudPause].forEach(b => { b.disabled = false; b.textContent = 'Pause'; b.setAttribute('aria-label','Pause session'); });
      [restartBtn, hudRestart].forEach(b => b.disabled = true);

      // Bubble + timer
      placeBubble(false);
      startTimer();
    }

    // Event bindings
    [startBtn, hudStart, modalRestart].forEach(b => b.addEventListener('click', startSession));
    [pauseBtn, hudPause].forEach(b => b.addEventListener('click', togglePause));
    [restartBtn, hudRestart].forEach(b => b.addEventListener('click', restartSession));
    modalClose.addEventListener('click', () => completionModal.classList.remove('open'));

    // Close modal on Escape for convenience
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && completionModal.classList.contains('open')) {
        completionModal.classList.remove('open');
      }
    });

    // Accessibility: keyboard bubble tap (Space/Enter), Escape for pause
    bubble.addEventListener('keydown', (e) => {
      if (e.code === 'Space' || e.code === 'Enter') { e.preventDefault(); handleBubbleTap(); }
      else if (e.code === 'Escape') { e.preventDefault(); togglePause(); }
    });
    bubble.addEventListener('click', handleBubbleTap);
    bubble.addEventListener('touchstart', (e) => { e.preventDefault(); handleBubbleTap(); }, {passive:false});

    // Miss tracking with safer semantics for touch: count on pointerup if the press didn't start on the bubble
    let downOnBubble = false;
    bubble.addEventListener('pointerdown', () => { downOnBubble = true; });
    bubble.addEventListener('pointerup',   () => { downOnBubble = false; });
    document.getElementById('game-container').addEventListener('pointerup', (e) => {
      if (!isActive) return;
      if (e.target === bubble || downOnBubble) return;
      misses++;
      downOnBubble = false;
    });

    // Re-place bubble on resize to keep it inside bounds
    window.addEventListener('resize', () => { if (isActive && !isPaused) placeBubble(false); });

    // Expose standardized global endSession hook (already required globally)
    if (!window.endSession) {
      window.endSession = function(score, difficulty = 'easy') {
        try { recordSession(EXERCISE_ID, difficulty, score); } catch {}
        try { markExerciseTried(EXERCISE_ID); } catch {}
        try { checkAndUnlockAchievements(); } catch {}
      };
    }

    // Update finger controls visibility
    fingerOptionSelect.addEventListener('change', () => {
      document.getElementById('single-finger-select').style.display = fingerOptionSelect.value === 'single' ? '' : 'none';
    });
  </script>
</body>
</html>
