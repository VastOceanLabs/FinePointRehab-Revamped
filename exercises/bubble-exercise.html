<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKCCWBFKE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-RVKCCWBFKE');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Bubble Tap Therapy - Fine Motor Exercise | Fine Point Rehab</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="Interactive bubble therapy exercise for stroke rehabilitation and fine motor skills. Evidence-based hand-eye coordination game for physical therapy, occupational therapy, and traumatic brain injury recovery. Home exercise program for finger isolation and reaction time training.">
  <meta name="keywords" content="bubble exercise therapy, stroke hand exercises, fine motor rehabilitation, reaction time training, finger isolation therapy, hand-eye coordination, occupational therapy games, physical therapy exercises, TBI recovery exercises, neurological rehabilitation">

  <!-- Open Graph Tags -->
  <meta property="og:title" content="Bubble Tap Therapy - Fine Motor Exercise for Fine Point Rehab">
  <meta property="og:description" content="Interactive bubble therapy exercise for stroke rehabilitation and fine motor skills. Evidence-based tool for physical and occupational therapy.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://finepointrehab.com/exercises/bubble-tap-therapy">
  <meta property="og:image" content="https://finepointrehab.com/images/bubble-therapy-preview.jpg">

  <!-- Twitter Card Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Bubble Tap Therapy - Fine Motor Exercise | Fine Point Rehab">
  <meta name="twitter:description" content="Interactive rehabilitation exercise for stroke recovery and fine motor skills">
  <meta name="twitter:image" content="https://finepointrehab.com/images/bubble-therapy-preview.jpg">

  <!-- Canonical URL -->
  <link rel="canonical" href="https://finepointrehab.com/exercises/bubble-tap-therapy">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ExercisePlan",
    "name": "Bubble Tap Therapy",
    "description": "Interactive bubble popping exercise for reaction time, finger isolation, and hand-eye coordination.",
    "activityDuration": "PT2M",
    "about": [
      {"@type": "MedicalCondition", "name": "Stroke"},
      {"@type": "MedicalCondition", "name": "Traumatic Brain Injury"},
      {"@type": "MedicalCondition", "name": "Fine Motor Impairment"},
      {"@type": "MedicalCondition", "name": "Upper Limb Dysfunction"}
    ],
    "audience": {
      "@type": "Audience",
      "audienceType": "Patients"
    },
    "provider": {
      "@type": "Organization",
      "name": "Fine Point Rehab",
      "url": "https://finepointrehab.com"
    }
  }
  </script>

  <!-- Design System CSS -->
  <link rel="stylesheet" href="../css/tokens.css">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/components.css">

  <style>
    :root {
      --header-h: 64px;
      /* Force dark theme token overrides for proper visibility */
      --text-primary: #f9fafb;
      --text-secondary: #cbd5e1;
    }

    body {
      margin: 0;
      font-family: var(--font-family-sans);
      background: linear-gradient(180deg, #0a0e1a 0%, #1a1f3a 50%, #0f1524 100%);
      color: var(--text-primary);
      min-height: 100vh;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* Sticky header & nav */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: var(--space-4);
      height: var(--header-h);
      padding: 0 var(--space-4);
      background: rgba(10,14,26,0.6);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .site-header h1 {
      margin: 0;
      font-size: var(--font-size-xl);
      color: #fff;
    }

    /* Layout: left settings panel, right game area */
    .layout {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: var(--space-4);
      padding: var(--space-4);
      min-height: calc(100vh - var(--header-h));
    }

    .panel {
      background: linear-gradient(145deg, rgba(30, 50, 80, 0.95), rgba(20, 35, 60, 0.9));
      border: 1px solid rgba(111, 211, 245, 0.15);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
    }

    .settings-panel {
      padding: var(--space-5);
      overflow: auto;
      max-height: calc(100vh - var(--header-h) - 2 * var(--space-4));
    }

    .game-panel {
      position: relative;
      overflow: hidden;
    }

    /* HUD Row */
    .hud {
      position: relative;
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap: var(--space-3);
      align-items: center;
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .timer-rail {
      position: relative;
      height: 8px;
      width: 100%;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
    }
    #timer-bar {
      position: absolute;
      inset: 0 auto 0 0;
      width: 100%;
      background: var(--brand-aqua);
      transition: width 0.1s linear;
    }

    .hud-stat {
      text-align: right;
      min-width: 110px;
    }
    .hud-stat .label {
      display: block;
      font-size: var(--font-size-xs);
      opacity: 0.8;
      color: var(--text-secondary);
    }
    .hud-stat .value {
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
    }

    .hud-controls .btn {
      margin-left: var(--space-2);
      min-height: var(--touch-target);
    }

    /* Game area */
    #game-container {
      position: relative;
      width: 100%;
      height: calc(100% - 56px); /* account for HUD */
      background:
        radial-gradient(ellipse at 20% 30%, rgba(40,20,80,0.35) 0%, transparent 40%),
        radial-gradient(ellipse at 80% 70%, rgba(20,40,80,0.25) 0%, transparent 40%);
    }

    #stars-container {
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      overflow: hidden;
    }

    /* Fallback starfield styles */
    .star {
      position: absolute;
      background: #fff;
      border-radius: 50%;
      opacity: 0.3;
      animation: twinkle 3s ease-in-out infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.2; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.2); }
    }

    @media (prefers-reduced-motion: reduce) {
      .star { animation: none; opacity: 0.4; }
    }

    #playable-area {
      position: absolute;
      top: var(--space-3);
      left: var(--space-3);
      right: var(--space-3);
      bottom: var(--space-3);
      z-index: 2;
      pointer-events: none; /* bounds only */
    }

    #bubble {
      position: absolute;
      z-index: 5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #121d33;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), var(--brand-aqua, #48cae4));
      box-shadow: 0 0 15px rgba(111,211,245,0.4);
      cursor: pointer;
      transition: transform 0.1s ease-out;
      pointer-events: auto;
      outline: 2px solid transparent;
    }
    #bubble:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
    #bubble:active {
      transform: scale(0.92);
    }
    .burst { animation: burstAnim 0.3s ease-out forwards; }
    @keyframes burstAnim {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      .burst { animation: none; opacity: 0; transition: opacity 0.1s ease-out; }
      #bubble { transition: none; }
    }

    /* Finger guide */
    #finger-guide {
      position: absolute;
      left: 50%;
      bottom: var(--space-4);
      transform: translateX(-50%);
      background: rgba(8,15,35,0.85);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      padding: var(--space-2) var(--space-4);
      box-shadow: var(--shadow);
      z-index: 4;
      backdrop-filter: blur(10px);
      width: min(520px, 92%);
    }
    #finger-guide h3 {
      margin: 0 0 var(--space-2);
      font-size: var(--font-size-sm);
      color: var(--brand-aqua);
      text-align: center;
    }
    .finger-legend { display: flex; gap: var(--space-3); justify-content: center; flex-wrap: wrap; }
    .finger-item { display: flex; align-items: center; gap: var(--space-1); font-size: var(--font-size-sm); }
    .finger-number {
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), var(--brand-aqua));
      width: 24px; height: 24px; border-radius: var(--radius-full);
      display: grid; place-items: center; font-weight: var(--font-weight-bold); color: #121d33;
    }

    /* Completion modal */
    .modal {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(6px);
    }
    .modal.open { display: flex; }
    .modal-card {
      background: linear-gradient(145deg, rgba(30, 50, 80, 0.97), rgba(20, 35, 60, 0.97));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      width: min(560px, 92%);
      color: #fff;
      box-shadow: var(--shadow-lg);
    }
    .modal-card h2 { margin-top: 0; font-size: var(--font-size-2xl); }
    .modal-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin: var(--space-4) 0; }
    .score-highlight { color: var(--brand-aqua); font-weight: var(--font-weight-bold); }
    .xp-line { font-size: var(--font-size-sm); opacity: 0.9; }

    .hidden { display: none !important; }

    /* Forms & buttons */
    .settings-group { margin-bottom: var(--space-4); }
    .settings-label { 
      display: block; 
      margin-bottom: var(--space-2); 
      font-weight: var(--font-weight-semibold); 
      color: var(--brand-aqua); 
    }
    .setting-description { 
      font-size: var(--font-size-sm); 
      opacity: 0.85; 
      margin-bottom: var(--space-2); 
      color: var(--text-secondary);
    }
    select, input {
      width: 100%; padding: var(--space-3); border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.18);
      background: linear-gradient(145deg, rgba(20, 30, 53, 0.9), rgba(15, 26, 46, 0.9));
      color: #fff; font-size: var(--font-size-base);
    }
    select:focus-visible, input:focus-visible { outline: 2px solid var(--brand-aqua); outline-offset: 2px; }

    .btn-row { display: flex; gap: var(--space-2); flex-wrap: wrap; }
    .btn { cursor: pointer; border: none; border-radius: var(--radius); padding: var(--space-3) var(--space-4); }
    .btn-primary { background: var(--brand-gradient); color: #fff; }
    .btn-outline { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.25); }
    .btn-ghost { background: transparent; color: #fff; }
    .btn:focus-visible { outline: 2px solid #fff; outline-offset: 2px; }

    /* Responsive */
    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .settings-panel { max-height: unset; }
      .hud { grid-template-columns: 1fr 1fr 1fr auto; }
      .hud-stat { min-width: unset; }
    }
  </style>
</head>
<body>
  <!-- Audio elements for feedback -->
  <audio id="pop" preload="auto">
    <source src="../audio/pop.mp3" type="audio/mpeg">
    <source src="../audio/pop.ogg" type="audio/ogg">
  </audio>
  <audio id="sessionComplete" preload="auto">
    <source src="../audio/session-complete.mp3" type="audio/mpeg">
    <source src="../audio/session-complete.ogg" type="audio/ogg">
  </audio>
  <audio id="personalBest" preload="auto">
    <source src="../audio/personal-best.mp3" type="audio/mpeg">
    <source src="../audio/personal-best.ogg" type="audio/ogg">
  </audio>

  <!-- Sticky Header & Nav -->
  <header class="site-header" role="banner">
    <a href="/" class="btn btn-ghost" aria-label="Go to Home">‚Üê Home</a>
    <h1>Bubble Tap</h1>
  </header>

  <main class="layout" role="main">
    <!-- Left: Settings panel -->
    <aside class="panel settings-panel" aria-labelledby="settings-title">
      <h2 id="settings-title" class="sr-only">Settings</h2>

      <div class="game-description panel" style="padding: var(--space-4); margin-bottom: var(--space-4);">
        <p><strong>About this exercise:</strong> Tap the moving bubbles as quickly as you can to improve hand-eye coordination, reaction time, and finger precision.</p>
      </div>

      <div id="settings-panel" aria-live="polite">
        <div class="settings-group">
          <label class="settings-label" for="bubble-size">Bubble Size (difficulty)</label>
          <p class="setting-description">Larger bubbles are easier; smaller bubbles require precision.</p>
          <select id="bubble-size" name="bubble-size">
            <option value="very-large">Very Large ‚Äî Easiest</option>
            <option value="large">Large ‚Äî Easy</option>
            <option value="medium" selected>Medium ‚Äî Moderate</option>
            <option value="small">Small ‚Äî Precise</option>
          </select>
        </div>

        <div class="settings-group">
          <label class="settings-label" for="session-duration">Session Duration (minutes)</label>
          <p class="setting-description">Start with 1‚Äî2 minutes and increase as you improve.</p>
          <input id="session-duration" type="number" inputmode="numeric" min="1" max="10" value="2" aria-describedby="session-duration-help">
          <div id="session-duration-help" class="setting-description">1‚Äî10 minutes</div>
        </div>

        <div class="settings-group">
          <label class="settings-label" for="finger-option">Finger Training Mode</label>
          <p class="setting-description">Numbers show which finger to use for each bubble.</p>
          <select id="finger-option" name="finger-option">
            <option value="none">No finger guidance ‚Äî Any finger</option>
            <option value="all" selected>All fingers (1‚Äî5) ‚Äî Random</option>
            <option value="1">Thumb only (1)</option>
            <option value="2">Index only (2)</option>
            <option value="3">Middle only (3)</option>
            <option value="4">Ring only (4)</option>
            <option value="5">Pinky only (5)</option>
          </select>
        </div>

        <div class="settings-group">
          <div class="btn-row">
            <button id="start-btn" class="btn btn-primary" type="button" aria-label="Start session">Start</button>
            <button id="pause-btn" class="btn btn-outline" type="button" aria-label="Pause session" disabled>Pause</button>
            <button id="restart-btn" class="btn btn-outline" type="button" aria-label="Restart session" disabled>Restart</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Right: HUD + Game -->
    <section class="panel game-panel" aria-label="Game area">
      <!-- HUD Row -->
      <div class="hud" role="region" aria-label="Session heads-up display">
        <div class="timer-rail" aria-hidden="true">
          <div id="timer-bar"></div>
        </div>

        <div class="hud-stat" aria-live="polite">
          <span class="label">Score</span>
          <span id="score" class="value">0</span>
        </div>

        <div class="hud-stat" aria-live="polite">
          <span class="label">Personal Best</span>
          <span id="personal-best" class="value">0</span>
        </div>

        <div class="hud-stat">
          <span class="label">Difficulty</span>
          <span id="hud-difficulty" class="value">medium</span>
        </div>

        <div class="hud-controls">
          <button id="hud-start" class="btn btn-primary" type="button" aria-label="Start session (HUD)">Start</button>
          <button id="hud-pause" class="btn btn-outline" type="button" aria-label="Pause session (HUD)" disabled>Pause</button>
          <button id="hud-restart" class="btn btn-outline" type="button" aria-label="Restart session (HUD)" disabled>Restart</button>
        </div>
      </div>

      <!-- Game canvas -->
      <div id="game-container" role="application" aria-label="Bubble tap game">
        <div id="stars-container" aria-hidden="true"></div>
        <div id="playable-area" aria-hidden="true"></div>
        <button id="bubble" class="bubble" type="button" aria-label="Tap bubble" tabindex="0"></button>

        <!-- Finger guide -->
        <div id="finger-guide" class="hidden" role="note" aria-live="polite">
          <h3>Finger Guide</h3>
          <div class="finger-legend">
            <div class="finger-item"><div class="finger-number">1</div><span>Thumb</span></div>
            <div class="finger-item"><div class="finger-number">2</div><span>Index</span></div>
            <div class="finger-item"><div class="finger-number">3</div><span>Middle</span></div>
            <div class="finger-item"><div class="finger-number">4</div><span>Ring</span></div>
            <div class="finger-item"><div class="finger-number">5</div><span>Pinky</span></div>
          </div>
        </div>

        <!-- Completion Modal -->
        <div id="completion-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="completion-title">
          <div class="modal-card panel">
            <h2 id="completion-title">Session Complete!</h2>
            <div class="modal-row">
              <div>Final Score: <span id="final-score" class="score-highlight">0</span></div>
              <div>Bubbles Tapped: <span id="final-taps" class="score-highlight">0</span></div>
              <div>Avg. Response: <span id="final-avg-time" class="score-highlight">0.0s</span></div>
              <div>Accuracy: <span id="final-accuracy" class="score-highlight">0%</span></div>
            </div>
            <p class="xp-line">You earned <span id="xp-earned" class="score-highlight">+0</span> XP. Any unlocked achievements will appear as a toast.</p>
            <div class="btn-row" style="justify-content:flex-end">
              <button id="modal-restart" class="btn btn-primary" type="button">Start New Session</button>
              <button id="modal-close" class="btn btn-outline" type="button">Close</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Core JavaScript modules -->
  <script type="module">
    // Root-relative imports per global standard
    import { storage, starfield, initUtils, audio } from '/js/utils.js';
    import { sessionEnhancement } from '/js/session-enhancement.js';
    import { recordSession } from '/js/progress.js';
    import { checkAndUnlockAchievements, markExerciseTried } from '/js/achievements.js';

    // Force dark theme for proper visibility
    document.body.classList.add('dark-theme');
    
    initUtils();

    // DOM refs
    const bubble = document.getElementById('bubble');
    const starsContainer = document.getElementById('stars-container');
    const playableArea = document.getElementById('playable-area');

    const bubbleSizeSelect = document.getElementById('bubble-size');
    const sessionDurationInput = document.getElementById('session-duration');
    const fingerOptionSelect = document.getElementById('finger-option');

    const scoreEl = document.getElementById('score');
    const pbEl = document.getElementById('personal-best');
    const hudDifficultyEl = document.getElementById('hud-difficulty');
    const timerBar = document.getElementById('timer-bar');

    const fingerGuide = document.getElementById('finger-guide');

    // Buttons (settings panel)
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const restartBtn = document.getElementById('restart-btn');

    // Buttons (HUD)
    const hudStart = document.getElementById('hud-start');
    const hudPause = document.getElementById('hud-pause');
    const hudRestart = document.getElementById('hud-restart');

    // Modal
    const completionModal = document.getElementById('completion-modal');
    const finalScoreEl = document.getElementById('final-score');
    const finalTapsEl = document.getElementById('final-taps');
    const finalAvgTimeEl = document.getElementById('final-avg-time');
    const finalAccuracyEl = document.getElementById('final-accuracy');
    const xpEarnedEl = document.getElementById('xp-earned');
    const modalRestart = document.getElementById('modal-restart');
    const modalClose = document.getElementById('modal-close');

    // Game state
    const EXERCISE_ID = 'bubble';
    let isActive = false;
    let isPaused = false;
    let timerInterval = null;
    let sessionDurationMs = 2 * 60 * 1000;
    let timeRemaining = sessionDurationMs;

    let bubbleSize = 100; // px
    let fingerMode = 'all';

    let score = 0;
    let taps = 0;
    let misses = 0;
    let lastBubbleTime = 0;
    let totalResponseTime = 0;

    const bubbleSizes = {
      'very-large': 150,
      'large': 120,
      'medium': 100,
      'small': 70
    };

    // Starfield implementation (fix for missing starfield.generate)
    function createStarfield(container, count = 60) {
      if (!container) return;
      
      // Respect reduced motion preference
      const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      
      container.innerHTML = '';
      const fragment = document.createDocumentFragment();
      
      for (let i = 0; i < count; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        
        const size = 1 + Math.random() * 2.5;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.opacity = `${0.2 + Math.random() * 0.6}`;
        
        if (!reducedMotion) {
          const duration = 3 + Math.random() * 2;
          const delay = Math.random() * 3;
          star.style.animationDelay = `${delay}s`;
          star.style.animationDuration = `${duration}s`;
        }
        
        fragment.appendChild(star);
      }
      
      container.appendChild(fragment);
    }

    // Initialize starfield
    createStarfield(starsContainer, 60);

    // Difficulty mapping: bubble sizes to standard difficulty levels
    function mapToStandardDifficulty(bubbleSize) {
      switch(bubbleSize) {
        case 'very-large': return 'easy';
        case 'large': return 'easy';
        case 'medium': return 'medium';
        case 'small': return 'hard';
        default: return 'medium';
      }
    }

    // Personal best (local) - FIXED: use storage.get/set
    function getPB() {
      return Number(storage.get('pb_' + EXERCISE_ID, 0));
    }
    function setPB(val) {
      const current = getPB();
      if (val > current) {
        storage.set('pb_' + EXERCISE_ID, val);
        pbEl.textContent = String(val);
        return true; // new PB
      }
      pbEl.textContent = String(getPB());
      return false;
    }
    pbEl.textContent = String(getPB());

    // Difficulty into session-enhancement (for streaks/targets)
    function currentDifficulty() {
      return mapToStandardDifficulty(bubbleSizeSelect?.value || 'medium');
    }
    sessionEnhancement.initializeExercise(EXERCISE_ID, currentDifficulty());
    
    bubbleSizeSelect.addEventListener('change', () => {
      const standardDiff = currentDifficulty();
      hudDifficultyEl.textContent = standardDiff;
      sessionEnhancement.initializeExercise(EXERCISE_ID, standardDiff);
      saveSettings();
    });
    hudDifficultyEl.textContent = currentDifficulty();

    // Settings persistence - FIXED: use storage.get/set
    function saveSettings() {
      storage.set('bubbleSettings', {
        bubbleSize: bubbleSizeSelect.value,
        sessionDuration: sessionDurationInput.value,
        fingerOption: fingerOptionSelect.value
      });
    }

    function loadSettings() {
      const s = storage.get('bubbleSettings');
      if (s) {
        bubbleSizeSelect.value = s.bubbleSize || 'medium';
        sessionDurationInput.value = s.sessionDuration || '2';
        fingerOptionSelect.value = s.fingerOption || 'all';
        hudDifficultyEl.textContent = currentDifficulty();
      }
    }
    loadSettings();

    // Save settings on change
    sessionDurationInput.addEventListener('change', saveSettings);
    fingerOptionSelect.addEventListener('change', saveSettings);

    // Controls hookup (both locations)
    [startBtn, hudStart].forEach(b => b.addEventListener('click', startSession));
    [pauseBtn, hudPause].forEach(b => b.addEventListener('click', togglePause));
    [restartBtn, hudRestart, modalRestart].forEach(b => b.addEventListener('click', restartSession));
    modalClose.addEventListener('click', () => completionModal.classList.remove('open'));

    // Accessibility: keyboard bubble tap (Space/Enter)
    bubble.addEventListener('keydown', (e) => {
      if (e.code === 'Space' || e.code === 'Enter') {
        e.preventDefault();
        handleBubbleTap();
      }
    });
    bubble.addEventListener('click', handleBubbleTap);
    bubble.addEventListener('touchstart', (e) => { 
      e.preventDefault(); 
      handleBubbleTap(); 
    }, {passive:false});

    // Miss tracking (clicks not on bubble)
    document.getElementById('game-container').addEventListener('pointerdown', (e) => {
      if (!isActive || e.target === bubble) return;
      misses++;
    });

    function startSession() {
      // Read settings
      bubbleSize = bubbleSizes[bubbleSizeSelect.value];
      sessionDurationMs = Math.max(1, parseInt(sessionDurationInput.value || '2', 10)) * 60 * 1000;
      timeRemaining = sessionDurationMs;
      fingerMode = fingerOptionSelect.value;

      // Save settings
      saveSettings();

      // Reset state
      score = 0; taps = 0; misses = 0; totalResponseTime = 0;
      updateHUD();
      setBubbleSize();

      // UI
      enableRunningUI();
      if (fingerMode !== 'none') {
        fingerGuide.classList.remove('hidden'); 
      } else {
        fingerGuide.classList.add('hidden');
      }

      // Start
      isActive = true;
      isPaused = false;
      lastBubbleTime = performance.now();
      timerBar.style.width = '100%';
      placeBubble();

      clearInterval(timerInterval);
      timerInterval = setInterval(tick, 100);

      // Auto-scroll to game on mobile
      if (window.innerWidth <= 980) {
        setTimeout(() => {
          document.getElementById('game-container').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
          });
        }, 100);
      }
    }

    function togglePause() {
      if (!isActive) return;
      isPaused = !isPaused;
      [pauseBtn, hudPause].forEach(b => b.textContent = isPaused ? 'Resume' : 'Pause');
    }

    function restartSession() {
      endSessionInternal({showModal:false});
      startSession();
    }

    function tick() {
      if (!isActive || isPaused) return;
      timeRemaining -= 100;
      const progress = timeRemaining / sessionDurationMs;
      timerBar.style.width = Math.max(0, progress * 100) + '%';

      if (timeRemaining <= 0) {
        endSessionInternal({showModal:true});
      }
    }

    function handleBubbleTap() {
      if (!isActive || isPaused) return;

      const now = performance.now();
      const responseTime = now - lastBubbleTime;
      totalResponseTime += responseTime;

      // Points: faster = more, with floor of 10 at slowest (>= 3000ms baseline)
      const points = Math.max(10, Math.floor(3000 / responseTime * 100));
      score += points;
      taps++;

      // Audio feedback
      audio.play('pop');

      bubble.classList.add('burst');
      setTimeout(() => {
        bubble.classList.remove('burst');
        placeBubble();
        lastBubbleTime = performance.now();
      }, 300);

      updateHUD();
    }

    function endSessionInternal({showModal}) {
      clearInterval(timerInterval);
      isActive = false;
      isPaused = false;

      // Stats
      const accuracy = taps > 0 ? Math.round((taps / (taps + misses)) * 100) : 0;
      const avgResponse = taps > 0 ? (totalResponseTime / taps / 1000) : 0;

      // Check for new personal best
      const isNewPB = setPB(score);

      // Notify sessionEnhancement
      sessionEnhancement.handleSessionComplete({
        score,
        taps,
        accuracy,
        avgResponseTime: Number(avgResponse.toFixed(2))
      });

      // Progress & Achievements - use mapped difficulty
      const standardDiff = currentDifficulty();
      if (window.endSession) {
        window.endSession(score, standardDiff);
      }

      // Audio feedback
      if (isNewPB) {
        audio.play('personalBest');
      } else {
        audio.play('sessionComplete');
      }

      // Completion modal
      if (showModal) {
        finalScoreEl.textContent = String(score);
        finalTapsEl.textContent = String(taps);
        finalAvgTimeEl.textContent = avgResponse.toFixed(2) + 's';
        finalAccuracyEl.textContent = accuracy + '%';
        // Simple XP calc: 1 XP per 50 points (round down)
        const xp = Math.floor(score / 50);
        xpEarnedEl.textContent = `+${xp}`;
        
        // Add new PB indicator
        if (isNewPB) {
          const pbIndicator = document.createElement('p');
          pbIndicator.className = 'xp-line';
          pbIndicator.style.color = 'var(--brand-aqua)';
          pbIndicator.textContent = 'üéâ New Personal Best!';
          xpEarnedEl.parentElement.appendChild(pbIndicator);
        }
        
        completionModal.classList.add('open');
      }

      // Reset controls
      disableRunningUI();
      bubble.classList.add('hidden');
      timerBar.style.width = '0%';
      fingerGuide.classList.add('hidden');
    }

    function setBubbleSize() {
      bubble.style.width = bubbleSize + 'px';
      bubble.style.height = bubbleSize + 'px';
      bubble.style.fontSize = Math.round(bubbleSize * 0.3) + 'px';
    }

    function placeBubble() {
      bubble.classList.remove('hidden');

      const areaRect = playableArea.getBoundingClientRect();
      const pad = 10;
      const minX = areaRect.left + pad;
      const maxX = areaRect.right - pad - bubbleSize;
      const minY = areaRect.top + pad;
      const maxY = areaRect.bottom - pad - bubbleSize;

      const x = Math.max(minX, Math.min(maxX, minX + Math.random() * (maxX - minX)));
      const y = Math.max(minY, Math.min(maxY, minY + Math.random() * (maxY - minY)));

      // Position relative to viewport, convert to container coordinates
      const containerRect = document.getElementById('game-container').getBoundingClientRect();
      bubble.style.left = (x - containerRect.left) + 'px';
      bubble.style.top  = (y - containerRect.top) + 'px';

      // Finger number
      if (fingerMode !== 'none') {
        let fingerNumber = fingerMode === 'all' ? (Math.floor(Math.random() * 5) + 1) : parseInt(fingerMode, 10);
        bubble.textContent = String(fingerNumber);
        bubble.setAttribute('aria-label', `Tap bubble with finger ${fingerNumber}`);
      } else {
        bubble.textContent = '';
        bubble.setAttribute('aria-label', 'Tap bubble');
      }
      bubble.focus({preventScroll:true});
    }

    function updateHUD() {
      scoreEl.textContent = String(score);
      pbEl.textContent = String(getPB());
      hudDifficultyEl.textContent = currentDifficulty();
    }

    function enableRunningUI() {
      [pauseBtn, hudPause, restartBtn, hudRestart].forEach(b => b.disabled = false);
      [startBtn, hudStart].forEach(b => b.disabled = true);
      
      // Hide settings panel on mobile during gameplay
      if (window.innerWidth <= 980) {
        document.querySelector('.settings-panel').style.display = 'none';
      }
    }

    function disableRunningUI() {
      [pauseBtn, hudPause, restartBtn, hudRestart].forEach(b => b.disabled = true);
      [startBtn, hudStart].forEach(b => b.disabled = false);
      [pauseBtn, hudPause].forEach(b => b.textContent = 'Pause');
      
      // Show settings panel again on mobile
      if (window.innerWidth <= 980) {
        document.querySelector('.settings-panel').style.display = 'block';
      }
    }

    // Expose standardized global endSession hook (already required globally)
    // Keep for safety if not defined elsewhere (no duplicate toasts here).
    if (!window.endSession) {
      window.endSession = function(score, difficulty = 'easy') {
        recordSession(EXERCISE_ID, difficulty, score);
        try { markExerciseTried(EXERCISE_ID); } catch {}
        try { checkAndUnlockAchievements(); } catch {}
      };
    }
  </script>
</body>
</html>