<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Comet Tap — FinePointRehab</title>
  <meta name="description" content="Tap the moving comets before they exit the screen. Adjustable size, speed, and spawn rate.">

  <!-- Site styles (root-relative, as in your project) -->
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">

  <style>
    :root{
      --panel-max: 1000px;
      --panel-pad: 16px;
      --hud-h: 56px;
    }
    body {
      background: var(--bg-secondary, #f8fafc);
      color: var(--text-primary, #111827);
      -webkit-tap-highlight-color: transparent;
    }
    header.nav {
      position: sticky; top: 0;
      backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg-primary, #fff) 82%, transparent);
      border-bottom: 1px solid var(--bg-tertiary, #e5e7eb);
      z-index: 50;
    }
    header.nav .wrap, main .wrap { max-width: var(--panel-max); margin: 0 auto; padding: 12px var(--panel-pad); }
    header.nav a { text-decoration: none; font-weight: 600; }

    h1 { margin: 8px 0 4px; }
    .lede { color: var(--text-secondary,#6b7280); margin: 0 0 12px; }

    /* Layout: controls first, then canvas below (so controls stay interactive) */
    .grid {
      display: grid; gap: 16px;
      grid-template-columns: 1fr;
    }

    /* Settings panel */
    .card {
      background: var(--bg-primary, #fff);
      border: 1px solid var(--bg-tertiary,#e5e7eb);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      position: relative;
      z-index: 3; /* ABOVE canvas so it's clickable */
    }
    .fieldset { margin: 12px 0; }
    .fieldset legend { font-weight: 600; margin-bottom: 8px; }
    .choices { display: flex; flex-wrap: wrap; gap: 8px; }
    .choices label {
      display: inline-flex; align-items: center; gap: 8px;
      border: 1px solid var(--bg-tertiary,#e5e7eb);
      border-radius: 999px; padding: 8px 12px; cursor: pointer;
      user-select: none;
    }
    .choices input { accent-color: var(--brand-blue,#2563eb); }

    /* Sticky action bar so Start is always reachable on phones */
    .actions {
      position: sticky; bottom: env(safe-area-inset-bottom, 0);
      background: var(--bg-primary,#fff);
      border: 1px solid var(--bg-tertiary,#e5e7eb);
      border-radius: 16px;
      padding: 10px;
      display: flex; gap: 8px; justify-content: space-between; align-items: center;
      z-index: 4; /* above canvas */
    }
    .btn {
      appearance: none; border: 0; cursor: pointer;
      padding: 10px 14px; border-radius: 10px; font-weight: 600;
    }
    .btn.primary { background: var(--brand-blue,#2563eb); color: #fff; }
    .btn.ghost { background: transparent; border: 1px solid var(--bg-tertiary,#e5e7eb); }
    .btn.warn { background: var(--error-color,#ef4444); color: #fff; }

    .stats { display:flex; gap:12px; flex-wrap:wrap; font-size:.95rem; color: var(--text-secondary,#6b7280); }

    /* Canvas area */
    .stage-card {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: radial-gradient(circle at 50% 40%, rgba(72,202,228,.12), transparent 55%), var(--bg-primary,#fff);
      border: 1px solid var(--bg-tertiary,#e5e7eb);
      z-index: 1; /* BELOW panel/controls */
    }
    #stage {
      display:block; width:100%; height:56vh; max-height:720px;
      touch-action: manipulation; /* faster taps */
    }
    /* Pause overlay inside the stage */
    .pause-overlay {
      position:absolute; inset:0; display:none; place-items:center;
      background: color-mix(in oklab, black 18%, transparent);
      color:#fff; font-weight:700; font-size: clamp(1rem, 2.5vw, 1.25rem);
      z-index: 2; pointer-events:none;
    }
    .pause-overlay.show { display:grid; }

    /* Results panel (hidden until complete) */
    .results { display:none; }
    .results.show { display:block; }

    @media (min-width: 900px){
      .grid { grid-template-columns: 1fr 1fr; align-items: start; }
      #stage { height: 66vh; }
      .actions { position: static; }
    }
  </style>
</head>
<body>
  <header class="nav">
    <div class="wrap">
      <a href="/" aria-label="Back to Home">← Home</a>
    </div>
  </header>

  <main>
    <div class="wrap">
      <h1>Comet Tap</h1>
      <p class="lede">Glowing comets streak across the screen. Tap a comet before it exits to score points. Smaller &amp; faster = harder (and more points).</p>

      <div class="grid">
        <!-- Settings & Actions (top, above the canvas for clickability) -->
        <section class="card" aria-labelledby="settings-h">
          <h2 id="settings-h">Settings</h2>

          <fieldset class="fieldset">
            <legend>Session Duration (minutes)</legend>
            <div class="choices" role="radiogroup" aria-label="Duration (minutes)">
              <label><input type="radio" name="duration" value="0.5"> 0.5</label>
              <label><input type="radio" name="duration" value="1" checked> 1</label>
              <label><input type="radio" name="duration" value="2"> 2</label>
              <label><input type="radio" name="duration" value="3"> 3</label>
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend>Comet Size</legend>
            <div class="choices" role="radiogroup" aria-label="Comet size">
              <label><input type="radio" name="size" value="large" checked> Large (easier)</label>
              <label><input type="radio" name="size" value="medium"> Medium</label>
              <label><input type="radio" name="size" value="small"> Small (harder)</label>
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend>Comet Speed</legend>
            <div class="choices" role="radiogroup" aria-label="Comet speed">
              <label><input type="radio" name="speed" value="slow" checked> Slow</label>
              <label><input type="radio" name="speed" value="medium"> Medium</label>
              <label><input type="radio" name="speed" value="fast"> Fast</label>
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend>Spawn Rate</legend>
            <div class="choices" role="radiogroup" aria-label="Spawn rate">
              <label><input type="radio" name="spawn" value="slow" checked> Slow (2s)</label>
              <label><input type="radio" name="spawn" value="med"> Medium (1.5s)</label>
              <label><input type="radio" name="spawn" value="fast"> Fast (1s)</label>
              <label><input type="radio" name="spawn" value="vfast"> Very Fast (0.5s)</label>
            </div>
          </fieldset>

          <div class="actions" role="group" aria-label="Session actions">
            <div style="display:flex; gap:8px;">
              <button id="startBtn" class="btn primary" type="button">Start</button>
              <button id="pauseBtn" class="btn ghost" type="button" disabled>Pause</button>
              <button id="restartBtn" class="btn ghost" type="button" disabled>Restart</button>
            </div>
            <div class="stats" aria-live="polite">
              <span>Score: <strong id="scoreEl">0</strong></span>
              <span>Best: <strong id="bestEl">0</strong></span>
              <span>Difficulty: <strong id="diffEl">Medium</strong></span>
            </div>
          </div>
        </section>

        <!-- Stage -->
        <section class="stage-card" aria-labelledby="stage-h">
          <h2 id="stage-h" class="sr-only">Stage</h2>
          <canvas id="stage" width="1280" height="720" aria-label="Game stage"></canvas>
          <div id="pauseOverlay" class="pause-overlay">Paused — tap Pause to resume</div>

          <div id="results" class="card results" aria-live="polite" style="margin:16px;">
            <h3>Session Complete!</h3>
            <p>Final Score: <strong id="finalScore">0</strong></p>
            <p>Comets Tapped: <strong id="tappedCount">0</strong></p>
            <p>Accuracy: <strong id="accuracy">0%</strong></p>
            <p>Average Response Time: <strong id="avgRt">0.0s</strong></p>
            <button id="newSessionBtn" class="btn primary" type="button">Start New Session</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
  (function(){
    // --- Helpers ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const now = ()=>performance.now();

    // --- DOM refs ---
    const startBtn = $('#startBtn');
    const pauseBtn = $('#pauseBtn');
    const restartBtn = $('#restartBtn');
    const scoreEl = $('#scoreEl');
    const bestEl = $('#bestEl');
    const diffEl = $('#diffEl');
    const stage = $('#stage');
    const overlay = $('#pauseOverlay');
    const resultsPanel = $('#results');
    const finalScore = $('#finalScore');
    const tappedCountEl = $('#tappedCount');
    const accuracyEl = $('#accuracy');
    const avgRtEl = $('#avgRt');
    const newSessionBtn = $('#newSessionBtn');

    // Ensure controls are never covered by the canvas
    // (extra safety in case site CSS changes)
    document.querySelectorAll('.card,.actions').forEach(el=>{
      el.style.pointerEvents = 'auto';
    });
    stage.style.pointerEvents = 'auto';

    // --- Settings ---
    const settings = {
      durationMin: 1,
      size: 'large',
      speed: 'slow',
      spawn: 'slow'
    };

    const sizeMap = { large: 26, medium: 18, small: 12 };
    const speedMap = { slow: 140, medium: 210, fast: 290 }; // px/s baseline
    const spawnMap = { slow: 2000, med: 1500, fast: 1000, vfast: 500 };

    // bind radios
    $$('input[name="duration"]').forEach(r => r.addEventListener('change', e=>{
      settings.durationMin = parseFloat(e.target.value);
      updateDiffLabel();
    }));
    $$('input[name="size"]').forEach(r => r.addEventListener('change', e=>{
      settings.size = e.target.value; updateDiffLabel();
    }));
    $$('input[name="speed"]').forEach(r => r.addEventListener('change', e=>{
      settings.speed = e.target.value; updateDiffLabel();
    }));
    $$('input[name="spawn"]').forEach(r => r.addEventListener('change', e=>{
      settings.spawn = e.target.value; updateDiffLabel();
    }));

    function updateDiffLabel(){
      // Simple heuristic summary
      const s = settings;
      let lvl = 0;
      lvl += (s.size==='small') ? 2 : (s.size==='medium'?1:0);
      lvl += (s.speed==='fast') ? 2 : (s.speed==='medium'?1:0);
      lvl += (s.spawn==='vfast') ? 2 : (s.spawn==='fast'?1:0);
      lvl += (s.durationMin>=2) ? 1 : 0;
      diffEl.textContent = lvl>=5 ? 'Hard' : lvl>=3 ? 'Medium' : 'Easy';
    }
    updateDiffLabel();

    // --- Score/Best ---
    function getBest(){ return parseInt(localStorage.getItem('comet:best')||'0',10); }
    function setBest(v){ localStorage.setItem('comet:best', String(v)); }
    bestEl.textContent = getBest();

    // --- Stage / Drawing ---
    const ctx = stage.getContext('2d');
    const DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    function fitCanvas(){
      const rect = stage.getBoundingClientRect();
      stage.width = Math.max(640, Math.floor(rect.width * DPR));
      stage.height = Math.max(360, Math.floor(rect.height * DPR));
      ctx.setTransform(DPR,0,0,DPR,0,0); // draw in CSS pixels
    }
    fitCanvas();
    window.addEventListener('resize', fitCanvas, { passive:true });

    // --- Game State ---
    let running = false;
    let paused = false;
    let score = 0;
    let tapped = 0;
    let missed = 0;
    let startTime = 0;
    let sessionEndTime = 0;
    let lastSpawn = 0;
    let comets = [];
    let rafId = 0;
    let spawnIntervalMs = spawnMap[settings.spawn];
    let responseTimes = []; // ms from spawn to tap

    function resetState(){
      running = false; paused = false;
      score = 0; tapped = 0; missed = 0;
      responseTimes.length = 0;
      comets = [];
      scoreEl.textContent = '0';
      overlay.classList.remove('show');
      resultsPanel.classList.remove('show');
      pauseBtn.disabled = true;
      restartBtn.disabled = true;
    }

    // --- Comets ---
    function makeComet(){
      const size = sizeMap[settings.size];
      const speed = speedMap[settings.speed] * (0.8 + Math.random()*0.4);
      const edge = Math.floor(Math.random()*4); // 0 top, 1 right, 2 bottom, 3 left
      const pad = size + 4;

      let x, y, vx, vy;
      if (edge===0){ x = rand(pad, stage.width/DPR - pad); y = -pad; vx = rand(-1,1); vy = 1; }
      if (edge===1){ x = stage.width/DPR + pad; y = rand(pad, stage.height/DPR - pad); vx = -1; vy = rand(-1,1); }
      if (edge===2){ x = rand(pad, stage.width/DPR - pad); y = stage.height/DPR + pad; vx = rand(-1,1); vy = -1; }
      if (edge===3){ x = -pad; y = rand(pad, stage.height/DPR - pad); vx = 1; vy = rand(-1,1); }

      // normalize direction
      const len = Math.hypot(vx,vy)||1;
      vx/=len; vy/=len;

      return {
        x, y, vx, vy, size,
        speed, // px/s
        bornAt: now()
      };
    }
    function rand(min,max){ return Math.random()*(max-min)+min; }

    function update(dt){
      // spawn
      spawnIntervalMs = spawnMap[settings.spawn];
      if (now() - lastSpawn >= spawnIntervalMs){
        comets.push(makeComet());
        lastSpawn = now();
      }

      // move & cull
      const W = stage.width / DPR, H = stage.height / DPR;
      const px = dt/1000;
      comets.forEach(c=>{
        c.x += c.vx * c.speed * px;
        c.y += c.vy * c.speed * px;
      });
      const prevLen = comets.length;
      comets = comets.filter(c => c.x>-80 && c.x<W+80 && c.y>-80 && c.y<H+80);
      missed += Math.max(0, prevLen - comets.length); // rough miss when it leaves

      // end?
      if (now() >= sessionEndTime){
        endSession();
      }
    }

    function draw(){
      const W = stage.width / DPR, H = stage.height / DPR;
      // background
      ctx.clearRect(0,0,W,H);

      // mild starfield
      for (let i=0;i<16;i++){
        const sx = (i*97 % W), sy = (i*71 % H);
        ctx.globalAlpha = 0.06;
        ctx.beginPath(); ctx.arc(sx,sy,1.5,0,Math.PI*2); ctx.fillStyle = '#000'; ctx.fill();
      }
      ctx.globalAlpha = 1;

      // comets
      comets.forEach(c=>{
        // tail
        ctx.save();
        ctx.translate(c.x,c.y);
        const angle = Math.atan2(c.vy, c.vx);
        ctx.rotate(angle);
        const grd = ctx.createLinearGradient(-c.size*3,0,c.size,0);
        grd.addColorStop(0,'rgba(37,99,235,0)');
        grd.addColorStop(1,'rgba(37,99,235,0.6)');
        ctx.fillStyle = grd;
        ctx.beginPath();
        ctx.ellipse(-c.size*1.8,0,c.size*2.3,c.size*0.6,0,0,Math.PI*2);
        ctx.fill();
        ctx.restore();

        // head
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.size, 0, Math.PI*2);
        ctx.fillStyle = '#2563eb';
        ctx.fill();

        // glow
        ctx.globalAlpha = 0.25;
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.size*1.8, 0, Math.PI*2);
        ctx.fillStyle = '#48cae4';
        ctx.fill();
        ctx.globalAlpha = 1;
      });
    }

    // --- Input (tap to hit comet) ---
    function stagePos(evt){
      const rect = stage.getBoundingClientRect();
      const x = (evt.touches?evt.touches[0].clientX:evt.clientX) - rect.left;
      const y = (evt.touches?evt.touches[0].clientY:evt.clientY) - rect.top;
      return { x, y };
    }
    function handleTap(evt){
      if (!running || paused) return;
      const {x,y} = stagePos(evt);
      // find nearest comet within radius
      let hitIndex = -1;
      for (let i=0;i<comets.length;i++){
        const c = comets[i];
        const d = Math.hypot(c.x - x, c.y - y);
        if (d <= c.size * 1.1){ hitIndex = i; break; }
      }
      if (hitIndex>-1){
        const [c] = comets.splice(hitIndex,1);
        tapped++;
        const rt = now() - c.bornAt;
        responseTimes.push(rt);
        const sizeBonus = settings.size==='small' ? 6 : settings.size==='medium' ? 3 : 1;
        const speedBonus = settings.speed==='fast' ? 6 : settings.speed==='medium' ? 3 : 1;
        score += 10 + sizeBonus + speedBonus;
        scoreEl.textContent = String(score);
      }
    }
    stage.addEventListener('click', handleTap);
    stage.addEventListener('touchstart', handleTap, { passive:true });

    // --- Loop ---
    let lastTs = 0;
    function tick(ts){
      if (!running){ return; }
      rafId = requestAnimationFrame(tick);
      const dt = ts - lastTs; lastTs = ts;
      if (paused) return;
      update(dt);
      draw();
    }

    // --- Session lifecycle ---
    function startSession(){
      resetState();
      running = true;
      paused = false;
      startTime = now();
      sessionEndTime = startTime + settings.durationMin * 60_000;
      lastSpawn = 0;
      spawnIntervalMs = spawnMap[settings.spawn];
      pauseBtn.disabled = false;
      restartBtn.disabled = false;
      tick(performance.now());
    }

    function pauseSession(p){
      if (!running) return;
      paused = !!p;
      overlay.classList.toggle('show', paused);
      pauseBtn.textContent = paused ? 'Resume' : 'Pause';
    }

    function endSession(){
      running = false;
      cancelAnimationFrame(rafId);
      const best = getBest();
      if (score > best){ setBest(score); bestEl.textContent = String(score); }

      // results
      finalScore.textContent = String(score);
      tappedCountEl.textContent = String(tapped);
      const total = tapped + missed;
      const acc = total>0 ? Math.round((tapped/total)*100) : 0;
      accuracyEl.textContent = acc + '%';
      const avg = responseTimes.length ? (responseTimes.reduce((a,b)=>a+b,0)/responseTimes.length) : 0;
      avgRtEl.textContent = (avg/1000).toFixed(2) + 's';
      resultsPanel.classList.add('show');
    }

    // --- Buttons ---
    startBtn.addEventListener('click', ()=> startSession());
    pauseBtn.addEventListener('click', ()=> pauseSession(!paused));
    restartBtn.addEventListener('click', ()=> startSession());
    newSessionBtn.addEventListener('click', ()=> {
      resultsPanel.classList.remove('show');
      startSession();
    });

    // Defensive: ensure buttons are not inside a <form> submit context
    [startBtn, pauseBtn, restartBtn, newSessionBtn].forEach(b => b.setAttribute('type','button'));
  })();
  </script>
</body>
</html>
