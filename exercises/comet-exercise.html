<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Comet Tap — Fine Point Rehab</title>

<link rel="stylesheet" href="/css/tokens.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/components.css">

<style>
  :root{
    --vh: 1vh;
    --bg-1:#070b16; --bg-2:#0f1630; --bg-3:#0b1024;
    --accent: var(--brand-aqua, #6fd3f5);
    --radius: 14px;
    --panel: rgba(10,16,36,.9);
    --panel-border: rgba(255,255,255,.08);
    --text: #eaf6ff;
  }
  /* Cosmic background with nebula */
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 800px at 20% 25%, rgba(70,30,120,.35), transparent 60%),
      radial-gradient(900px 700px at 75% 65%, rgba(20,120,160,.28), transparent 55%),
      linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 50%, var(--bg-3) 100%);
    min-height: calc(var(--vh) * 100);
    touch-action: manipulation;
  }
  /* Immersive mode: hide scroll + header, fill screen */
  body.playing { overflow: hidden; }
  body.playing header.app { display: none; }

  header.app{
    position: sticky; top:0; z-index: 50;
    padding:12px 16px; display:flex; gap:12px; align-items:center;
    background: linear-gradient(180deg, rgba(8,12,26,.9), rgba(8,12,26,.55));
    border-bottom: 1px solid rgba(255,255,255,.06);
    backdrop-filter: blur(6px);
  }
  header .home {
    text-decoration:none; color:var(--text); font-weight:700;
    border:1px solid rgba(255,255,255,.18); border-radius:999px; padding:8px 12px;
  }
  header h1{ margin:0; font-size: clamp(18px,3vw,24px); }

  /* Two-panel layout before start */
  .layout{
    display:grid; grid-template-columns: 360px 1fr; gap:16px;
    padding:16px; height: calc((var(--vh) * 100) - 56px);
  }
  @media (max-width: 900px){
    .layout{ grid-template-columns: 1fr; height:auto; }
  }
  .panel{
    background: var(--panel);
    border: 1px solid var(--panel-border);
    border-radius: var(--radius);
    box-shadow: 0 10px 30px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.05);
  }
  /* Left — Settings (shown pre-start, hidden during play) */
  #settings { padding:18px; overflow:auto; position:relative; z-index: 5; }
  #settings h2{ margin:0 0 10px; font-size:20px; text-align:center; }
  .desc{
    margin-bottom:12px;
    background: rgba(111,211,245,.08);
    border-left: 4px solid rgba(111,211,245,.7);
    padding:10px; border-radius:8px; font-size:14px; line-height:1.5;
  }
  .group{ margin-bottom:12px; }
  .label{ display:block; margin-bottom:6px; font-weight:700; letter-spacing:.2px; }
  select, input[type="number"]{
    width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,.2);
    background: rgba(5,10,26,.8); color:var(--text); font-size:16px;
  }
  select:focus, input[type="number"]:focus{
    outline:none; border-color: rgba(111,211,245,.9); box-shadow: 0 0 0 2px rgba(111,211,245,.25);
  }
  .btn-row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px; }
  .btn{
    min-height:46px; border:1px solid rgba(111,211,245,.35); background: rgba(111,211,245,.12);
    color:var(--text); border-radius:10px; font-weight:800; letter-spacing:.2px; cursor:pointer; transition:.2s;
  }
  .btn:hover:not(:disabled){ background: rgba(111,211,245,.22); transform: translateY(-1px); }
  .btn:disabled{ opacity:.55; cursor:not-allowed; }
  .btn-primary{ background: rgba(111,211,245,.95); color:#07101e; border-color: rgba(111,211,245,1); }
  .btn-primary:hover:not(:disabled){ background: rgba(111,211,245,1); box-shadow: 0 6px 18px rgba(111,211,245,.45); }

  /* Right — HUD + Canvas wrapper */
  .right{ position:relative; }
  .frame{
    position:relative; border-radius: var(--radius); overflow:hidden;
    border:1px solid var(--panel-border); box-shadow: inset 0 0 40px rgba(0,0,0,.35);
    background: radial-gradient(60% 45% at 50% 40%, rgba(80,160,200,.12), transparent 68%);
  }
  canvas#stage{ display:block; width:100%; height:62vh; max-height:760px; background: transparent; }
  @media (max-width:900px){ canvas#stage{ height:58vh; } }

  /* HUD (overlay during play) */
  .hud{
    display:grid; grid-template-columns: 1fr auto auto auto auto; align-items:center;
    gap:12px; padding:10px 12px; margin-bottom:12px;
    background: rgba(8,14,36,.85);
    border: 1px solid var(--panel-border);
    border-radius: var(--radius); box-shadow: 0 6px 16px rgba(0,0,0,.35);
    position:relative; z-index:4; pointer-events:auto;
  }
  .timer{ position:relative; height:10px; background: rgba(255,255,255,.12); border-radius:999px; overflow:hidden; }
  #timerBar{ position:absolute; inset:0 auto 0 0; width:100%;
    background: linear-gradient(90deg, rgba(111,211,245,.95), rgba(150,180,255,.95), rgba(200,150,255,.95));
    box-shadow: 0 2px 10px rgba(111,211,245,.5);
    transition: width .25s ease;
  }
  .hudItem{ text-align:right; min-width:120px; }
  .v{ font-weight:900; font-size:20px; color:#bfe6ff; text-shadow: 0 0 8px rgba(150,220,255,.5); }
  #score{ font-size:22px; color:#d7f2ff; text-shadow: 0 0 10px rgba(160,220,255,.7); }
  .t{ font-size:12px; opacity:.8; }
  .hud .btn-ghost{
    min-height:36px; padding:6px 10px; font-weight:800;
    border:1px solid rgba(255,255,255,.22); border-radius:999px; background: rgba(255,255,255,.06);
    color:var(--text); cursor:pointer;
  }
  .hud .btn-ghost:hover{ background: rgba(255,255,255,.12); }

  /* Immersive playing layout: settings/header hidden, full-screen canvas, HUD floating */
  body.playing .layout{ grid-template-columns: 1fr; padding:0; height: calc(var(--vh) * 100); }
  body.playing #settings{ display:none; }
  body.playing .right{ height: calc(var(--vh) * 100); }
  body.playing .frame{
    border:none; border-radius:0; height: calc(var(--vh) * 100);
    box-shadow: none; background: transparent;
  }
  body.playing canvas#stage{ width:100vw; height: calc(var(--vh) * 100); max-height:none; }
  body.playing .hud{
    position:absolute; top:10px; left:10px; right:10px; margin:0;
    background: linear-gradient(180deg, rgba(6,10,24,.65), rgba(6,10,24,.35));
    border: 1px solid rgba(255,255,255,.12);
  }

  /* Completion modal */
  #done{ position:absolute; inset:0; display:grid; place-items:center; background: rgba(0,0,0,.65);
         backdrop-filter: blur(4px); z-index:10; }
  #doneCard{ max-width:min(520px, 92vw); max-height:80vh; overflow:auto; padding:22px; }
  #done h2{ margin-top:0; color:var(--accent); }
  .hi{ color:#9ee7ff; font-weight:900; }
  .hidden{ display:none !important; }

  :focus-visible{ outline: 3px solid rgba(111,211,245,.85); outline-offset:2px; }
</style>
</head>
<body>
  <!-- Header (hidden in immersive playing mode) -->
  <header class="app" role="banner" aria-label="Exercise header">
    <a class="home" href="/" aria-label="Back to Home">← Home</a>
    <h1>Comet Tap</h1>
  </header>

  <main class="layout">
    <!-- SETTINGS (pre-start only) -->
    <aside id="settings" class="panel" aria-label="Settings">
      <h2>Settings</h2>
      <div class="desc"><strong>How to play:</strong> tap a glowing comet before it escapes. Smaller &amp; faster = harder (more points).</div>

      <div class="group">
        <label class="label" for="dur">Session Duration (minutes)</label>
        <input id="dur" type="number" min="0.5" step="0.5" max="10" value="2" inputmode="decimal" />
      </div>
      <div class="group">
        <label class="label" for="size">Comet Size</label>
        <select id="size">
          <option value="large">Large (Easier)</option>
          <option value="medium" selected>Medium (Balanced)</option>
          <option value="small">Small (Challenging)</option>
        </select>
      </div>
      <div class="group">
        <label class="label" for="spd">Comet Speed</label>
        <select id="spd">
          <option value="slow">Slow (Beginner)</option>
          <option value="medium" selected>Medium (Intermediate)</option>
          <option value="fast">Fast (Advanced)</option>
        </select>
      </div>
      <div class="group">
        <label class="label" for="spawn">Spawn Rate</label>
        <select id="spawn">
          <option value="slow">Slow (2s)</option>
          <option value="medium">Medium (1.5s)</option>
          <option value="fast" selected>Fast (1s)</option>
          <option value="vfast">Very Fast (0.5s)</option>
        </select>
      </div>

      <div class="btn-row">
        <button id="start" class="btn btn-primary" type="button">Start</button>
        <button id="pause" class="btn" type="button" disabled>Pause</button>
      </div>
      <button id="restart" class="btn" type="button" disabled>Restart</button>
    </aside>

    <!-- GAME -->
    <section class="right" aria-label="Game area">
      <!-- HUD (floats during play) -->
      <div class="hud" role="region" aria-label="Session HUD">
        <div class="timer" aria-hidden="true"><div id="timerBar"></div></div>
        <div class="hudItem" aria-live="polite"><div id="score" class="v">0</div><div class="t">Score</div></div>
        <div class="hudItem" aria-live="polite"><div id="pb" class="v">0</div><div class="t">Personal Best</div></div>
        <div class="hudItem" aria-live="polite"><div id="diff" class="v">Medium</div><div class="t">Difficulty</div></div>
        <button id="endBtn" class="btn-ghost" type="button" aria-label="End session and return">End</button>
      </div>

      <div class="frame panel">
        <canvas id="stage" width="1280" height="720" aria-label="Game stage"></canvas>
      </div>

      <!-- Completion -->
      <div id="done" class="hidden" role="dialog" aria-modal="true" aria-labelledby="doneT">
        <div id="doneCard" class="panel">
          <h2 id="doneT">Session Complete!</h2>
          <p>Final Score: <span id="fScore" class="hi">0</span></p>
          <p>Comets Tapped: <span id="fTaps" class="hi">0</span></p>
          <p>Accuracy: <span id="fAcc" class="hi">0%</span></p>
          <p>Average Response Time: <span id="fAvg" class="hi">0.00s</span></p>
          <div class="btn-row" style="grid-template-columns:1fr;">
            <button id="doneBtn" class="btn btn-primary" type="button">Start New Session</button>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
(function(){
  // ===== Helpers & DOM =====
  const $ = (s, r=document)=>r.querySelector(s);
  const rnd = (a,b)=>Math.random()*(b-a)+a;
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const now = ()=>performance.now();

  const startBtn = $('#start'), pauseBtn = $('#pause'), restartBtn = $('#restart'), doneBtn = $('#doneBtn'), endBtn = $('#endBtn');
  [startBtn, pauseBtn, restartBtn, doneBtn, endBtn].forEach(b=>b.setAttribute('type','button'));
  const durIn = $('#dur'), sizeSel = $('#size'), spdSel = $('#spd'), spawnSel = $('#spawn');
  const scoreEl = $('#score'), pbEl = $('#pb'), diffEl = $('#diff'), timerBar = $('#timerBar');
  const doneModal = $('#done'), fScore = $('#fScore'), fTaps = $('#fTaps'), fAcc = $('#fAcc'), fAvg = $('#fAvg');
  const canvas = $('#stage'); const ctx = canvas.getContext('2d');

  // ===== HiDPI Canvas =====
  let DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  function fit(){
    const r = canvas.getBoundingClientRect();
    const w = Math.max(640, Math.floor(r.width * DPR));
    const h = Math.max(360, Math.floor(r.height * DPR));
    canvas.width = w; canvas.height = h;
    ctx.setTransform(DPR,0,0,DPR,0,0); // draw in CSS px
  }
  function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
  setVH(); fit();
  window.addEventListener('resize', ()=>{ setVH(); fit(); }, {passive:true});
  window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ setVH(); fit(); }, 200); });

  // ===== Starfield (parallax) =====
  const layers = [
    { count: 80, speed: .02, stars: [], alpha:.45 },
    { count: 50, speed: .06, stars: [], alpha:.75 },
    { count: 25, speed: .12, stars: [], alpha:1.0 }
  ];
  function initStars(){
    layers.forEach((L,i)=>{
      L.stars = Array.from({length:L.count}, () => ({
        x: Math.random()*canvas.width/DPR,
        y: Math.random()*canvas.height/DPR,
        r: Math.random()*(i+1)*.8 + .5,
        tw: Math.random()*2*Math.PI
      }));
    });
  }
  initStars();

  function drawStars(dt){
    layers.forEach(L=>{
      ctx.save();
      ctx.globalAlpha = L.alpha;
      L.stars.forEach(s=>{
        s.x -= L.speed * dt * 0.06;
        if (s.x < -4) s.x = canvas.width/DPR + 4, s.y = Math.random()*canvas.height/DPR;
        s.tw += dt*0.002;
        const o = 0.6 + Math.sin(s.tw)*0.4;
        ctx.fillStyle = `rgba(255,255,255,${o})`;
        ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
      });
      ctx.restore();
    });
  }

  // ===== Game State =====
  const sizeMap = { small: 10, medium: 16, large: 22 };         // comet head radius (CSS px)
  const speedMap = { slow: 140, medium: 220, fast: 320 };        // px/s baseline
  const spawnMap = { slow: 2000, medium: 1500, fast: 1000, vfast: 500 };

  let running=false, paused=false;
  let durationMs=120000, timeLeft=0, lastTick=0, lastSpawn=0;
  let score=0, taps=0, misses=0, totalRT=0;
  let comets=[], particles=[], popups=[];
  let shakeT=0, hueBase=rnd(160,220);

  const PB_KEY='comet:best';
  const getPB=()=>parseInt(localStorage.getItem(PB_KEY)||'0',10);
  const setPB=(v)=>localStorage.setItem(PB_KEY,String(v));
  pbEl.textContent = getPB();

  // Difficulty label
  function updateDiff(){
    const s=sizeSel.value, v=spdSel.value, sp=spawnSel.value;
    let lvl = 0;
    if (s==='small') lvl+=2; else if (s==='medium') lvl+=1;
    if (v==='fast') lvl+=2; else if (v==='medium') lvl+=1;
    if (sp==='vfast') lvl+=2; else if (sp==='fast') lvl+=1;
    diffEl.textContent = lvl>=5 ? 'Hard' : (lvl>=3 ? 'Medium' : 'Easy');
  }
  [sizeSel, spdSel, spawnSel].forEach(el=>el.addEventListener('change', updateDiff));
  updateDiff();

  // ===== Comet Model =====
  function spawnComet(){
    const r = sizeMap[sizeSel.value];
    const spd = speedMap[spdSel.value]*(.85 + Math.random()*.4);
    const edge = Math.floor(Math.random()*4);
    const pad = r + 8;
    let x,y,vx,vy;

    if (edge===0){ x = rnd(pad, canvas.width/DPR-pad); y = -pad; vx=rnd(-1,1); vy=1; }
    else if (edge===1){ x = canvas.width/DPR+pad; y = rnd(pad, canvas.height/DPR-pad); vx=-1; vy=rnd(-1,1); }
    else if (edge===2){ x = rnd(pad, canvas.width/DPR-pad); y = canvas.height/DPR+pad; vx=rnd(-1,1); vy=-1; }
    else { x = -pad; y = rnd(pad, canvas.height/DPR-pad); vx=1; vy=rnd(-1,1); }

    const len = Math.hypot(vx,vy)||1; vx/=len; vy/=len;
    const hue = (hueBase + Math.random()*60) % 360;

    comets.push({ x, y, vx, vy, r, spd, hue, born: now(), trail: [] });
  }

  function updateComets(dt){
    const W=canvas.width/DPR, H=canvas.height/DPR;
    comets.forEach(c=>{
      const px = dt/1000;
      c.x += c.vx*c.spd*px;
      c.y += c.vy*c.spd*px;
      // trail
      c.trail.push({ x:c.x - c.vx*6, y:c.y - c.vy*6, life: 1, hue:c.hue });
      if (c.trail.length>24) c.trail.shift();
      c.trail.forEach(t=>t.life -= 0.035*px*60);
    });
    // cull offscreen
    const before = comets.length;
    comets = comets.filter(c => c.x>-60 && c.x<W+60 && c.y>-60 && c.y<H+60);
    misses += Math.max(0, before - comets.length);
  }

  // ===== Particles & Popups =====
  function burst(x,y,hue){
    for (let i=0;i<24;i++){
      particles.push({
        x, y,
        vx: rnd(-2.4,2.4), vy: rnd(-2.4,2.4),
        life: 1,
        r: rnd(1,2.6),
        hue: hue + rnd(-10,10)
      });
    }
    popups.push({ x, y, life:1, text:'+!' });
    shakeT = 120;
  }
  function updateParticles(dt){
    const px = dt/1000;
    particles.forEach(p=>{
      p.x += p.vx*60*px; p.y += p.vy*60*px;
      p.vy += 0.2; // gravity
      p.life -= 1.6*px;
    });
    particles = particles.filter(p=>p.life>0);
    popups.forEach(s=>{
      s.y -= 24*px; s.life -= 1*px;
    });
    popups = popups.filter(s=>s.life>0);
  }

  // ===== Rendering =====
  function clearBG(){
    ctx.clearRect(0,0,canvas.width/DPR,canvas.height/DPR);
  }

  function drawComet(c){
    // tail (multi-layer, additive)
    ctx.save();
    ctx.globalCompositeOperation = 'lighter';
    c.trail.forEach((t,i)=>{
      const alpha = clamp(t.life,0,1) * (i/24);
      const grad = ctx.createLinearGradient(c.x, c.y, t.x, t.y);
      grad.addColorStop(0, `hsla(${c.hue},95%,65%,${alpha*0.85})`);
      grad.addColorStop(1, `hsla(${c.hue+40},95%,55%,0)`);
      ctx.strokeStyle = grad; ctx.lineWidth = Math.max(1, c.r*0.9*(i/24));
      ctx.beginPath(); ctx.moveTo(c.x, c.y); ctx.lineTo(t.x, t.y); ctx.stroke();
    });

    // glow
    const g1 = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, c.r*2.2);
    g1.addColorStop(0, `hsla(${c.hue},95%,80%,.85)`);
    g1.addColorStop(1, `hsla(${c.hue},95%,50%,0)`);
    ctx.fillStyle = g1; ctx.beginPath(); ctx.arc(c.x, c.y, c.r*2.2, 0, Math.PI*2); ctx.fill();

    // core
    const g2 = ctx.createRadialGradient(c.x- c.r*0.4, c.y- c.r*0.4, 0, c.x, c.y, c.r);
    g2.addColorStop(0, '#fff');
    g2.addColorStop(0.35, `hsla(${c.hue},95%,75%,1)`);
    g2.addColorStop(0.9, `hsla(${c.hue},95%,45%,.85)`);
    g2.addColorStop(1, 'rgba(0,0,0,.0)');
    ctx.fillStyle = g2; ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function drawParticles(){
    ctx.save(); ctx.globalCompositeOperation='lighter';
    particles.forEach(p=>{
      ctx.fillStyle = `hsla(${p.hue},95%,70%,${p.life})`;
      ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
    });
    ctx.restore();

    // popups
    popups.forEach(s=>{
      ctx.save();
      ctx.globalAlpha = s.life;
      ctx.font = '900 22px system-ui, Segoe UI, Roboto';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.shadowBlur = 16; ctx.shadowColor = 'rgba(160,255,200,.85)';
      ctx.fillStyle = '#a8ffd5';
      ctx.fillText(s.text, s.x, s.y);
      ctx.restore();
    });
  }

  // ===== Input =====
  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches?e.touches[0].clientX:e.clientX) - rect.left;
    const y = (e.touches?e.touches[0].clientY:e.clientY) - rect.top;
    return { x, y };
  }
  function onTap(e){
    if (!running || paused) return;
    const {x,y} = getPos(e);
    let hit=-1;
    for (let i=0;i<comets.length;i++){
      const c = comets[i];
      if (Math.hypot(c.x-x, c.y-y) <= c.r*1.15){ hit=i; break; }
    }
    if (hit>-1){
      e.preventDefault();
      const c = comets.splice(hit,1)[0];
      taps++;
      const rt = now() - c.born; totalRT += rt;
      const sizeB = sizeSel.value==='small'?1.6 : sizeSel.value==='medium'?1.2 : 1.0;
      const speedB = spdSel.value==='fast'?1.6 : spdSel.value==='medium'?1.2 : 1.0;
      const pts = Math.floor(10 * sizeB * speedB * clamp(3000/rt, 0.8, 6));
      score += pts; scoreEl.textContent = String(score);
      popups.push({ x:c.x, y:c.y, life:1, text: '+'+pts });
      burst(c.x,c.y,c.hue);
    }
  }
  canvas.addEventListener('click', onTap);
  canvas.addEventListener('touchstart', onTap, {passive:false});

  // ===== Session lifecycle =====
  function setTimerBar(){
    const p = durationMs ? Math.max(0, timeLeft/durationMs) : 0;
    timerBar.style.width = (p*100)+'%';
  }

  async function enterFullscreen(){
    const el = document.documentElement;
    try{
      if (el.requestFullscreen) await el.requestFullscreen({ navigationUI: 'hide' });
      else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
    }catch{}
  }
  async function exitFullscreen(){
    try{
      if (document.fullscreenElement) await document.exitFullscreen();
      else if (document.webkitFullscreenElement) await document.webkitExitFullscreen();
    }catch{}
  }

  function toImmersive(){
    document.body.classList.add('playing');
    window.scrollTo({ top: 0, behavior: 'instant' });
    fit();
    enterFullscreen(); // best effort; safe to ignore if blocked
  }
  function fromImmersive(){
    document.body.classList.remove('playing');
    exitFullscreen();
    fit();
  }

  function startSession(){
    durationMs = parseFloat(durIn.value||'2')*60*1000;
    timeLeft = durationMs; setTimerBar();
    toImmersive();

    running=true; paused=false; score=0; taps=0; misses=0; totalRT=0;
    scoreEl.textContent='0'; lastTick = now(); lastSpawn = 0; hueBase = rnd(160,220);

    pauseBtn.disabled=false; restartBtn.disabled=false; pauseBtn.textContent='Pause';
    loopId = requestAnimationFrame(loop);
  }
  function pauseSession(){
    if (!running||paused) return;
    paused=true; pauseBtn.textContent='Resume';
  }
  function resumeSession(){
    if (!running||!paused) return;
    paused=false; pauseBtn.textContent='Pause'; lastTick = now(); loopId = requestAnimationFrame(loop);
  }
  function restartSession(){
    running=false; paused=false;
    pauseBtn.textContent='Pause'; pauseBtn.disabled=true; restartBtn.disabled=true;
    doneModal.classList.add('hidden');
    comets.length=0; particles.length=0; popups.length=0; timeLeft=0; setTimerBar(); scoreEl.textContent='0';
    fromImmersive();
  }
  function endSession(){
    running=false; paused=false;
    const acc = taps+misses>0 ? Math.round((taps/(taps+misses))*100) : 0;
    const avg = taps>0 ? (totalRT/taps/1000).toFixed(2) : '0.00';
    if (score>getPB()){ setPB(score); pbEl.textContent=score; }
    fScore.textContent=score; fTaps.textContent=taps; fAcc.textContent=acc+'%'; fAvg.textContent=avg;
    doneModal.classList.remove('hidden');
    pauseBtn.disabled=true;
  }

  // ===== Main Loop =====
  let loopId = 0;
  function loop(ts){
    if (!running) return;
    loopId = requestAnimationFrame(loop);
    const dt = ts - lastTick; lastTick = ts;
    if (paused) return;

    timeLeft -= dt; if (timeLeft<=0){ setTimerBar(); endSession(); return; }
    setTimerBar();

    // spawn
    const sInt = { vfast:500, fast:1000, medium:1500, slow:2000 }[spawnSel.value];
    if (ts - lastSpawn >= sInt){ spawnComet(); lastSpawn = ts; }

    // update
    updateComets(dt);
    updateParticles(dt);

    // render
    clearBG();

    // camera shake
    let ox=0, oy=0;
    if (shakeT>0){
      shakeT -= dt;
      const p = clamp(shakeT/120, 0, 1);
      ox = Math.sin(ts*0.9)*2*p; oy = Math.cos(ts*1.1)*2*p;
      ctx.save(); ctx.translate(ox, oy);
    }

    drawStars(dt);
    ctx.save(); comets.forEach(drawComet); ctx.restore();
    drawParticles();

    if (shakeT>0){ ctx.restore(); }
  }

  // ===== Wire controls =====
  startBtn.addEventListener('click', ()=>{ if (!running) startSession(); });
  pauseBtn.addEventListener('click', ()=>{ if (!running) return; paused?resumeSession():pauseSession(); });
  restartBtn.addEventListener('click', restartSession);
  doneBtn.addEventListener('click', ()=>{ doneModal.classList.add('hidden'); restartSession(); setTimeout(startSession, 120); });
  endBtn.addEventListener('click', ()=>{ if (running){ endSession(); } restartSession(); });

  // ===== Viewport unit fix for mobile =====
  // (already handled in setVH/resize)

})();
</script>
</body>
</html>
