<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Comet Tap Exercise | Dynamic Tracking Therapy | Fine Point Rehab</title>

  <!-- Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKCCWBFKE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-RVKCCWBFKE', { 'anonymize_ip': true });
  </script>

  <!-- Shared styles -->
  <link rel="stylesheet" href="/css/tokens.css" />
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/components.css" />

  <style>
    :root {
      --vh: 1vh;
      --bg-1: #0a0e1a;
      --bg-2: #1a1f3a;
      --bg-3: #0f1524;
      --accent: var(--color-accent, #6fd3f5);
      --panel-bg: rgba(8, 15, 35, 0.95);
      --panel-border: rgba(255, 255, 255, 0.1);
      --text: var(--color-text, #fff);
    }

    /* Page background + starfield canvas host */
    body {
      margin: 0;
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(ellipse at 20% 30%, rgba(40,20,80,0.35) 0%, transparent 40%),
        radial-gradient(ellipse at 80% 70%, rgba(20,40,80,0.28) 0%, transparent 40%),
        radial-gradient(ellipse at 50% 50%, rgba(10,20,40,0.5) 0%, transparent 70%),
        linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 50%, var(--bg-3) 100%);
      min-height: 100vh;
      min-height: calc(var(--vh, 1vh) * 100);
      overflow: hidden;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      padding-bottom: max(0px, env(safe-area-inset-bottom));
    }

    /* Sticky header */
    header.app-header {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      gap: var(--space-3, 12px);
      padding: var(--space-3, 12px) var(--space-4, 16px);
      background: linear-gradient(180deg, rgba(10,14,26,0.85), rgba(10,14,26,0.55));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    header .home-link {
      text-decoration: none;
      font-weight: 600;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 999px;
      padding: 8px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.15s ease, background-color 0.15s ease, border-color 0.15s ease;
    }
    header .home-link:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.25); }
    header h1 {
      margin: 0;
      font-size: clamp(18px, 2.5vw, 22px);
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    /* Shared 2-panel layout */
    .layout {
      position: relative;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: var(--space-4, 16px);
      height: calc(100vh - 56px);
      height: calc((var(--vh, 1vh) * 100) - 56px);
      padding: var(--space-4, 16px);
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        grid-auto-rows: max-content 1fr;
        height: auto;
        min-height: calc(var(--vh, 1vh) * 100 - 56px);
      }
    }

    /* Panel base (leveraging .panel class from components.css) */
    .panel {
      background-color: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius-lg, 14px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.06);
    }

    /* Left: Settings */
    #settings-panel {
      overflow: auto;
      padding: var(--space-5, 20px);
      max-height: 100%;
    }
    #settings-panel h2 {
      margin: 0 0 var(--space-3, 12px);
      font-size: 20px;
      text-align: center;
    }
    .game-description {
      background-color: rgba(111, 211, 245, 0.1);
      border-left: 4px solid rgba(111, 211, 245, 0.8);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      color: rgba(255,255,255,0.92);
      line-height: 1.5;
      font-size: 14px;
    }
    .game-description h3 { margin: 0 0 6px; color: var(--accent); font-size: 16px; }
    .settings-group { margin-bottom: 14px; }
    .settings-label { display:block; margin-bottom:6px; font-weight:600; }

    select, input[type="number"] {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,10,30,0.8);
      color: var(--text);
      font-size: 16px;
      box-sizing: border-box;
    }
    select:focus, input[type="number"]:focus {
      outline: none;
      border-color: rgba(111,211,245,0.9);
      box-shadow: 0 0 0 2px rgba(111,211,245,0.3);
    }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .btn { min-height: 48px; }

    /* Right: HUD + Game area */
    .game-column {
      position: relative;
      overflow: hidden;
    }

    /* HUD Row */
    .hud {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: rgba(8, 15, 35, 0.8);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius-lg, 14px);
      margin-bottom: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
    }
    .timer-wrap {
      position: relative;
      height: 10px;
      background: rgba(255,255,255,0.12);
      border-radius: 999px;
      overflow: hidden;
    }
    #timer-bar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 100%;
      background: linear-gradient(90deg, rgba(111,211,245,0.95), rgba(150,180,255,0.95), rgba(200,150,255,0.95));
      box-shadow: 0 2px 10px rgba(111,211,245,0.5);
    }
    .hud-item {
      text-align: right;
      min-width: 120px;
    }
    .stat-value { font-weight: 800; font-size: 18px; color: rgba(111,211,245,1); }
    .stat-label { font-size: 12px; opacity: 0.8; }

    /* Game area */
    #game-area {
      position: absolute;
      inset: 0;
      border-radius: var(--radius-lg, 14px);
      overflow: hidden;
      outline: none;
    }
    #stars-container {
      position: absolute; inset: 0; pointer-events: none; z-index: 1; overflow: hidden;
    }

    /* Comet styles (kept, polished) */
    .comet {
      position: absolute;
      width: 60px; height: 60px;
      cursor: pointer;
      z-index: 5;
      overflow: visible;
      display: flex; align-items: center; justify-content: center;
      outline: none;
      border-radius: 50%;
    }
    .comet:focus { box-shadow: 0 0 0 3px rgba(111,211,245,0.8); }
    .comet-core {
      position: relative; width: 100%; height: 100%; border-radius: 50%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,1) 0%, rgba(150,220,255,0.9) 15%, rgba(100,180,255,0.8) 30%, rgba(50,120,200,0.7) 50%, rgba(20,60,150,0.5) 70%, transparent 100%),
        radial-gradient(circle at 70% 70%, rgba(255,200,150,0.4) 0%, transparent 50%);
      box-shadow:
        0 0 30px rgba(150,220,255,1),
        0 0 60px rgba(100,180,255,0.8),
        0 0 90px rgba(50,120,200,0.6),
        inset 0 0 20px rgba(255,255,255,0.8),
        inset -5px -5px 15px rgba(100,180,255,0.5);
      animation: cometPulse 2s ease-in-out infinite, cometRotate 4s linear infinite;
    }
    @media (prefers-reduced-motion: reduce) { .comet-core { animation: none; } .star { animation: none; } .shooting-star { display: none; } }
    @keyframes cometRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes cometPulse { 0%,100% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.15); filter: brightness(1.3); } }

    .comet-tail { position: absolute; pointer-events: none; width: 200px; height: 40px; top: 50%; right: 100%; transform: translateY(-50%); z-index: 4; }
    .comet-tail-stream {
      position: absolute; width: 100%; height: 8px; top: 50%; transform: translateY(-50%);
      background: linear-gradient(to right, transparent 0%, rgba(111,211,245,0.1) 20%, rgba(150,180,255,0.3) 40%, rgba(180,150,255,0.5) 60%, rgba(200,120,255,0.7) 80%, rgba(220,100,255,0.9) 100%);
      filter: blur(2px); border-radius: 4px;
    }
    .comet-tail-stream:nth-child(2) { top: 45%; opacity: 0.7; filter: blur(4px); height: 12px; }
    .comet-tail-stream:nth-child(3) { top: 55%; opacity: 0.5; filter: blur(6px); height: 16px; }

    .star { position: absolute; background-color: white; border-radius: 50%; animation: starTwinkle 3s ease-in-out infinite; }
    @keyframes starTwinkle { 0%,100% { opacity: var(--opacity); transform: scale(1); } 50% { opacity: calc(var(--opacity) * 1.5); transform: scale(1.2); } }

    .shooting-star { position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%; animation: shootingStar 3s linear; pointer-events: none; }
    .shooting-star::after { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 2px; background: linear-gradient(to left, transparent, white); opacity: 0.5; }
    @keyframes shootingStar { from { transform: translate(0,0); opacity: 1; } to { transform: translate(-500px, 300px); opacity: 0; } }

    .impact-ring {
      position: absolute;
      border: 2px solid rgba(150, 220, 255, 0.8);
      border-radius: 50%;
      width: 20px; height: 20px;
      transform: translate(-50%, -50%);
      animation: ringExpand 0.8s ease-out forwards;
      pointer-events: none; z-index: 8;
    }
    @keyframes ringExpand { 0% { width:20px; height:20px; opacity:1; border-width:3px; } 100% { width:150px; height:150px; opacity:0; border-width:1px; } }

    .score-popup {
      position: absolute; font-size: 24px; font-weight: 800; color: #6cffbd;
      text-shadow: 0 0 10px rgba(108,255,189,0.8);
      transform: translate(-50%, -50%);
      animation: scoreFloat 1s ease-out forwards;
      pointer-events: none; z-index: 9;
    }
    @keyframes scoreFloat { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -120%) scale(1); opacity: 0; } }

    /* Completion modal */
    #completion-message {
      position: absolute; inset: 0;
      display: grid; place-items: center;
      pointer-events: none;
    }
    #completion-card {
      pointer-events: auto;
      max-width: min(520px, 90vw);
      max-height: min(85vh, 720px);
      overflow: auto;
      padding: 24px;
    }
    #completion-card h2 { margin-top: 0; }
    #completion-scores p { margin: 6px 0; font-size: 16px; }
    .score-highlight { color: rgba(111,211,245,1); font-weight: 800; }

    .hidden { display: none !important; }

    /* Focus ring for keyboard users */
    :focus-visible { outline: 3px solid rgba(111,211,245,0.85); outline-offset: 2px; }

    /* Mobile tweaks */
    @media (max-width: 900px) {
      .hud { grid-template-columns: 1fr 1fr; grid-auto-rows: auto; }
      .hud .hud-item { text-align: left; }
    }
  </style>
</head>
<body>
  <!-- Sticky Header -->
  <header class="app-header" role="banner" aria-label="Exercise header">
    <a class="home-link" href="/" aria-label="Go to Home">
      <span aria-hidden="true">←</span> Home
    </a>
    <h1>Comet Tap</h1>
  </header>

  <!-- Two-column layout -->
  <main class="layout" role="main">
    <!-- Left: Settings -->
    <aside id="settings-panel" class="panel" aria-label="Settings panel">
      <h2>Comet Tap Exercise</h2>

      <div class="game-description">
        <h3>How to Play</h3>
        <p>Glowing comets streak across the screen. Tap or click a comet before it leaves to score points. Smaller &amp; faster = harder (and more points).</p>
        <p><strong>Tip:</strong> Aim for quick taps to boost your score multiplier.</p>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="session-duration">Session Duration (minutes)</label>
        <input type="number" id="session-duration" min="0.5" max="10" value="2" step="0.5" inputmode="decimal" aria-describedby="session-duration-help" />
        <div id="session-duration-help" class="setting-description">Start with 0.5–2 minutes and increase as you improve.</div>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="comet-size">Comet Size</label>
        <select id="comet-size" aria-label="Select comet size">
          <option value="large">Large (Easier)</option>
          <option value="medium" selected>Medium (Balanced)</option>
          <option value="small">Small (Challenging)</option>
        </select>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="comet-speed">Comet Speed</label>
        <select id="comet-speed" aria-label="Select comet speed">
          <option value="slow">Slow (Beginner)</option>
          <option value="medium" selected>Medium (Intermediate)</option>
          <option value="fast">Fast (Advanced)</option>
        </select>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="spawn-rate">Spawn Rate</label>
        <select id="spawn-rate" aria-label="Select comet spawn rate">
          <option value="slow">Slow (2s apart)</option>
          <option value="medium">Medium (1.5s apart)</option>
          <option value="fast" selected>Fast (1s apart)</option>
          <option value="very-fast">Very Fast (0.5s apart)</option>
        </select>
      </div>

      <div class="btn-row">
        <button id="start-session" class="btn" aria-label="Start session">Start</button>
        <button id="pause-session" class="btn" aria-label="Pause session" disabled>Pause</button>
      </div>
      <button id="restart-button" class="btn" aria-label="Restart session" disabled>Restart</button>
    </aside>

    <!-- Right: HUD + Game -->
    <section class="game-column" aria-label="Game column">
      <!-- HUD -->
      <div class="hud" role="region" aria-label="Session HUD">
        <div class="timer-wrap" aria-hidden="true">
          <div id="timer-bar"></div>
        </div>

        <div class="hud-item" aria-live="polite">
          <div class="stat-value" id="score">0</div>
          <div class="stat-label">Score</div>
        </div>

        <div class="hud-item" aria-live="polite">
          <div class="stat-value" id="personal-best">0</div>
          <div class="stat-label">Personal Best</div>
        </div>

        <div class="hud-item" aria-live="polite">
          <div class="stat-value" id="difficulty-display">Medium</div>
          <div class="stat-label">Difficulty</div>
        </div>
      </div>

      <!-- Game area -->
      <div id="game-area" tabindex="0" role="application" aria-label="Comet game area">
        <div id="stars-container" aria-hidden="true"></div>
      </div>

      <!-- Completion modal -->
      <div id="completion-message" class="hidden" role="dialog" aria-labelledby="cm-title" aria-modal="true">
        <div id="completion-card" class="panel">
          <h2 id="cm-title">Session Complete!</h2>
          <div id="completion-scores">
            <p>Final Score: <span id="final-score" class="score-highlight">0</span></p>
            <p>Comets Tapped: <span id="final-taps" class="score-highlight">0</span></p>
            <p>Accuracy: <span id="final-accuracy" class="score-highlight">0%</span></p>
            <p>Average Response Time: <span id="final-avg-time" class="score-highlight">0.0s</span></p>
            <p>XP Earned: <span id="final-xp" class="score-highlight">0</span></p>
            <p id="achievement-line" class="hidden">Achievements unlocked! 🎉</p>
          </div>
          <div class="btn-row" style="grid-template-columns: 1fr;">
            <button id="close-completion" class="btn" aria-label="Close and restart">Start New Session</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Main module -->
  <script type="module">
    /* ROOT-RELATIVE IMPORTS */
    import { storage, starfield, theme, viewport, audio, initUtils, toast } from '/js/utils.js';
    import { sessionEnhancement } from '/js/session-enhancement.js';
    import { checkAndUnlockAchievements, markExerciseTried } from '/js/achievements.js';
    import { recordSession } from '/js/progress.js';

    // ---- Init utils & viewport ----
    initUtils();
    function setViewportHeight(){ const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', \`\${vh}px\`); }
    window.addEventListener('load', setViewportHeight);
    window.addEventListener('resize', setViewportHeight);
    window.addEventListener('orientationchange', () => setTimeout(setViewportHeight, 100));

    // ---- Exercise ID ----
    const EXERCISE_ID = 'comet';

    // ---- DOM refs ----
    const gameArea = document.getElementById('game-area');
    const starsContainer = document.getElementById('stars-container');

    const settingsPanel = document.getElementById('settings-panel');
    const startBtn = document.getElementById('start-session');
    const pauseBtn = document.getElementById('pause-session');
    const restartBtn = document.getElementById('restart-button');
    const closeCompletionBtn = document.getElementById('close-completion');

    const scoreEl = document.getElementById('score');
    const pbEl = document.getElementById('personal-best');
    const diffEl = document.getElementById('difficulty-display');
    const timerBar = document.getElementById('timer-bar');

    const sessionDurationInput = document.getElementById('session-duration');
    const cometSizeSelect = document.getElementById('comet-size');
    const cometSpeedSelect = document.getElementById('comet-speed');
    const spawnRateSelect = document.getElementById('spawn-rate');

    const completionMessage = document.getElementById('completion-message');
    const finalScoreEl = document.getElementById('final-score');
    const finalTapsEl = document.getElementById('final-taps');
    const finalAccEl = document.getElementById('final-accuracy');
    const finalAvgEl = document.getElementById('final-avg-time');
    const finalXpEl = document.getElementById('final-xp');
    const achievementLine = document.getElementById('achievement-line');

    // ---- Difficulty mapping ----
    function currentDifficulty() {
      const size = cometSizeSelect.value; // large, medium, small
      const speed = cometSpeedSelect.value; // slow, medium, fast
      if (size === 'large' && speed === 'slow') return 'large';
      if (size === 'small' && speed === 'fast') return 'small';
      if (size === 'small' || speed === 'fast') return 'small';
      if (size === 'large' || speed === 'slow') return 'large';
      return 'medium';
    }
    diffEl.textContent = currentDifficulty()[0].toUpperCase() + currentDifficulty().slice(1);

    // ---- Session enhancement hooks ----
    sessionEnhancement.initializeExercise(EXERCISE_ID, currentDifficulty());
    cometSizeSelect.addEventListener('change', () => {
      sessionEnhancement.initializeExercise(EXERCISE_ID, currentDifficulty());
      diffEl.textContent = currentDifficulty()[0].toUpperCase() + currentDifficulty().slice(1);
    });
    cometSpeedSelect.addEventListener('change', () => {
      sessionEnhancement.initializeExercise(EXERCISE_ID, currentDifficulty());
      diffEl.textContent = currentDifficulty()[0].toUpperCase() + currentDifficulty().slice(1);
    });

    // ---- Starfield (shared util if available; graceful fallback) ----
    try {
      if (starfield && typeof starfield.attach === 'function') {
        starfield.attach(starsContainer, { density: 0.6 });
      } else {
        // Fallback simple stars
        for (let i = 0; i < 80; i++) {
          const star = document.createElement('div');
          star.classList.add('star');
          const size = Math.random() * 3 + 0.5;
          star.style.width = \`\${size}px\`;
          star.style.height = \`\${size}px\`;
          star.style.left = \`\${Math.random() * 100}%\`;
          star.style.top = \`\${Math.random() * 100}%\`;
          const opacity = Math.random() * 0.6 + 0.2;
          star.style.setProperty('--opacity', opacity);
          star.style.animationDelay = \`\${Math.random() * 3}s\`;
          starsContainer.appendChild(star);
        }
      }
    } catch {}

    // ---- State ----
    let isActive = false;
    let isPaused = false;
    let durationMs = 2 * 60 * 1000;
    let timeRemaining = 0;
    let timerInterval = null;
    let spawnInterval = null;
    let score = 0, taps = 0, misses = 0, totalResponseTime = 0;
    let comets = [];
    let gameRect = null;
    let focusedIndex = -1;
    let isTabVisible = true;
    document.addEventListener('visibilitychange', () => { isTabVisible = !document.hidden; });

    const cometSizes = { small: 40, medium: 60, large: 80 };
    const cometSpeeds = {
      slow: { min: 0.5, max: 1.5 },
      medium: { min: 1.0, max: 2.5 },
      fast: { min: 2.0, max: 3.5 }
    };
    const spawnRates = { 'very-fast': 500, fast: 1000, medium: 1500, slow: 2000 };

    // ---- Personal Best (local fallback) ----
    const PB_KEY = 'pb_comet';
    function getPB(){ return parseInt(localStorage.getItem(PB_KEY) || '0', 10); }
    function setPB(val){ localStorage.setItem(PB_KEY, String(val)); }
    pbEl.textContent = getPB();

    // ---- Keyboard Accessibility ----
    document.addEventListener('keydown', (e) => {
      if (!isActive || comets.length === 0) return;
      if (e.key === 'Tab') {
        e.preventDefault();
        focusedIndex = (focusedIndex + 1) % comets.length;
        comets[focusedIndex].focus();
      } else if (e.key === ' ' || e.key === 'Enter') {
        e.preventDefault();
        if (focusedIndex >= 0 && comets[focusedIndex]) hitComet(comets[focusedIndex]);
      }
    });

    // ---- Controls ----
    startBtn.addEventListener('click', () => {
      if (!isActive) startSession();
      else if (isPaused) resumeSession();
    });
    pauseBtn.addEventListener('click', () => {
      if (isActive && !isPaused) pauseSession();
      else if (isActive && isPaused) resumeSession();
    });
    restartBtn.addEventListener('click', restartSession);
    closeCompletionBtn.addEventListener('click', () => {
      completionMessage.classList.add('hidden');
      restartSession();
    });

    // Prevent accidental zoom & ensure touch parity
    document.addEventListener('touchstart', e => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
    let lastTouchEnd = 0;
    document.addEventListener('touchend', e => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, false);

    // ---- Settings persist ----
    function saveSettings() {
      localStorage.setItem('cometSessionDuration', sessionDurationInput.value);
      localStorage.setItem('cometSize', cometSizeSelect.value);
      localStorage.setItem('cometSpeed', cometSpeedSelect.value);
      localStorage.setItem('cometSpawnRate', spawnRateSelect.value);
    }
    function loadSettings() {
      sessionDurationInput.value = localStorage.getItem('cometSessionDuration') || 2;
      cometSizeSelect.value = localStorage.getItem('cometSize') || 'medium';
      cometSpeedSelect.value = localStorage.getItem('cometSpeed') || 'medium';
      spawnRateSelect.value = localStorage.getItem('cometSpawnRate') || 'fast';
    }
    loadSettings();

    // ---- Session lifecycle ----
    function startSession() {
      durationMs = parseFloat(sessionDurationInput.value) * 60 * 1000;
      timeRemaining = durationMs;
      saveSettings();

      // UI state
      isActive = true; isPaused = false;
      startBtn.textContent = 'Resume'; // will read as Resume when paused
      pauseBtn.textContent = 'Pause'; pauseBtn.disabled = false;
      restartBtn.disabled = false;
      settingsPanel.setAttribute('inert', ''); // prevent focus during session

      score = 0; taps = 0; misses = 0; totalResponseTime = 0; focusedIndex = -1;
      scoreEl.textContent = '0';
      gameRect = gameArea.getBoundingClientRect();

      updateTimerDisplay();
      timerInterval = setInterval(onTick, 1000);
      spawnInterval = setInterval(spawnComet, spawnRates[spawnRateSelect.value]);

      // Kick animation loop
      requestAnimationFrame(updateComets);

      // Announce
      gameArea.focus();
    }

    function pauseSession() {
      if (!isActive || isPaused) return;
      isPaused = true;
      clearInterval(timerInterval);
      clearInterval(spawnInterval);
      pauseBtn.textContent = 'Resume';
      if (toast && typeof toast.show === 'function') toast.show('Paused', { duration: 1200 });
    }

    function resumeSession() {
      if (!isActive || !isPaused) return;
      isPaused = false;
      timerInterval = setInterval(onTick, 1000);
      spawnInterval = setInterval(spawnComet, spawnRates[spawnRateSelect.value]);
      pauseBtn.textContent = 'Pause';
      if (toast && typeof toast.show === 'function') toast.show('Resumed', { duration: 1200 });
    }

    function restartSession() {
      // Clear any active comets
      comets.forEach(c => {
        if (c._particleInterval) clearInterval(c._particleInterval);
        c.remove();
      });
      comets = []; focusedIndex = -1;

      // Reset UI/buttons
      isActive = false; isPaused = false;
      startBtn.textContent = 'Start';
      pauseBtn.textContent = 'Pause'; pauseBtn.disabled = true;
      restartBtn.disabled = true;

      // Allow focusing settings again
      settingsPanel.removeAttribute('inert');
      gameArea.blur();

      // Clean timers
      clearInterval(timerInterval);
      clearInterval(spawnInterval);

      // Reset progress bar
      timeRemaining = 0;
      updateTimerDisplay();
    }

    function onTick() {
      if (!isActive || isPaused) return;
      timeRemaining -= 1000;
      if (timeRemaining <= 0) { endSession(); return; }
      updateTimerDisplay();
    }

    function updateTimerDisplay() {
      const progress = durationMs ? (timeRemaining / durationMs) : 0;
      timerBar.style.width = \`\${Math.max(0, progress) * 100}%\`;
    }

    // ---- Game logic ----
    function spawnComet() {
      if (!isActive || isPaused || !gameRect) return;

      const comet = document.createElement('div');
      comet.className = 'comet';
      comet.tabIndex = 0;

      const core = document.createElement('div');
      core.className = 'comet-core';
      const tail = document.createElement('div');
      tail.className = 'comet-tail';
      for (let i = 0; i < 3; i++) {
        const s = document.createElement('div');
        s.className = 'comet-tail-stream';
        tail.appendChild(s);
      }

      const size = cometSizes[cometSizeSelect.value];
      comet.style.width = \`\${size}px\`;
      comet.style.height = \`\${size}px\`;
      core.style.width = comet.style.width;
      core.style.height = comet.style.height;

      // Spawn from edges
      const edge = Math.floor(Math.random() * 4);
      let x, y, targetX, targetY;
      const margin = size + 20;
      switch(edge) {
        case 0: x = margin + Math.random() * (gameRect.width - 2 * margin); y = -size; targetX = margin + Math.random() * (gameRect.width - 2 * margin); targetY = gameRect.height + size; break;
        case 1: x = gameRect.width + size; y = margin + Math.random() * (gameRect.height - 2 * margin); targetX = -size; targetY = margin + Math.random() * (gameRect.height - 2 * margin); break;
        case 2: x = margin + Math.random() * (gameRect.width - 2 * margin); y = gameRect.height + size; targetX = margin + Math.random() * (gameRect.width - 2 * margin); targetY = -size; break;
        case 3: x = -size; y = margin + Math.random() * (gameRect.height - 2 * margin); targetX = gameRect.width + size; targetY = margin + Math.random() * (gameRect.height - 2 * margin); break;
      }
      comet.style.left = \`\${x}px\`;
      comet.style.top = \`\${y}px\`;

      const sp = cometSpeeds[cometSpeedSelect.value];
      const speed = sp.min + Math.random() * (sp.max - sp.min);
      const dx = targetX - x, dy = targetY - y;
      const dist = Math.hypot(dx, dy);
      const velX = (dx / dist) * speed;
      const velY = (dy / dist) * speed;
      const angle = Math.atan2(velY, velX) * 180 / Math.PI;

      comet.style.transform = \`rotate(\${angle}deg)\`;
      comet.append(core, tail);

      comet.addEventListener('pointerdown', (e) => { e.preventDefault(); hitComet(comet); });
      gameArea.appendChild(comet);

      comet.dataset.velX = velX;
      comet.dataset.velY = velY;
      comet.dataset.angle = angle;
      comet.dataset.spawnTime = Date.now();

      // trailing particles
      const particleInterval = setInterval(() => {
        if (!comet.isConnected) { clearInterval(particleInterval); return; }
        createCometParticle(comet);
      }, 100);
      comet._particleInterval = particleInterval;

      comets.push(comet);
    }

    function createCometParticle(comet) {
      if (!isTabVisible || window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const particle = document.createElement('div');
      particle.className = 'comet-particle';
      const rect = comet.getBoundingClientRect();
      const size = Math.random() * 4 + 2;
      particle.style.width = \`\${size}px\`;
      particle.style.height = \`\${size}px\`;
      // position at comet center (convert to game coords)
      const gameRectLocal = gameArea.getBoundingClientRect();
      particle.style.left = \`\${rect.left - gameRectLocal.left + rect.width / 2}px\`;
      particle.style.top  = \`\${rect.top  - gameRectLocal.top  + rect.height / 2}px\`;

      const hue = 200 + Math.random() * 60;
      particle.style.backgroundColor = \`hsla(\${hue}, 100%, 70%, \${Math.random() * 0.8 + 0.2})\`;
      particle.style.boxShadow = \`0 0 \${size * 2}px hsla(\${hue}, 100%, 70%, 0.5)\`;

      const angle = parseFloat(comet.dataset.angle) + 180 + (Math.random() - 0.5) * 60;
      const dist = Math.random() * 30 + 10;
      particle.style.setProperty('--dx', \`\${Math.cos(angle * Math.PI / 180) * dist}px\`);
      particle.style.setProperty('--dy', \`\${Math.sin(angle * Math.PI / 180) * dist}px\`);

      gameArea.appendChild(particle);
      setTimeout(() => particle.remove(), 1000);
    }

    function hitComet(comet) {
      if (!isActive || isPaused) return;
      const spawnTime = parseInt(comet.dataset.spawnTime, 10);
      const responseTime = Date.now() - spawnTime;
      totalResponseTime += responseTime;

      // Score calc
      const sizeValue = cometSizeSelect.value;
      const sizeMult = sizeValue === 'small' ? 1.5 : sizeValue === 'large' ? 0.8 : 1;
      const base = Math.max(50, Math.floor(3000 / responseTime * 100));
      const points = Math.floor(base * sizeMult);

      score += points; taps++;
      scoreEl.textContent = String(score);

      // Burst/explosion (comet explosion animation)
      createBurst(comet, points);

      // Remove comet + cleanup
      if (comet._particleInterval) clearInterval(comet._particleInterval);
      const idx = comets.indexOf(comet);
      if (idx > -1) {
        comets.splice(idx, 1);
        if (focusedIndex >= idx && focusedIndex > 0) focusedIndex--;
        else if (focusedIndex >= comets.length) focusedIndex = comets.length - 1;
      }
      comet.remove();
    }

    function createBurst(comet, points) {
      const areaRect = gameArea.getBoundingClientRect();
      const rect = comet.getBoundingClientRect();
      const cx = rect.left - areaRect.left + rect.width / 2;
      const cy = rect.top  - areaRect.top  + rect.height / 2;

      // rings
      for (let i = 0; i < 3; i++) {
        setTimeout(() => {
          const ring = document.createElement('div');
          ring.className = 'impact-ring';
          ring.style.left = \`\${cx}px\`;
          ring.style.top  = \`\${cy}px\`;
          gameArea.appendChild(ring);
          setTimeout(() => ring.remove(), 800);
        }, i * 90);
      }

      // score popup
      const popup = document.createElement('div');
      popup.className = 'score-popup';
      popup.textContent = \`+\${points}\`;
      popup.style.left = \`\${cx}px\`;
      popup.style.top  = \`\${cy}px\`;
      gameArea.appendChild(popup);
      setTimeout(() => popup.remove(), 1000);

      // radial particles
      const count = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 6 : 18;
      for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'comet-particle';
        const s = Math.random() * 8 + 4;
        p.style.width = \`\${s}px\`;
        p.style.height = \`\${s}px\`;
        p.style.left = \`\${cx}px\`;
        p.style.top  = \`\${cy}px\`;
        const ang = (Math.PI * 2 / count) * i + Math.random() * 0.5;
        const dist = Math.random() * 60 + 40;
        p.style.setProperty('--dx', \`\${Math.cos(ang) * dist}px\`);
        p.style.setProperty('--dy', \`\${Math.sin(ang) * dist}px\`);
        const hue = 180 + Math.random() * 60;
        p.style.backgroundColor = \`hsla(\${hue}, 100%, 70%, 1)\`;
        p.style.boxShadow = '0 0 10px hsla(' + hue + ', 100%, 70%, 0.8)';
        gameArea.appendChild(p);
        setTimeout(() => p.remove(), 1000);
      }
    }

    function updateComets() {
      if (!isActive || isPaused) return;
      const areaW = gameArea.clientWidth;
      const areaH = gameArea.clientHeight;
      comets.forEach((comet, idx) => {
        const vx = parseFloat(comet.dataset.velX);
        const vy = parseFloat(comet.dataset.velY);
        const ang = parseFloat(comet.dataset.angle);
        let x = parseFloat(comet.style.left);
        let y = parseFloat(comet.style.top);
        x += vx; y += vy;
        comet.style.left = \`\${x}px\`;
        comet.style.top  = \`\${y}px\`;
        comet.style.transform = \`rotate(\${ang}deg)\`;

        const size = parseFloat(comet.style.width);
        if (x < -size * 3 || x > areaW + size * 3 || y < -size * 3 || y > areaH + size * 3) {
          if (comet._particleInterval) clearInterval(comet._particleInterval);
          comet.remove();
          comets.splice(idx, 1);
          if (focusedIndex >= idx && focusedIndex > 0) focusedIndex--;
          else if (focusedIndex >= comets.length) focusedIndex = comets.length - 1;
          misses++;
        }
      });
      if (isActive && !isPaused) requestAnimationFrame(updateComets);
    }

    // ---- End session (standardised hook) ----
    function doEndSession() {
      isActive = false; isPaused = false;
      clearInterval(timerInterval);
      clearInterval(spawnInterval);

      const accuracy = taps + misses > 0 ? Math.round((taps / (taps + misses)) * 100) : 0;
      const avgResponse = taps > 0 ? (totalResponseTime / taps / 1000).toFixed(2) : '0.00';

      sessionEnhancement.handleSessionComplete({
        score,
        taps,
        accuracy,
        avgResponseTime: parseFloat(avgResponse)
      });

      // Record & achievements
      const difficulty = currentDifficulty();
      try {
        recordSession(EXERCISE_ID, difficulty, score);
        markExerciseTried(EXERCISE_ID);
        const unlocked = checkAndUnlockAchievements();
        if (unlocked && unlocked.length) {
          achievementLine.classList.remove('hidden');
          if (toast && typeof toast.show === 'function') {
            unlocked.forEach(a => toast.show(\`Achievement unlocked: \${a}\`, { duration: 3500 }));
          }
        } else {
          achievementLine.classList.add('hidden');
        }
      } catch (e) {
        console.warn('Progress/Achievement integration error:', e);
      }

      // PB update (local fallback)
      if (score > getPB()) {
        setPB(score);
        pbEl.textContent = score;
      }

      // Completion modal details
      finalScoreEl.textContent = score;
      finalTapsEl.textContent = taps;
      finalAccEl.textContent = \`\${accuracy}%\`;
      finalAvgEl.textContent = \`\${avgResponse}s\`;

      // Simple XP model: 1 XP per 10 pts (floor)
      const xp = Math.max(1, Math.floor(score / 10));
      finalXpEl.textContent = xp;

      // Show modal
      completionMessage.classList.remove('hidden');

      // Cleanup comets
      comets.forEach(c => { if (c._particleInterval) clearInterval(c._particleInterval); c.remove(); });
      comets = []; focusedIndex = -1;

      // Reset buttons
      pauseBtn.disabled = true;
    }

    // Public hook following the spec: window.endSession(score, difficulty)
    // If score/difficulty provided, we respect them; otherwise use current state.
    window.endSession = function (forcedScore = null, forcedDifficulty = null) {
      if (forcedScore != null) score = Number(forcedScore) || 0;
      if (forcedDifficulty) {
        // show in HUD immediately
        diffEl.textContent = forcedDifficulty[0].toUpperCase() + forcedDifficulty.slice(1);
      }
      doEndSession();
    };

    function endSession() { doEndSession(); }

    // ---- Helpers ----
    function safeStop() {
      clearInterval(timerInterval);
      clearInterval(spawnInterval);
      comets.forEach(c => { if (c._particleInterval) clearInterval(c._particleInterval); c.remove(); });
      comets = [];
    }

    // ---- Restart lifecycle (used by completion & button) ----
    function fullResetUI() {
      startBtn.textContent = 'Start';
      pauseBtn.textContent = 'Pause'; pauseBtn.disabled = true;
      restartBtn.disabled = true;
      settingsPanel.removeAttribute('inert');
      scoreEl.textContent = '0';
      pbEl.textContent = getPB();
    }

    // Public restart
    function hardReset() {
      safeStop();
      isActive = false;
      isPaused = false;
      timeRemaining = 0;
      updateTimerDisplay();
      fullResetUI();
    }

    function restartSession() {
      hardReset();
      // leave user at settings; next Start begins a new session
    }

    // ---- Safety on unload ----
    window.addEventListener('beforeunload', () => { if (isActive) safeStop(); });
  </script>
</body>
</html>
