<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKCCWBFKE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RVKCCWBFKE', { 'anonymize_ip': true });
    </script>
    
    <title>Comet Tap Exercise | Dynamic Tracking Therapy | Fine Point Rehab</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Interactive comet tracking therapy exercise for stroke rehabilitation and visual motor skills. Evidence-based hand-eye coordination training for physical therapy, occupational therapy, and brain injury recovery.">
    
    <style>
        :root {
            --vh: 1vh;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            background: #0a0e1a;
            color: white;
            min-height: 100vh;
            min-height: calc(var(--vh, 1vh) * 100);
            padding-bottom: max(0px, env(safe-area-inset-bottom));
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(40,20,80,0.4) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 70%, rgba(20,40,80,0.3) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 50%, rgba(10,20,40,0.5) 0%, transparent 70%),
                linear-gradient(180deg, #0a0e1a 0%, #1a1f3a 50%, #0f1524 100%);
        }
        
        /* Game area where comets can move */
        #game-area {
            position: absolute;
            top: 8px; /* Below timer bar */
            left: 0;
            right: 0;
            bottom: 120px; /* Above stats panel */
            overflow: hidden;
            pointer-events: none;
        }
        
        #game-area .comet {
            pointer-events: auto;
        }
        
        /* Enhanced Comet Styles */
        .comet {
            position: absolute;
            width: 60px;
            height: 60px;
            cursor: pointer;
            z-index: 5;
            overflow: visible;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            border-radius: 50%;
        }
        
        .comet:focus {
            box-shadow: 0 0 0 3px rgba(111, 211, 245, 0.8);
        }
        
        .comet-core {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: 
                radial-gradient(circle at 30% 30%, 
                    rgba(255,255,255,1) 0%, 
                    rgba(150,220,255,0.9) 15%,
                    rgba(100,180,255,0.8) 30%,
                    rgba(50,120,200,0.7) 50%,
                    rgba(20,60,150,0.5) 70%,
                    transparent 100%),
                radial-gradient(circle at 70% 70%, 
                    rgba(255,200,150,0.4) 0%, 
                    transparent 50%);
            box-shadow: 
                0 0 30px rgba(150,220,255,1),
                0 0 60px rgba(100,180,255,0.8),
                0 0 90px rgba(50,120,200,0.6),
                inset 0 0 20px rgba(255,255,255,0.8),
                inset -5px -5px 15px rgba(100,180,255,0.5);
            animation: cometPulse 2s ease-in-out infinite, cometRotate 4s linear infinite;
        }
        
        @media (prefers-reduced-motion: reduce) {
            .comet-core { animation: none; }
            .star { animation: none; }
            .shooting-star { display: none; }
        }
        
        @keyframes cometRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes cometPulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.15); filter: brightness(1.3); }
        }
        
        /* Enhanced multi-layer tail */
        .comet-tail {
            position: absolute;
            pointer-events: none;
            width: 200px;
            height: 40px;
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            z-index: 4;
        }
        
        .comet-tail-stream {
            position: absolute;
            width: 100%;
            height: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(to right, 
                transparent 0%, 
                rgba(111, 211, 245, 0.1) 20%, 
                rgba(150, 180, 255, 0.3) 40%, 
                rgba(180, 150, 255, 0.5) 60%, 
                rgba(200, 120, 255, 0.7) 80%,
                rgba(220, 100, 255, 0.9) 100%);
            filter: blur(2px);
            border-radius: 4px;
        }
        .comet-tail-stream:nth-child(2) { top: 45%; opacity: 0.7; filter: blur(4px); height: 12px; }
        .comet-tail-stream:nth-child(3) { top: 55%; opacity: 0.5; filter: blur(6px); height: 16px; }
        
        /* Comet particles */
        .comet-particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 4;
            animation: particleDrift 1s ease-out forwards;
        }
        @keyframes particleDrift {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.3); }
        }
        
        /* Enhanced stars */
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: starTwinkle 3s ease-in-out infinite;
        }
        @keyframes starTwinkle {
            0%, 100% { opacity: var(--opacity); transform: scale(1); }
            50% { opacity: calc(var(--opacity) * 1.5); transform: scale(1.2); }
        }
        
        /* Impact effects */
        .impact-ring {
            position: absolute;
            border: 2px solid rgba(150, 220, 255, 0.8);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -50%);
            animation: ringExpand 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 8;
        }
        @keyframes ringExpand {
            0% { width: 20px; height: 20px; opacity: 1; border-width: 3px; }
            100% { width: 150px; height: 150px; opacity: 0; border-width: 1px; }
        }
        
        .score-popup {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #6cffbd;
            text-shadow: 0 0 10px rgba(108, 255, 189, 0.8);
            transform: translate(-50%, -50%);
            animation: scoreFloat 1s ease-out forwards;
            pointer-events: none;
            z-index: 9;
        }
        @keyframes scoreFloat {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -120%) scale(1); opacity: 0; }
        }
        
        #settings-panel, #completion-message {
            background-color: rgba(8, 15, 35, 0.95);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #timer-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 8px;
            background: linear-gradient(90deg, 
                rgba(111, 211, 245, 0.9) 0%, 
                rgba(150, 180, 255, 0.9) 50%, 
                rgba(200, 150, 255, 0.9) 100%);
            width: 100%;
            z-index: 20;
            box-shadow: 0 2px 10px rgba(111, 211, 245, 0.5);
        }
        
        #settings-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 15px;
            padding: 25px;
            z-index: 100;
            width: 85%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            padding-bottom: max(25px, env(safe-area-inset-bottom));
        }
        #settings-panel h2 { text-align: center; color: white; margin: 0 0 15px; font-size: 24px; letter-spacing: 0.5px; }
        
        #home-button {
            position: fixed;
            bottom: max(15px, env(safe-area-inset-bottom));
            right: 15px;
            background-color: rgba(111, 211, 245, 0.8);
            color: #121d33;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 90;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #home-button:hover { background-color: rgba(111, 211, 245, 1); transform: translateY(-2px); }
        
        .settings-group { margin-bottom: 20px; }
        .settings-label { display: block; margin-bottom: 5px; font-weight: bold; color: white; font-size: 16px; }
        
        select, input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 16px;
            background-color: rgba(0, 10, 30, 0.8);
            color: white;
            box-sizing: border-box;
        }
        select:focus, input:focus { outline: none; border-color: rgba(111, 211, 245, 0.8); box-shadow: 0 0 0 2px rgba(111, 211, 245, 0.3); }
        
        button {
            background-color: rgba(111, 211, 245, 0.9);
            color: #121d33;
            border: none;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            min-height: 48px;
            box-sizing: border-box;
        }
        button:hover { background-color: rgba(111, 211, 245, 1); transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        
        main { position: relative; width: 100%; height: 100%; }
        
        #stats-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background-color: rgba(8, 15, 35, 0.8);
            padding: 15px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            z-index: 10;
        }
        
        .stat-box { text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: rgba(111, 211, 245, 1); }
        .stat-label { font-size: 14px; color: rgba(255, 255, 255, 0.8); }
        .hidden { display: none !important; }
        
        #completion-message {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 30px; border-radius: 15px; text-align: center;
            max-width: 80%; max-height: calc(var(--vh, 1vh) * 85);
            overflow-y: auto; padding-bottom: max(30px, env(safe-area-inset-bottom));
        }
        #completion-message h2 { color: white; margin-top: 0; }
        #completion-scores { margin: 20px 0; font-size: 18px; }
        .score-highlight { color: rgba(111, 211, 245, 1); font-weight: bold; }
        
        #stars-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; overflow: hidden; pointer-events: none; }
        
        .game-description {
            background-color: rgba(111, 211, 245, 0.1);
            border-left: 4px solid rgba(111, 211, 245, 0.8);
            padding: 15px; margin-bottom: 25px; border-radius: 5px;
            color: rgba(255, 255, 255, 0.9); line-height: 1.5;
        }
        .game-description h3 { margin: 0 0 10px; color: rgba(111, 211, 245, 1); font-size: 18px; }
        .setting-description { font-size: 14px; color: rgba(255, 255, 255, 0.7); margin-bottom: 8px; line-height: 1.4; }
        
        .shooting-star {
            position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%;
            animation: shootingStar 3s linear; pointer-events: none;
        }
        .shooting-star::after {
            content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 2px;
            background: linear-gradient(to left, transparent, white); opacity: 0.5;
        }
        @keyframes shootingStar {
            from { transform: translate(0, 0); opacity: 1; }
            to { transform: translate(-500px, 300px); opacity: 0; }
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            #settings-panel {
                position: fixed;
                top: calc(var(--vh, 1vh) * 5);
                transform: translateX(-50%);
                max-height: calc(var(--vh, 1vh) * 80);
                padding: 20px;
                padding-bottom: max(20px, env(safe-area-inset-bottom));
                width: 92%;
                bottom: auto;
                margin-bottom: 0;
            }
            #completion-message {
                position: fixed;
                top: calc(var(--vh, 1vh) * 5);
                transform: translateX(-50%);
                max-height: calc(var(--vh, 1vh) * 80);
                padding: 20px;
                padding-bottom: max(20px, env(safe-area-inset-bottom));
                width: 92%; max-width: 400px;
            }
            button { padding: 15px 20px; font-size: 18px; min-height: 52px; margin-top: 20px; margin-bottom: 15px; }
            .game-description { padding: 12px; margin-bottom: 20px; font-size: 14px; }
            .settings-group { margin-bottom: 18px; }
            .settings-label { font-size: 15px; }
            select, input { padding: 14px; font-size: 16px; min-height: 48px; }
            .stat-value { font-size: 20px; }
            .stat-label { font-size: 12px; }
            #home-button { width: 56px; height: 56px; font-size: 12px; bottom: max(20px, env(safe-area-inset-bottom)); right: 20px; }
            #game-area { bottom: 100px; }
        }
        
        @media (max-height: 600px) {
            #settings-panel { top: calc(var(--vh, 1vh) * 2); max-height: calc(var(--vh, 1vh) * 90); padding: 15px; }
            .game-description { padding: 10px; margin-bottom: 15px; font-size: 13px; }
            .settings-group { margin-bottom: 15px; }
            button { padding: 12px 15px; font-size: 16px; margin-top: 15px; }
        }
        
        @media (max-width: 768px) and (orientation: landscape) {
            #settings-panel { top: calc(var(--vh, 1vh) * 2); max-height: calc(var(--vh, 1vh) * 92); overflow-y: auto; padding: 15px; }
            .game-description { padding: 8px; margin-bottom: 12px; font-size: 12px; }
            .settings-group { margin-bottom: 12px; }
            button { padding: 10px 15px; font-size: 14px; margin-top: 10px; }
        }
        
        @media (min-width: 768px) and (max-width: 1024px) {
            #settings-panel { max-width: 500px; padding: 30px; }
        }
        
        @media (hover: none) and (pointer: coarse) {
            button { min-height: 48px; padding: 15px 20px; }
            select, input { min-height: 48px; padding: 15px; }
            .comet { min-width: 44px; min-height: 44px; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="stars-container"></div>
        <div id="timer-bar"></div>
        
        <main role="main">
            <div id="game-area"></div>
            <button id="home-button">Home</button>
            
            <div id="settings-panel">
                <h2>Comet Tap Exercise</h2>
                
                <div class="game-description">
                    <h3>How to Play</h3>
                    <p>Glowing comets will streak across the screen from different directions. Tap or click each comet before it disappears. This exercise helps improve hand-eye coordination, reaction time, and fine motor control.</p>
                    <p><strong>Tip:</strong> Faster reactions and smaller targets earn higher scores!</p>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Session Duration (minutes):</label>
                    <div class="setting-description">Start with 0.5–2 minutes and increase as you improve.</div>
                    <input type="number" id="session-duration" min="0.5" max="10" value="2" step="0.5">
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Comet Size:</label>
                    <div class="setting-description">Smaller comets are harder but worth more points.</div>
                    <select id="comet-size">
                        <option value="large">Large (Easier)</option>
                        <option value="medium" selected>Medium (Balanced)</option>
                        <option value="small">Small (Challenging)</option>
                    </select>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Comet Speed:</label>
                    <div class="setting-description">Faster comets increase difficulty.</div>
                    <select id="comet-speed">
                        <option value="slow">Slow (Beginner)</option>
                        <option value="medium" selected>Medium (Intermediate)</option>
                        <option value="fast">Fast (Advanced)</option>
                    </select>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Spawn Rate:</label>
                    <div class="setting-description">How frequently new comets appear.</div>
                    <select id="spawn-rate">
                        <option value="slow">Slow (2 seconds apart)</option>
                        <option value="medium">Medium (1.5 seconds apart)</option>
                        <option value="fast" selected>Fast (1 second apart)</option>
                        <option value="very-fast">Very Fast (0.5 seconds apart)</option>
                    </select>
                </div>
                
                <button id="start-session">Start Therapy Session</button>
            </div>
            
            <div id="stats-panel" class="hidden">
                <div class="stat-box">
                    <div id="score" class="stat-value" role="status" aria-live="polite">0</div>
                    <div class="stat-label">Score</div>
                </div>
                <div class="stat-box">
                    <div id="taps" class="stat-value" role="status" aria-live="polite">0</div>
                    <div class="stat-label">Comets Tapped</div>
                </div>
                <div class="stat-box">
                    <div id="time-left" class="stat-value" role="status" aria-live="polite">2:00</div>
                    <div class="stat-label">Time Left</div>
                </div>
                <div class="stat-box">
                    <div id="accuracy" class="stat-value" role="status" aria-live="polite">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
            </div>
            
            <div id="completion-message" class="hidden">
                <h2>Session Complete!</h2>
                <div id="completion-scores">
                    <p>Final Score: <span id="final-score" class="score-highlight">0</span></p>
                    <p>Comets Tapped: <span id="final-taps" class="score-highlight">0</span></p>
                    <p>Accuracy: <span id="final-accuracy" class="score-highlight">0%</span></p>
                    <p>Average Response Time: <span id="final-avg-time" class="score-highlight">0.0s</span></p>
                </div>
                <button id="restart-button">Start New Session</button>
            </div>
        </main>
    </div>
    
    <!-- Main module: utilities, game logic, and hooks -->
    <script type="module">
        /* ROOT-RELATIVE IMPORTS */
        import { storage, starfield, theme, viewport, audio, initUtils, toast } from '/js/utils.js';
        import { sessionEnhancement } from '/js/session-enhancement.js';
        import { checkAndUnlockAchievements, markExerciseTried } from '/js/achievements.js';
        import { recordSession } from '/js/progress.js';
        
        // Initialize utilities
        initUtils();
        
        // Exercise identity (used by progress/achievements)
        const EXERCISE_ID = 'comet';
        
        // SESSION ENHANCEMENT
        function getCurrentDifficulty() {
            const cometSizeSelect = document.getElementById('comet-size');
            const cometSpeedSelect = document.getElementById('comet-speed');
            if (!cometSizeSelect || !cometSpeedSelect) return 'medium';
            const size = cometSizeSelect.value; // large, medium, small
            const speed = cometSpeedSelect.value; // slow, medium, fast
            if (size === 'large' && speed === 'slow') return 'large';
            if (size === 'small' && speed === 'fast') return 'small';
            if (size === 'small' || speed === 'fast') return 'small';
            if (size === 'large' || speed === 'slow') return 'large';
            return 'medium';
        }
        sessionEnhancement.initializeExercise(EXERCISE_ID, getCurrentDifficulty());
        const cometSizeSelect = document.getElementById('comet-size');
        const cometSpeedSelect = document.getElementById('comet-speed');
        if (cometSizeSelect) cometSizeSelect.addEventListener('change', () => sessionEnhancement.initializeExercise(EXERCISE_ID, getCurrentDifficulty()));
        if (cometSpeedSelect) cometSpeedSelect.addEventListener('change', () => sessionEnhancement.initializeExercise(EXERCISE_ID, getCurrentDifficulty()));
        
        // Game elements
        const gameContainer = document.getElementById('game-container');
        const gameArea = document.getElementById('game-area');
        const timerBar = document.getElementById('timer-bar');
        const settingsPanel = document.getElementById('settings-panel');
        const homeButton = document.getElementById('home-button');
        const statsPanel = document.getElementById('stats-panel');
        const completionMessage = document.getElementById('completion-message');
        const starsContainer = document.getElementById('stars-container');
        
        const sessionDurationInput = document.getElementById('session-duration');
        const spawnRateSelect = document.getElementById('spawn-rate');
        const startSessionButton = document.getElementById('start-session');
        const restartButton = document.getElementById('restart-button');
        const scoreElement = document.getElementById('score');
        const tapsElement = document.getElementById('taps');
        const timeLeftElement = document.getElementById('time-left');
        const accuracyElement = document.getElementById('accuracy');
        const finalScoreElement = document.getElementById('final-score');
        const finalTapsElement = document.getElementById('final-taps');
        const finalAccuracyElement = document.getElementById('final-accuracy');
        const finalAvgTimeElement = document.getElementById('final-avg-time');
        
        let gameAreaRect = null;
        let isTabVisible = true;
        
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        function adjustForMobile() {
            setViewportHeight();
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (isMobile || isTouch) {
                document.body.classList.add('mobile-device');
                const settingsPanel = document.getElementById('settings-panel');
                const completionMessage = document.getElementById('completion-message');
                if (settingsPanel && !settingsPanel.classList.contains('hidden')) {
                    const screenHeight = window.innerHeight;
                    const safeHeight = Math.min(screenHeight * 0.8, screenHeight - 100);
                    settingsPanel.style.maxHeight = `${safeHeight}px`;
                }
                if (completionMessage && !completionMessage.classList.contains('hidden')) {
                    const screenHeight = window.innerHeight;
                    const safeHeight = Math.min(screenHeight * 0.8, screenHeight - 100);
                    completionMessage.style.maxHeight = `${safeHeight}px`;
                }
            }
            if (gameArea) gameAreaRect = gameArea.getBoundingClientRect();
        }
        window.addEventListener('load', adjustForMobile);
        window.addEventListener('resize', adjustForMobile);
        window.addEventListener('orientationchange', () => setTimeout(adjustForMobile, 100));
        document.addEventListener('visibilitychange', () => { isTabVisible = !document.hidden; });
        
        // Starfield
        for (let i = 0; i < 80; i++) {
            const star = document.createElement('div');
            star.classList.add('star');
            const size = Math.random() * 3 + 0.5;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            const opacity = Math.random() * 0.6 + 0.2;
            star.style.setProperty('--opacity', opacity);
            star.style.animationDelay = `${Math.random() * 3}s`;
            starsContainer.appendChild(star);
        }
        let shootingStarInterval = setInterval(() => {
            if (!isTabVisible) return;
            const shootingStar = document.createElement('div');
            shootingStar.className = 'shooting-star';
            shootingStar.style.left = `${Math.random() * 100 + 100}%`;
            shootingStar.style.top = `${Math.random() * 50}%`;
            gameContainer.appendChild(shootingStar);
            setTimeout(() => shootingStar.remove(), 3000);
        }, 5000);
        
        // Game state
        let isSessionActive = false;
        let sessionDuration = 2 * 60 * 1000;
        let timeRemaining = 0;
        let timerInterval = null;
        let spawnInterval = null;
        let score = 0;
        let taps = 0;
        let misses = 0;
        let totalResponseTime = 0;
        let comets = [];
        let focusedCometIndex = -1;
        
        const cometSizes = { small: 40, medium: 60, large: 80 };
        const cometSpeeds = {
            slow: { min: 0.5, max: 1.5 },
            medium: { min: 1.0, max: 2.5 },
            fast: { min: 2.0, max: 3.5 }
        };
        const spawnRates = { 'very-fast': 500, fast: 1000, medium: 1500, slow: 2000 };
        
        startSessionButton.addEventListener('click', startSession);
        restartButton.addEventListener('click', restartSession);
        homeButton.addEventListener('click', goHome);
        
        document.addEventListener('keydown', function(e) {
            if (!isSessionActive || comets.length === 0) return;
            switch(e.key) {
                case 'Tab':
                    e.preventDefault();
                    focusedCometIndex = (focusedCometIndex + 1) % comets.length;
                    comets[focusedCometIndex].focus();
                    break;
                case ' ':
                case 'Enter':
                    e.preventDefault();
                    if (focusedCometIndex >= 0 && comets[focusedCometIndex]) {
                        hitComet(comets[focusedCometIndex]);
                    }
                    break;
            }
        });
        
        loadSettings();
        
        function startSession() {
            sessionDuration = parseFloat(sessionDurationInput.value) * 60 * 1000;
            timeRemaining = sessionDuration;
            saveSettings();
            score = 0; taps = 0; misses = 0; totalResponseTime = 0; focusedCometIndex = -1;
            gameAreaRect = gameArea.getBoundingClientRect();
            settingsPanel.classList.add('hidden');
            statsPanel.classList.remove('hidden');
            updateStats();
            isSessionActive = true;
            updateTimerDisplay();
            timerInterval = setInterval(updateTimer, 1000);
            spawnInterval = setInterval(createComet, spawnRates[spawnRateSelect.value]);
            requestAnimationFrame(updateComets);
        }
        
        function restartSession() {
            comets.forEach(comet => {
                if (comet._particleInterval) clearInterval(comet._particleInterval);
                if (comet.parentNode) comet.parentNode.removeChild(comet);
            });
            comets = []; focusedCometIndex = -1;
            completionMessage.classList.add('hidden');
            settingsPanel.classList.remove('hidden');
        }
        
        function updateStats() {
            scoreElement.textContent = score;
            tapsElement.textContent = taps;
            const accuracy = taps + misses > 0 ? Math.round((taps / (taps + misses)) * 100) : 0;
            accuracyElement.textContent = `${accuracy}%`;
        }
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / (60 * 1000));
            const seconds = Math.floor((timeRemaining % (60 * 1000)) / 1000);
            timeLeftElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            const progress = timeRemaining / sessionDuration;
            timerBar.style.width = `${progress * 100}%`;
        }
        function updateTimer() {
            if (!isSessionActive) return;
            timeRemaining -= 1000;
            if (timeRemaining <= 0) { endSession(); return; }
            updateTimerDisplay();
        }
        
        function showAchievementNotification(achievementId) {
            try {
                if (toast && typeof toast.show === 'function') {
                    toast.show(`Achievement unlocked: ${achievementId}`, { duration: 4000 });
                } else if (toast) {
                    toast(`Achievement unlocked: ${achievementId}`);
                } else {
                    console.log('Achievement unlocked:', achievementId);
                }
            } catch {
                console.log('Achievement unlocked:', achievementId);
            }
        }
        
        function endSession() {
            isSessionActive = false;
            clearInterval(timerInterval);
            clearInterval(spawnInterval);
            const accuracy = taps + misses > 0 ? Math.round((taps / (taps + misses)) * 100) : 0;
            const avgResponseTime = taps > 0 ? (totalResponseTime / taps / 1000).toFixed(2) : 0;
            
            sessionEnhancement.handleSessionComplete({
                score,
                taps,
                accuracy,
                avgResponseTime: parseFloat(avgResponseTime)
            });
            
            // Record progress & achievements
            const difficulty = getCurrentDifficulty();
            try {
                recordSession(EXERCISE_ID, difficulty, score);
                markExerciseTried(EXERCISE_ID);
                const newAchievements = checkAndUnlockAchievements();
                newAchievements.forEach(showAchievementNotification);
            } catch (e) {
                console.warn('Progress/Achievement integration error:', e);
            }
            
            finalScoreElement.textContent = score;
            finalTapsElement.textContent = taps;
            finalAccuracyElement.textContent = `${accuracy}%`;
            finalAvgTimeElement.textContent = `${avgResponseTime}s`;
            
            statsPanel.classList.add('hidden');
            completionMessage.classList.remove('hidden');
            setTimeout(adjustForMobile, 100);
            
            comets.forEach(comet => {
                if (comet._particleInterval) clearInterval(comet._particleInterval);
                if (comet.parentNode) comet.parentNode.removeChild(comet);
            });
            comets = []; focusedCometIndex = -1;
        }
        
        function goHome() {
            if (isSessionActive) {
                isSessionActive = false;
                clearInterval(timerInterval);
                clearInterval(spawnInterval);
                comets.forEach(comet => {
                    if (comet._particleInterval) clearInterval(comet._particleInterval);
                    if (comet.parentNode) comet.parentNode.removeChild(comet);
                });
                comets = []; focusedCometIndex = -1;
            }
            clearInterval(shootingStarInterval);
            window.location.href = '../index.html';
        }
        
        function createComet() {
            if (!isSessionActive || !gameAreaRect) return;
            const comet = document.createElement('div');
            comet.className = 'comet';
            comet.tabIndex = 0;
            const cometCore = document.createElement('div');
            cometCore.className = 'comet-core';
            const tail = document.createElement('div');
            tail.className = 'comet-tail';
            for (let i = 0; i < 3; i++) {
                const stream = document.createElement('div');
                stream.className = 'comet-tail-stream';
                tail.appendChild(stream);
            }
            const size = cometSizes[document.getElementById('comet-size').value];
            comet.style.width = `${size}px`;
            comet.style.height = `${size}px`;
            cometCore.style.width = `${size}px`;
            cometCore.style.height = `${size}px`;
            
            const edge = Math.floor(Math.random() * 4);
            let x, y, targetX, targetY;
            const margin = size + 20;
            switch (edge) {
                case 0: x = margin + Math.random() * (gameAreaRect.width - 2 * margin); y = -size; targetX = margin + Math.random() * (gameAreaRect.width - 2 * margin); targetY = gameAreaRect.height + size; break;
                case 1: x = gameAreaRect.width + size; y = margin + Math.random() * (gameAreaRect.height - 2 * margin); targetX = -size; targetY = margin + Math.random() * (gameAreaRect.height - 2 * margin); break;
                case 2: x = margin + Math.random() * (gameAreaRect.width - 2 * margin); y = gameAreaRect.height + size; targetX = margin + Math.random() * (gameAreaRect.width - 2 * margin); targetY = -size; break;
                case 3: x = -size; y = margin + Math.random() * (gameAreaRect.height - 2 * margin); targetX = gameAreaRect.width + size; targetY = margin + Math.random() * (gameAreaRect.height - 2 * margin); break;
            }
            comet.style.left = `${x}px`;
            comet.style.top = `${y}px`;
            const speedRange = cometSpeeds[document.getElementById('comet-speed').value];
            const speed = speedRange.min + Math.random() * (speedRange.max - speedRange.min);
            const dx = targetX - x;
            const dy = targetY - y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const velX = (dx / distance) * speed;
            const velY = (dy / distance) * speed;
            const angle = Math.atan2(velY, velX) * 180 / Math.PI;
            comet.style.transform = `rotate(${angle}deg)`;
            comet.appendChild(cometCore);
            comet.appendChild(tail);
            comet.addEventListener('pointerdown', function(e) { e.preventDefault(); hitComet(comet); });
            gameArea.appendChild(comet);
            comet.dataset.velX = velX;
            comet.dataset.velY = velY;
            comet.dataset.angle = angle;
            comet.dataset.spawnTime = Date.now();
            comets.push(comet);
            const particleInterval = setInterval(() => {
                if (!comet.parentNode) { clearInterval(particleInterval); return; }
                createCometParticle(comet);
            }, 100);
            comet._particleInterval = particleInterval;
        }
        
        function createCometParticle(comet) {
            if (!isTabVisible || window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            const particle = document.createElement('div');
            particle.className = 'comet-particle';
            const size = Math.random() * 4 + 2;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            const rect = comet.getBoundingClientRect();
            particle.style.left = `${rect.left - gameAreaRect.left + rect.width / 2}px`;
            particle.style.top = `${rect.top - gameAreaRect.top + rect.height / 2}px`;
            const hue = 200 + Math.random() * 60;
            particle.style.backgroundColor = `hsla(${hue}, 100%, 70%, ${Math.random() * 0.8 + 0.2})`;
            particle.style.boxShadow = `0 0 ${size * 2}px hsla(${hue}, 100%, 70%, 0.5)`;
            const angle = parseFloat(comet.dataset.angle) + 180 + (Math.random() - 0.5) * 60;
            const dist = Math.random() * 30 + 10;
            particle.style.setProperty('--dx', `${Math.cos(angle * Math.PI / 180) * dist}px`);
            particle.style.setProperty('--dy', `${Math.sin(angle * Math.PI / 180) * dist}px`);
            gameArea.appendChild(particle);
            setTimeout(() => particle.remove(), 1000);
        }
        
        function hitComet(comet) {
            if (!isSessionActive) return;
            const spawnTime = parseInt(comet.dataset.spawnTime);
            const responseTime = Date.now() - spawnTime;
            totalResponseTime += responseTime;
            const sizeValue = document.getElementById('comet-size').value;
            const sizeMultiplier = sizeValue === 'small' ? 1.5 : sizeValue === 'large' ? 0.8 : 1;
            const baseScore = Math.max(50, Math.floor(3000 / responseTime * 100));
            const points = Math.floor(baseScore * sizeMultiplier);
            score += points; taps++;
            updateStats();
            createBurst(comet, points);
            if (comet._particleInterval) clearInterval(comet._particleInterval);
            const index = comets.indexOf(comet);
            if (index > -1) {
                comets.splice(index, 1);
                if (focusedCometIndex >= index && focusedCometIndex > 0) focusedCometIndex--;
                else if (focusedCometIndex >= comets.length) focusedCometIndex = comets.length - 1;
            }
            if (comet.parentNode) comet.parentNode.removeChild(comet);
        }
        
        function createBurst(comet, points) {
            const rect = comet.getBoundingClientRect();
            const centerX = rect.left - gameAreaRect.left + rect.width / 2;
            const centerY = rect.top - gameAreaRect.top + rect.height / 2;
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const ring = document.createElement('div');
                    ring.className = 'impact-ring';
                    ring.style.left = `${centerX}px`;
                    ring.style.top = `${centerY}px`;
                    gameArea.appendChild(ring);
                    setTimeout(() => ring.remove(), 800);
                }, i * 100);
            }
            const scorePopup = document.createElement('div');
            scorePopup.className = 'score-popup';
            scorePopup.textContent = `+${points}`;
            scorePopup.style.left = `${centerX}px`;
            scorePopup.style.top = `${centerY}px`;
            gameArea.appendChild(scorePopup);
            setTimeout(() => scorePopup.remove(), 1000);
            const particleCount = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 5 : 15;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'comet-particle';
                const size = Math.random() * 8 + 4;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${centerX}px`;
                particle.style.top = `${centerY}px`;
                const angle = (Math.PI * 2 / particleCount) * i + Math.random() * 0.5;
                const distance = Math.random() * 60 + 40;
                particle.style.setProperty('--dx', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--dy', `${Math.sin(angle) * distance}px`);
                const hue = 180 + Math.random() * 60;
                particle.style.backgroundColor = `hsla(${hue}, 100%, 70%, 1)`;
                particle.style.boxShadow = `0 0 10px hsla(${hue}, 100%, 70%, 0.8)`;
                gameArea.appendChild(particle);
                setTimeout(() => particle.remove(), 1000);
            }
        }
        
        function updateComets() {
            if (!isSessionActive) return;
            const areaWidth = gameAreaRect.width;
            const areaHeight = gameAreaRect.height;
            comets.forEach((comet, index) => {
                const velX = parseFloat(comet.dataset.velX);
                const velY = parseFloat(comet.dataset.velY);
                const angle = parseFloat(comet.dataset.angle);
                let x = parseFloat(comet.style.left);
                let y = parseFloat(comet.style.top);
                x += velX; y += velY;
                comet.style.left = `${x}px`;
                comet.style.top = `${y}px`;
                comet.style.transform = `rotate(${angle}deg)`;
                const size = parseFloat(comet.style.width);
                if (x < -size * 3 || x > areaWidth + size * 3 || y < -size * 3 || y > areaHeight + size * 3) {
                    if (comet._particleInterval) clearInterval(comet._particleInterval);
                    if (comet.parentNode) gameArea.removeChild(comet);
                    comets.splice(index, 1);
                    if (focusedCometIndex >= index && focusedCometIndex > 0) focusedCometIndex--;
                    else if (focusedCometIndex >= comets.length) focusedCometIndex = comets.length - 1;
                    misses++; updateStats();
                }
            });
            if (isSessionActive) requestAnimationFrame(updateComets);
        }
        
        function saveSettings() {
            localStorage.setItem('cometSessionDuration', sessionDurationInput.value);
            localStorage.setItem('cometSize', document.getElementById('comet-size').value);
            localStorage.setItem('cometSpeed', document.getElementById('comet-speed').value);
            localStorage.setItem('cometSpawnRate', spawnRateSelect.value);
        }
        function loadSettings() {
            sessionDurationInput.value = localStorage.getItem('cometSessionDuration') || 2;
            document.getElementById('comet-size').value = localStorage.getItem('cometSize') || 'medium';
            document.getElementById('comet-speed').value = localStorage.getItem('cometSpeed') || 'medium';
            spawnRateSelect.value = localStorage.getItem('cometSpawnRate') || 'fast';
        }
        
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) event.preventDefault();
        }, { passive: false });
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) event.preventDefault();
            lastTouchEnd = now;
        }, false);
        gameContainer.addEventListener('touchmove', function(event) {
            if (isSessionActive && !settingsPanel.classList.contains('hidden')) return;
            if (isSessionActive) event.preventDefault();
        }, { passive: false });
        document.addEventListener('contextmenu', function(event) { event.preventDefault(); });
        
        /* ▶ Expose standardized hook so in-page UI can call it */
        window.endSession = endSession;
    </script>
</body>
</html>
