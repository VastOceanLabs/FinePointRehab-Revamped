<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKCCWBFKE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-RVKCCWBFKE', { 'anonymize_ip': true });
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Rhythm Reach | Cognitive Pattern Memory Game for Stroke Rehabilitation</title>
  <meta name="description" content="Rhythm Reach helps improve cognitive function and memory through engaging pattern-matching exercises. Perfect for stroke rehabilitation, memory training, and cognitive therapy at home or in clinical settings.">
  <meta name="author" content="Fine Point Rehab">

  <!-- Social -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://finepointrehab.com/exercises/rhythm-exercise.html">
  <meta property="og:title" content="Rhythm Reach | Cognitive Pattern Memory Game for Stroke Rehabilitation">
  <meta property="og:description" content="Improve cognitive function and memory with this engaging pattern-matching game designed for stroke rehabilitation and cognitive therapy.">
  <meta property="og:image" content="https://finepointrehab.com/images/rhythm-reach-preview.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Rhythm Reach | Cognitive Pattern Memory Game for Stroke Rehabilitation">
  <meta name="twitter:description" content="Improve cognitive function and memory with this engaging pattern-matching game designed for stroke rehabilitation and cognitive therapy.">
  <meta name="twitter:image" content="https://finepointrehab.com/images/rhythm-reach-preview.jpg">

  <meta name="robots" content="index, follow">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f1a2e">
  <link rel="canonical" href="https://finepointrehab.com/exercises/rhythm-exercise.html" />

  <!-- Design System -->
  <link rel="stylesheet" href="/css/tokens.css" />
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/components.css" />

  <style>
    /* Page background + layout */
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, var(--color-bg-950, #0f1a2e) 0%, #1a2744 50%, var(--color-bg-950, #0f1a2e) 100%);
      color: var(--color-text, #fff);
      overflow: hidden;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Sticky header */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: var(--space-3, 12px);
      padding: var(--space-3, 12px) var(--space-4, 16px);
      background: linear-gradient(180deg, rgba(8,15,35,.85), rgba(8,15,35,.60));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .app-header .home-link {
      text-decoration: none;
      font-weight: 600;
    }
    .app-header h1 {
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: .3px;
    }

    /* Shared two-panel layout */
    .app-main {
      display: grid;
      grid-template-columns: minmax(260px, 360px) 1fr;
      gap: var(--space-4, 16px);
      padding: var(--space-4, 16px);
      height: calc(100vh - 56px);
    }
    @media (max-width: 900px) {
      .app-main {
        grid-template-columns: 1fr;
        grid-auto-rows: max-content 1fr;
        height: auto;
      }
    }

    /* Left: Settings panel (uses .panel design system) */
    .settings.panel {
      max-height: calc(100vh - 96px);
      overflow: auto;
    }
    .settings .settings-group + .settings-group {
      margin-top: var(--space-4, 16px);
    }
    .settings .settings-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 700;
    }
    .settings .setting-description {
      font-size: .9rem;
      opacity: .85;
      margin-bottom: 8px;
    }
    .settings select,
    .settings input[type="range"] {
      width: 100%;
    }

    /* Right: HUD row + game area */
    .stage {
      position: relative;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: var(--space-4, 16px);
      height: 100%;
    }

    /* Shared starfield utility replaces custom stars */
    .starfield {
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    /* HUD row: timer + stats + controls */
    .hud.panel {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: var(--space-3, 12px);
      align-items: center;
    }
    .hud-left {
      display: grid;
      gap: var(--space-2, 8px);
    }
    .timer-bar {
      position: relative;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255,255,255,.12);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .timer-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #6fd3f5, #48c9e8);
      box-shadow: 0 2px 10px rgba(111,211,245,.5);
      transition: width .1s linear;
    }
    .stats-row {
      display: flex;
      gap: var(--space-4, 16px);
      flex-wrap: wrap;
      font-variant-numeric: tabular-nums;
    }
    .stat {
      display: grid;
      gap: 2px;
      min-width: 90px;
    }
    .stat .label {
      font-size: .8rem;
      opacity: .8;
    }
    .stat .value {
      font-weight: 800;
      font-size: 1.1rem;
      color: #6fd3f5;
    }
    .hud-right {
      display: flex;
      gap: var(--space-2, 8px);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    /* Game board */
    .game-wrap {
      position: relative;
      display: grid;
      place-items: center;
      z-index: 1;
    }
    #game-area {
      width: 320px;
      height: 320px;
      background: radial-gradient(circle at center, rgba(31, 48, 85, 0.9), rgba(20, 30, 53, 0.95));
      border: 3px solid rgba(111, 211, 245, 0.5);
      border-radius: 20px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 12px;
      padding: 15px;
      box-shadow:
        0 0 40px rgba(111, 211, 245, 0.3),
        inset 0 0 20px rgba(111, 211, 245, 0.1);
      animation: gameAreaGlow 3s ease-in-out infinite;
    }
    @keyframes gameAreaGlow {
      0%,100% { box-shadow: 0 0 40px rgba(111,211,245,.3), inset 0 0 20px rgba(111,211,245,.1); }
      50%     { box-shadow: 0 0 60px rgba(111,211,245,.5), inset 0 0 30px rgba(111,211,245,.2); }
    }

    .pad {
      background: linear-gradient(145deg, #2a3b6a, #1e2a4f);
      border: 2px solid rgba(111, 211, 245, 0.2);
      border-radius: 15px;
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      position: relative;
      display: grid;
      place-items: center;
      font-size: 26px;
      font-weight: 800;
      color: rgba(255,255,255,.35);
      overflow: hidden;
      box-shadow:
        0 4px 15px rgba(0,0,0,.3),
        inset 0 1px 0 rgba(255,255,255,.1);
    }
    .pad:hover { transform: translateY(-2px); border-color: rgba(111,211,245,.4); }
    .pad:focus { outline: 3px solid rgba(111,211,245,.9); outline-offset: 2px; }
    .pad:active { transform: scale(.96); }
    .pad.active {
      background: linear-gradient(145deg, #6fd3f5, #48c9e8);
      border-color: rgba(111, 211, 245, 0.8);
      color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 25px rgba(111,211,245,.8), inset 0 0 15px rgba(255,255,255,.3);
    }
    .pad.correct { background: linear-gradient(145deg, #2ecc71, #27ae60); border-color:#2ecc71; color:#fff; }
    .pad.incorrect { background: linear-gradient(145deg, #e74c3c, #c0392b); border-color:#e74c3c; color:#fff; }

    /* Context messages */
    #status-message, #sequence-display {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      z-index: 2;
      text-shadow: 0 2px 4px rgba(0,0,0,.3);
    }
    #status-message { top: 18%; font-size: 1.25rem; font-weight: 800; opacity: 0; transition: opacity .25s ease; }
    #sequence-display { top: 8%; font-weight: 800; color: #6fd3f5; }

    /* Completion modal (uses .panel) */
    .completion.panel {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,.35);
      z-index: 3;
    }
    .completion-card {
      width: min(560px, 92vw);
    }
    .scores {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-3, 12px);
      margin-block: var(--space-3, 12px);
      text-align: center;
    }
    .scores .score {
      padding: var(--space-3, 12px);
      border-radius: var(--radius-lg, 12px);
      background: rgba(255,255,255,.06);
    }
    .scores .score .label { font-size: .85rem; opacity: .8; }
    .scores .score .value { font-weight: 900; font-size: 1.4rem; color: #6fd3f5; }

    .xp-line {
      margin-top: var(--space-2, 8px);
      font-weight: 600;
      opacity: .9;
    }

    .hidden { display:none !important; }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    /* Mobile tweaks */
    @media (max-width: 768px) {
      #game-area { width: 290px; height: 290px; gap: 10px; padding: 12px; }
    }
  </style>
</head>
<body>
  <!-- Header & Navigation -->
  <header class="app-header">
    <a class="home-link btn btn-ghost" href="/" aria-label="Go to home">‚Üê Home</a>
    <h1>Rhythm Reach</h1>
  </header>

  <!-- Main two-panel layout -->
  <main class="app-main" role="main">
    <!-- Left panel: Settings -->
    <aside class="settings panel" id="settings-panel" aria-labelledby="settings-title">
      <h2 id="settings-title">Settings</h2>

      <section class="game-description">
        <h3>How to Play</h3>
        <p>Watch the sequence of flashing pads, then repeat it by clicking (or pressing 1‚Äì9) in the same order. Each level adds one more step.</p>
        <p>Great for memory, attention, and processing speed.</p>
      </section>

      <div class="settings-group">
        <label class="settings-label" for="difficulty">Difficulty</label>
        <div class="setting-description">Affects sequence speed and input time limit.</div>
        <select id="difficulty" aria-label="Difficulty">
          <option value="easy">Easy ‚Äî Slower pace</option>
          <option value="medium" selected>Medium ‚Äî Balanced</option>
          <option value="hard">Hard ‚Äî Fast pace</option>
        </select>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="sequence-speed">Sequence Speed</label>
        <div class="setting-description">How fast the pattern is shown (1 slow ‚Äì 10 fast)</div>
        <input id="sequence-speed" type="range" min="1" max="10" value="5" aria-valuemin="1" aria-valuemax="10" />
      </div>

      <div class="settings-group">
        <label class="settings-label" for="starting-length">Starting Sequence Length</label>
        <div class="setting-description">Steps in the first pattern (2‚Äì5)</div>
        <input id="starting-length" type="range" min="2" max="5" value="3" />
      </div>

      <div class="settings-group">
        <label class="settings-label" for="max-level">Maximum Level</label>
        <div class="setting-description">Game ends on reaching this level (5‚Äì20)</div>
        <input id="max-level" type="range" min="5" max="20" value="12" />
      </div>

      <!-- Session Flow controls (unified) -->
      <div class="settings-group" aria-label="Game controls">
        <button id="start-btn" class="btn btn-primary" type="button">Start</button>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="pause-btn" class="btn" type="button" aria-pressed="false">Pause</button>
          <button id="restart-btn" class="btn" type="button">Restart</button>
        </div>
        <p class="setting-description" style="margin-top:8px;">Shortcuts: <kbd>S</kbd> Start, <kbd>P</kbd> Pause/Resume, <kbd>R</kbd> Restart, <kbd>1‚Äì9</kbd> Pads.</p>
      </div>
    </aside>

    <!-- Right panel: HUD + game area -->
    <section class="stage" aria-label="Game stage">
      <!-- Starfield background (shared utility) -->
      <div class="starfield" data-starfield></div>

      <!-- HUD Row -->
      <div class="hud panel" role="region" aria-label="Game heads-up display">
        <div class="hud-left">
          <div class="timer-bar" aria-hidden="true"><div id="timer-fill" class="timer-fill"></div></div>
          <div class="stats-row">
            <div class="stat" aria-live="polite">
              <span class="label">Score</span>
              <span id="score-display" class="value">0</span>
            </div>
            <div class="stat" aria-live="polite">
              <span class="label">Personal Best</span>
              <span id="pb-display" class="value">0</span>
            </div>
            <div class="stat" aria-live="polite">
              <span class="label">Difficulty</span>
              <span id="diff-display" class="value">Medium</span>
            </div>
          </div>
        </div>
        <div class="hud-right">
          <!-- Mirror controls in HUD as well -->
          <button id="hud-start" class="btn btn-primary" type="button" aria-label="Start game">Start</button>
          <button id="hud-pause" class="btn" type="button" aria-label="Pause or resume">Pause</button>
          <button id="hud-restart" class="btn" type="button" aria-label="Restart game">Restart</button>
        </div>
      </div>

      <!-- Game Area -->
      <div class="game-wrap panel" role="region" aria-label="Game area">
        <div id="sequence-display" aria-live="polite"></div>
        <div id="status-message" aria-live="polite"></div>

        <div id="game-area" role="grid" aria-label="Rhythm grid">
          <button class="pad" data-pad="1" role="gridcell" aria-label="Pad 1">1</button>
          <button class="pad" data-pad="2" role="gridcell" aria-label="Pad 2">2</button>
          <button class="pad" data-pad="3" role="gridcell" aria-label="Pad 3">3</button>
          <button class="pad" data-pad="4" role="gridcell" aria-label="Pad 4">4</button>
          <button class="pad" data-pad="5" role="gridcell" aria-label="Pad 5">5</button>
          <button class="pad" data-pad="6" role="gridcell" aria-label="Pad 6">6</button>
          <button class="pad" data-pad="7" role="gridcell" aria-label="Pad 7">7</button>
          <button class="pad" data-pad="8" role="gridcell" aria-label="Pad 8">8</button>
          <button class="pad" data-pad="9" role="gridcell" aria-label="Pad 9">9</button>
        </div>
      </div>

      <!-- Completion Modal -->
      <div id="completion-overlay" class="completion panel hidden" role="dialog" aria-modal="true" aria-labelledby="completion-title">
        <div class="panel completion-card">
          <h2 id="completion-title">Great Work!</h2>
          <div class="scores" role="group" aria-label="Session results">
            <div class="score">
              <div class="label">Final Score</div>
              <div id="final-score" class="value">0</div>
            </div>
            <div class="score">
              <div class="label">Level Reached</div>
              <div id="final-level" class="value">1</div>
            </div>
            <div class="score">
              <div class="label">Best Streak</div>
              <div id="final-streak" class="value">0</div>
            </div>
          </div>
          <p id="xp-line" class="xp-line">+0 XP earned</p>
          <div id="achievement-banner" class="hidden" aria-live="polite" style="margin-top:8px;"></div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
            <button id="play-again-btn" class="btn btn-primary" type="button">Play Again</button>
            <button id="close-modal-btn" class="btn" type="button">Close</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Screen reader live region -->
  <div id="sr-announcements" class="visually-hidden" aria-live="assertive"></div>

  <!-- Progress & Achievements (root-relative) -->
  <script type="module">
    import { recordSession } from '/js/progress.js';
    import { checkAndUnlockAchievements, markExerciseTried } from '/js/achievements.js';

    const EXERCISE_ID = 'rhythm';

    // Standard endSession hook (global)
    window.endSession = function(score, difficulty = 'easy') {
      recordSession(EXERCISE_ID, difficulty, score);
      try { markExerciseTried(EXERCISE_ID); } catch (e) {}
      try { checkAndUnlockAchievements(); } catch (e) {}
    };
  </script>

  <script>
    // ---------- Game State ----------
    let gameState = {
      sequence: [],
      userSequence: [],
      level: 1,
      score: 0,
      streak: 0,
      maxStreak: 0,
      isShowingSequence: false,
      isGameActive: false,
      isPaused: false,
      settings: {
        difficulty: 'medium',
        sequenceSpeed: 5,
        startingLength: 3,
        maxLevel: 12
      }
    };

    const difficultySettings = {
      easy:   { baseSpeed: 1000, speedDecrease: 50,  inputTime: 3000, xp: 5  },
      medium: { baseSpeed:  800, speedDecrease: 75,  inputTime: 2500, xp: 8  },
      hard:   { baseSpeed:  600, speedDecrease: 100, inputTime: 2000, xp: 12 }
    };

    // ---------- DOM ----------
    const pads = document.querySelectorAll('.pad');
    const diffSelect = document.getElementById('difficulty');
    const seqSpeed = document.getElementById('sequence-speed');
    const startLen = document.getElementById('starting-length');
    const maxLevel = document.getElementById('max-level');

    const scoreDisplay = document.getElementById('score-display');
    const pbDisplay = document.getElementById('pb-display');
    const diffDisplay = document.getElementById('diff-display');
    const statusMessage = document.getElementById('status-message');
    const sequenceDisplay = document.getElementById('sequence-display');

    const timerFill = document.getElementById('timer-fill');

    const completionOverlay = document.getElementById('completion-overlay');
    const finalScore = document.getElementById('final-score');
    const finalLevel = document.getElementById('final-level');
    const finalStreak = document.getElementById('final-streak');
    const xpLine = document.getElementById('xp-line');
    const achievementBanner = document.getElementById('achievement-banner');

    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const restartBtn = document.getElementById('restart-btn');
    const hudStart = document.getElementById('hud-start');
    const hudPause = document.getElementById('hud-pause');
    const hudRestart = document.getElementById('hud-restart');
    const playAgainBtn = document.getElementById('play-again-btn');
    const closeModalBtn = document.getElementById('close-modal-btn');

    // ---------- Personal Best (local fallback) ----------
    const PB_KEY = 'pb_rhythm_v1';
    function getPB() {
      const v = Number(localStorage.getItem(PB_KEY) || 0);
      return Number.isFinite(v) ? v : 0;
    }
    function setPB(v) {
      const current = getPB();
      if (v > current) localStorage.setItem(PB_KEY, String(v));
    }
    function updatePBHUD() {
      pbDisplay.textContent = getPB().toLocaleString();
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      updatePBHUD();
      loadSettings();
      attachEvents();
      updateHUD();
    });

    function loadSettings() {
      gameState.settings = {
        difficulty: diffSelect.value,
        sequenceSpeed: parseInt(seqSpeed.value, 10),
        startingLength: parseInt(startLen.value, 10),
        maxLevel: parseInt(maxLevel.value, 10)
      };
      diffDisplay.textContent = capitalize(gameState.settings.difficulty);
    }

    function attachEvents() {
      // Pads: click & touch
      pads.forEach(pad => {
        pad.addEventListener('click', handlePadClick);
        pad.addEventListener('touchstart', (e) => { e.preventDefault(); handlePadClick({ target: pad }); }, { passive: false });
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key >= '1' && e.key <= '9') {
          const pad = document.querySelector(`[data-pad="${e.key}"]`);
          if (pad) handlePadClick({ target: pad });
        }
        if (e.key === 'S' || e.key === 's') startGame();
        if (e.key === 'P' || e.key === 'p') togglePause();
        if (e.key === 'R' || e.key === 'r') restartGame();
      });

      // Controls (settings panel)
      startBtn.addEventListener('click', startGame);
      pauseBtn.addEventListener('click', togglePause);
      restartBtn.addEventListener('click', restartGame);

      // Controls (HUD)
      hudStart.addEventListener('click', startGame);
      hudPause.addEventListener('click', togglePause);
      hudRestart.addEventListener('click', restartGame);

      // Modal
      playAgainBtn.addEventListener('click', () => { closeCompletion(); startGame(); });
      closeModalBtn.addEventListener('click', closeCompletion);

      // Settings change
      [diffSelect, seqSpeed, startLen, maxLevel].forEach(el => el.addEventListener('change', () => {
        loadSettings();
        updateHUD();
      }));
    }

    // ---------- Game Flow ----------
    function startGame() {
      loadSettings();
      gameState.sequence = [];
      gameState.userSequence = [];
      gameState.level = 1;
      gameState.score = 0;
      gameState.streak = 0;
      gameState.maxStreak = 0;
      gameState.isShowingSequence = false;
      gameState.isGameActive = true;
      gameState.isPaused = false;

      sequenceDisplay.textContent = '';
      statusMessage.style.opacity = 0;

      updateHUD();
      generateSequence();
      showSequence();
      setPausedUI(false);
    }

    function togglePause() {
      if (!gameState.isGameActive) return;
      gameState.isPaused = !gameState.isPaused;
      setPausedUI(gameState.isPaused);
      if (!gameState.isPaused && !gameState.isShowingSequence) {
        startInputTimer(); // resume timer
        showStatus('Your turn! Click the pads‚Ä¶', 'info');
      } else {
        showStatus('Paused', 'info');
      }
    }

    function setPausedUI(paused) {
      const pressed = String(paused) === 'true';
      document.getElementById('pause-btn').setAttribute('aria-pressed', paused ? 'true' : 'false');
      hudPause.setAttribute('aria-pressed', paused ? 'true' : 'false');
      pauseBtn.textContent = paused ? 'Resume' : 'Pause';
      hudPause.textContent = paused ? 'Resume' : 'Pause';
    }

    function restartGame() {
      completionOverlay.classList.add('hidden');
      startGame();
    }

    function endGame() {
      gameState.isGameActive = false;
      finalScore.textContent = gameState.score.toLocaleString();
      finalLevel.textContent = String(gameState.level);
      finalStreak.textContent = String(gameState.maxStreak);

      // XP line (simple estimate per difficulty + level)
      const xpPerLevel = difficultySettings[gameState.settings.difficulty].xp;
      const earned = Math.max(1, Math.round(xpPerLevel * (gameState.level * 0.6)));
      xpLine.textContent = `+${earned} XP earned`;

      // PB update & banner
      const prevPB = getPB();
      if (gameState.score > prevPB) {
        setPB(gameState.score);
        updatePBHUD();
        showAchievementBanner(`New Personal Best! ${gameState.score.toLocaleString()} üéâ`);
      } else {
        achievementBanner.classList.add('hidden');
      }

      // Completion modal open
      completionOverlay.classList.remove('hidden');

      // Progress & achievements (global)
      if (window.endSession) {
        window.endSession(gameState.score, gameState.settings.difficulty);
      }
    }

    function closeCompletion() {
      completionOverlay.classList.add('hidden');
    }

    // ---------- Sequence Logic ----------
    function generateSequence() {
      const length = gameState.settings.startingLength + gameState.level - 1;
      gameState.sequence = Array.from({ length }, () => Math.floor(Math.random() * 9) + 1);
    }

    function showSequence() {
      gameState.isShowingSequence = true;
      gameState.userSequence = [];

      const diffCfg = difficultySettings[gameState.settings.difficulty];
      const baseDelay = diffCfg.baseSpeed - (gameState.level * diffCfg.speedDecrease) - ((gameState.settings.sequenceSpeed - 5) * 20);
      const delay = Math.max(baseDelay, 200);

      showStatus('Watch the sequence‚Ä¶', 'info');
      sequenceDisplay.innerHTML = gameState.sequence.map(n => `<span style="display:inline-block; margin:0 2px">${n}</span>`).join(' ');

      setTimeout(() => {
        sequenceDisplay.textContent = '';
        playSequence(delay);
      }, 800);
    }

    function playSequence(delay) {
      gameState.sequence.forEach((n, i) => {
        setTimeout(() => {
          const pad = document.querySelector(`[data-pad="${n}"]`);
          flashPad(pad);

          if (i === gameState.sequence.length - 1) {
            setTimeout(() => {
              gameState.isShowingSequence = false;
              showStatus('Your turn! Click the pads‚Ä¶', 'info');
              startInputTimer();
            }, delay);
          }
        }, i * delay);
      });
    }

    function handlePadClick(e) {
      const target = e.target;
      if (!target?.dataset?.pad) return;
      if (!gameState.isGameActive || gameState.isShowingSequence || gameState.isPaused) return;

      const padNumber = parseInt(target.dataset.pad, 10);
      const expected = gameState.sequence[gameState.userSequence.length];

      flashPad(target);

      gameState.userSequence.push(padNumber);

      if (padNumber === expected) {
        target.classList.add('correct');
        setTimeout(() => target.classList.remove('correct'), 150);

        if (gameState.userSequence.length === gameState.sequence.length) {
          // Completed level
          gameState.streak++;
          gameState.maxStreak = Math.max(gameState.maxStreak, gameState.streak);
          gameState.score += Math.max(10, Math.round(gameState.level * 10 * (1 + (gameState.streak - 1) * 0.2)));

          updateHUD();
          if (gameState.level >= gameState.settings.maxLevel) {
            setTimeout(endGame, 500);
          } else {
            showStatus('Nice! Next level‚Ä¶', 'success');
            setTimeout(() => {
              gameState.level++;
              generateSequence();
              showSequence();
            }, 600);
          }
        }
      } else {
        // Mistake
        target.classList.add('incorrect');
        setTimeout(() => target.classList.remove('incorrect'), 220);
        gameState.streak = 0;
        updateHUD();
        showStatus('Oops! Try this level again‚Ä¶', 'error');
        setTimeout(() => showSequence(), 600);
      }
    }

    function flashPad(pad) {
      pad.classList.add('active');
      setTimeout(() => pad.classList.remove('active'), 220);
    }

    // ---------- Timer ----------
    let inputTimerId = null;
    function startInputTimer() {
      clearTimeout(inputTimerId);
      timerFill.style.transition = 'none';
      timerFill.style.width = '100%';

      const limit = difficultySettings[gameState.settings.difficulty].inputTime;
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          timerFill.style.transition = `width ${limit}ms linear`;
          timerFill.style.width = '0%';
        });
      });

      inputTimerId = setTimeout(() => {
        if (gameState.isGameActive && !gameState.isShowingSequence && gameState.userSequence.length < gameState.sequence.length) {
          // Time out counts as mistake
          gameState.streak = 0;
          updateHUD();
          showStatus('Time! Try again‚Ä¶', 'error');
          setTimeout(() => showSequence(), 500);
        }
      }, limit);
    }

    // ---------- HUD / UI ----------
    function updateHUD() {
      scoreDisplay.textContent = gameState.score.toLocaleString();
      diffDisplay.textContent = capitalize(gameState.settings.difficulty);
    }

    function showStatus(text, _type = 'info') {
      statusMessage.textContent = text;
      statusMessage.style.opacity = 1;
      clearTimeout(showStatus._t);
      showStatus._t = setTimeout(() => { statusMessage.style.opacity = 0; }, 1800);
    }

    function showAchievementBanner(text) {
      achievementBanner.textContent = text;
      achievementBanner.classList.remove('hidden');
      // Global achievement toast is handled centrally; this inline banner is a one-off per completion.
    }

    // ---------- Utils ----------
    function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
  </script>
</body>
</html>
