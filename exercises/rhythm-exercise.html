<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhythm Reach — Comet Look (Immersive)</title>
  <base href="/" />
  <link rel="stylesheet" href="/css/tokens.css" />
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <style>
    :root{
      --bg:#0b1020; --text:#e9eef7; --muted:#b9c3d9; --hint:#9fb0cc;
      --panel-bg:rgba(255,255,255,.06); --panel-soft:rgba(255,255,255,.04); --panel-border:rgba(255,255,255,.12);
      --accent:#8ab4f8; --aqua:#80e6ff; --btn-bg:rgba(255,255,255,.10); --btn-border:rgba(255,255,255,.20);
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    body{
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(1000px 600px at 90% 30%, rgba(255,255,255,.06), transparent 60%),
        var(--bg);
      color:var(--text); min-height:100svh; overflow:hidden;
      font-synthesis-weight:none;
    }
    .screen{display:none} .screen.active{display:block}

    header.site-header{
      position:sticky; top:0; z-index:30; backdrop-filter:blur(6px);
      background:color-mix(in oklab, var(--panel-bg) 100%, transparent);
      border-bottom:1px solid var(--panel-border); color:var(--text);
    }
    header .wrap{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem}
    .home-link{color:var(--text);text-decoration:none}
    .title{font-size:20px;font-weight:700}

    .settings-wrap{
      display:grid;grid-template-columns:minmax(300px,380px) 1fr;
      gap:16px;padding:16px;max-width:1200px;margin:0 auto;
    }
    @media (max-width:860px){.settings-wrap{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--panel-border);
      background:linear-gradient(180deg,var(--panel-bg),var(--panel-soft));
      border-radius:16px;padding:16px;color:var(--text);
    }
    .panel h2{margin:0 0 10px 0}
    .panel p,.panel li{color:var(--muted)}
    .fieldset{display:grid;gap:12px}
    .field{display:grid;gap:6px}
    label{font-weight:700;color:var(--text)}
    input,select{
      background:rgba(255,255,255,.08); color:var(--text);
      border:1px solid var(--panel-border); border-radius:10px;padding:.55rem .7rem;
    }
    .toggle{display:flex;align-items:center;gap:.5rem}
    .hint,small{color:var(--hint);font-size:.875rem}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:.7rem 1rem;border-radius:999px;border:1px solid var(--btn-border);
      background:var(--btn-bg);color:var(--text);font-weight:700;cursor:pointer;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn-primary{
      border-color:color-mix(in oklab, var(--accent) 60%, white 0%);
      background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 22%, transparent), rgba(255,255,255,.02));
    }
    .btn-ghost{background:transparent}

    #gameScreen{
      position:fixed; inset:0;
      grid-template-rows:64px 1fr; background:inherit; z-index:100;
    }
    .screen.active#gameScreen{display:grid}

    .hud{
      display:grid;grid-template-columns:1fr auto;align-items:center;
      padding:8px 12px;gap:12px;border-bottom:1px solid var(--panel-border);
      background:rgba(10,16,32,.65);backdrop-filter:blur(6px);
      font-variant-numeric:tabular-nums;
    }
    .stats{display:flex;gap:16px;align-items:center}
    .stats .label{color:var(--hint)}
    .stat strong{color:var(--text)}

    .play-area{position:relative;display:grid;place-items:center;padding:14px}
    .grid9{
      display:grid;grid-template-columns:repeat(3,1fr);
      gap:12px;width:min(90vw,720px);aspect-ratio:1/1;touch-action:manipulation;
    }
    .pad{
      border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);display:grid;place-items:center;
      font-size:28px;font-weight:800;-webkit-tap-highlight-color:transparent;user-select:none;
      color:var(--text); box-shadow:inset 0 2px 8px rgba(0,0,0,.3);
      transition:transform .06s ease;
    }
    .pad.show{outline:3px solid var(--aqua); box-shadow:0 0 22px color-mix(in oklab, var(--aqua) 60%, transparent), inset 0 2px 10px rgba(0,0,0,.35)}
    .pad.pressed{transform:scale(.98); outline:2px solid color-mix(in oklab, var(--accent) 65%, white 0%);}
    /* accessibility */
    .pad:focus-visible{outline:3px solid #8ab4f8}

    .pause-overlay{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);opacity:0;pointer-events:none;transition:opacity .2s ease}
    .pause-overlay.active{opacity:1;pointer-events:auto}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="wrap">
      <a class="home-link btn btn-ghost" href="/">← Home</a>
      <div class="title">Rhythm Reach</div>
      <div style="margin-left:auto;opacity:.85;font-size:.9rem">Comet-style shell • Rhythm controls</div>
    </div>
  </header>

  <!-- SETTINGS (visible by default) -->
  <main id="settingsScreen" class="screen active" aria-hidden="false">
    <div class="settings-wrap">
      <section class="panel" aria-labelledby="settings-title">
        <h2 id="settings-title">Settings</h2>
        <div class="fieldset">
          <div class="field">
            <label for="duration">Session Duration (minutes)</label>
            <input id="duration" type="number" min="1" max="30" value="2" />
            <div class="hint">Session ends when the timer reaches 0.</div>
          </div>

          <div class="field">
            <label for="startLen">Starting Sequence Length</label>
            <input id="startLen" type="number" min="2" max="5" value="2" />
            <div class="hint">How many pads the first pattern shows (e.g., 2).</div>
          </div>

          <div class="field">
            <label for="speed">Playback Speed</label>
            <select id="speed">
              <option value="slow">Slow</option>
              <option value="medium" selected>Medium</option>
              <option value="fast">Fast</option>
            </select>
            <div class="hint">How quickly the pads flash during the demo.</div>
          </div>

          <div class="field">
            <label for="gap">Round Gap</label>
            <select id="gap">
              <option value="2000">2.0s</option>
              <option value="1500" selected>1.5s</option>
              <option value="1000">1.0s</option>
              <option value="500">0.5s</option>
            </select>
            <div class="hint">Delay before the next round begins after you finish one.</div>
          </div>

          <div class="field toggle">
            <input id="feedback" type="checkbox" checked />
            <label for="feedback">Input Feedback (flash when I tap)</label>
          </div>

          <div class="field toggle">
            <input id="mistakes" type="checkbox" checked />
            <label for="mistakes">Mistakes Allowed (penalty −5, retry sequence)</label>
          </div>
        </div>

        <div class="actions">
          <button id="startBtn" class="btn btn-primary" type="button">Start</button>
        </div>
      </section>

      <section class="panel" aria-labelledby="howto-title">
        <h2 id="howto-title">How to play</h2>
        <p>Watch the pads light up in a sequence, then repeat the pattern by tapping the pads (or pressing 1–9 on desktop). Each round adds one new step. Keep a long streak, avoid mistakes, and finish quickly to build your score.</p>
        <ul>
          <li><strong>Score:</strong> +10 per correct tap, −5 on mistakes (if allowed).</li>
          <li><strong>Personal Best:</strong> saved locally in your browser.</li>
          <li><strong>Controls:</strong> Pause / Exit at the top; P to pause, Esc to exit.</li>
        </ul>
      </section>
    </div>
  </main>

  <!-- GAME (immersive screen) -->
  <section id="gameScreen" class="screen" aria-hidden="true">
    <div class="hud">
      <div class="stats">
        <div class="stat"><span class="label">Score:</span> <strong id="score">0</strong></div>
        <div class="stat"><span class="label">Personal Best:</span> <strong id="best">0</strong></div>
        <div class="stat"><span class="label">Time:</span> <strong id="time">00:00</strong></div>
      </div>
      <div>
        <button id="pauseBtn" class="btn btn-ghost" type="button" aria-pressed="false">Pause</button>
        <button id="exitBtn" class="btn btn-ghost" type="button">Exit</button>
      </div>
    </div>

    <div class="play-area" id="playArea">
      <div class="grid9" id="grid" aria-label="Rhythm grid" role="application">
        <button class="pad" data-id="1">1</button>
        <button class="pad" data-id="2">2</button>
        <button class="pad" data-id="3">3</button>
        <button class="pad" data-id="4">4</button>
        <button class="pad" data-id="5">5</button>
        <button class="pad" data-id="6">6</button>
        <button class="pad" data-id="7">7</button>
        <button class="pad" data-id="8">8</button>
        <button class="pad" data-id="9">9</button>
      </div>

      <div id="pauseOverlay" class="pause-overlay" aria-hidden="true">
        <div class="panel" style="text-align:center;min-width:260px">
          <h3>Paused</h3>
          <p class="hint">Tap Resume to continue.</p>
          <div class="actions" style="justify-content:center">
            <button id="resumeBtn" class="btn btn-primary" type="button">Resume</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- End Summary -->
  <dialog id="endModal" aria-labelledby="endTitle">
    <form method="dialog" class="panel" style="min-width:min(520px,92vw)">
      <h2 id="endTitle">Session Complete</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-block:10px">
        <div class="field"><label>Final Score</label><div id="finalScore"><strong>0</strong></div></div>
        <div class="field"><label>Level Reached</label><div id="finalLevel"><strong>0</strong></div></div>
        <div class="field"><label>Best Streak</label><div id="finalStreak"><strong>0</strong></div></div>
        <div class="field"><label>Time Played</label><div id="finalTime"><strong>00:00</strong></div></div>
      </div>
      <div class="actions" style="justify-content:flex-end">
        <button id="newSessionBtn" class="btn btn-primary">Start New Session</button>
        <button id="closeSummaryBtn" class="btn btn-ghost">Close</button>
      </div>
    </form>
  </dialog>

  <script>
    // ===== Helpers =====
    const qs  = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];
    const clamp = (n,a,b) => Math.max(a, Math.min(b, n));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmtTime = (ms) => {
      const total = Math.max(0, Math.floor(ms/1000));
      const m = String(Math.floor(total/60)).padStart(2,'0');
      const s = String(total % 60).padStart(2,'0');
      return `${m}:${s}`;
    };

    // ===== Elements =====
    const screens = { settings: qs('#settingsScreen'), game: qs('#gameScreen') };
    const startBtn = qs('#startBtn');
    const exitBtn  = qs('#exitBtn');
    const pauseBtn = qs('#pauseBtn');
    const resumeBtn = qs('#resumeBtn');
    const pauseOverlay = qs('#pauseOverlay');

    const durationEl = qs('#duration');
    const startLenEl = qs('#startLen');
    const speedEl    = qs('#speed');
    const gapEl      = qs('#gap');
    const feedbackEl = qs('#feedback');
    const mistakesEl = qs('#mistakes');

    const scoreEl = qs('#score');
    const bestEl  = qs('#best');
    const timeEl  = qs('#time');

    const gridEl  = qs('#grid');
    const pads    = qsa('.pad', gridEl);

    const endModal = qs('#endModal');
    const finalScore = qs('#finalScore');
    const finalLevel = qs('#finalLevel');
    const finalStreak = qs('#finalStreak');
    const finalTime = qs('#finalTime');
    const newSessionBtn = qs('#newSessionBtn');
    const closeSummaryBtn = qs('#closeSummaryBtn');

    // ===== State =====
    let running=false, paused=false, playback=false;
    let sequence=[], userIndex=0, level=0;
    let score=0, best = Number(localStorage.getItem('RR_best') || 0);
    bestEl.textContent = String(best);

    let sessionEndAt=0, timerHandle=null;
    let padMs=500, roundGap=1500, startLen=2, showFeedback=true, mistakesAllowed=true;

    // ===== Mappings =====
    const padMsFromSpeed = (v)=> v==='slow'?700 : v==='fast'?350 : 500;

    // ===== Screen switching =====
    function showScreen(which){
      Object.values(screens).forEach(s => s.classList.remove('active'));
      if(which==='settings'){
        screens.settings.classList.add('active');
        screens.settings.setAttribute('aria-hidden','false');
        screens.game.setAttribute('aria-hidden','true');
        startBtn.disabled = false;
      }else{
        screens.game.classList.add('active');
        screens.game.setAttribute('aria-hidden','false');
        screens.settings.setAttribute('aria-hidden','true');
      }
    }

    // ===== Fullscreen helpers =====
    async function goFullscreen(){ try{ await document.documentElement.requestFullscreen(); }catch{} }
    async function exitFullscreen(){ try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch{} }

    // ===== Timer =====
    function tickTimer(){
      const remaining = sessionEndAt - Date.now();
      timeEl.textContent = fmtTime(remaining);
      if(remaining <= 0){ clearInterval(timerHandle); endSession(); }
    }

    // ===== Visual helpers =====
    function flashPad(id, ms){
      const p = pads.find(x => x.dataset.id === String(id));
      if(!p) return;
      p.classList.add('show');
      setTimeout(()=> p.classList.remove('show'), Math.max(120, ms*0.8));
    }
    function pressPadVisual(id){
      if(!showFeedback) return;
      const p = pads.find(x => x.dataset.id === String(id));
      if(!p) return;
      p.classList.add('pressed');
      setTimeout(()=> p.classList.remove('pressed'), 120);
    }

    // ===== Game Logic =====
    async function playSequence(seq){
      playback = true;
      for(const id of seq){
        if(!running) return;
        while(paused){ await sleep(60); }
        flashPad(id, padMs);
        await sleep(padMs);
      }
      playback = false;
    }

    function randomPad(){ return Math.floor(Math.random()*9) + 1; }

    async function startRound(first=false){
      if(first){
        sequence = [];
        for(let i=0;i<startLen;i++) sequence.push(randomPad());
        level = 1;
      }else{
        sequence.push(randomPad());
        level += 1;
      }
      userIndex = 0;
      await playSequence(sequence);
    }

    function handleInput(id){
      if(!running || paused || playback) return;
      pressPadVisual(id);
      const expect = sequence[userIndex];
      if(id === expect){
        userIndex += 1;
        score += 10; scoreEl.textContent = String(score);
        if(userIndex >= sequence.length){
          // completed round: block input until next round begins
          playback = true;                         // <— added to block mid-gap input
          setTimeout(()=> startRound(false), roundGap);
        }
      }else{
        // mistake
        score = Math.max(0, score - 5); scoreEl.textContent = String(score);
        if(mistakesAllowed){
          userIndex = 0;
          playback = true;                         // <— added to block input during replay
          setTimeout(()=> playSequence(sequence), 400);
        }else{
          endSession();
        }
      }
    }

    // ===== Flow =====
    async function startSession(){
      if(startBtn.disabled) return;
      startBtn.disabled = true;

      // read settings
      const mins = clamp(parseInt(durationEl.value||'2',10), 1, 30);
      startLen = clamp(parseInt(startLenEl.value||'2',10), 2, 5);
      padMs    = padMsFromSpeed(speedEl.value);
      roundGap = parseInt(gapEl.value, 10);
      showFeedback    = !!feedbackEl.checked;
      mistakesAllowed = !!mistakesEl.checked;

      // reset
      running=true; paused=false; playback=false;
      score=0; scoreEl.textContent='0';
      level=0; sequence=[]; userIndex=0;

      showScreen('game'); await goFullscreen();

      // timer
      sessionEndAt = Date.now() + mins*60*1000;
      clearInterval(timerHandle);
      timerHandle = setInterval(tickTimer, 250);
      tickTimer();

      // first round uses starting length
      setTimeout(()=> startRound(true), 400);
    }

    function endSession(){
      running=false; paused=false; playback=false;
      clearInterval(timerHandle);

      // update PB
      if(score > best){ best = score; localStorage.setItem('RR_best', String(best)); bestEl.textContent = String(best); }

      finalScore.innerHTML = `<strong>${score}</strong>`;
      finalLevel.innerHTML = `<strong>${level}</strong>`;
      finalStreak.innerHTML = `<strong>${Math.max(0, level-1)}</strong>`;
      const playedMs = Math.max(0, (parseInt(durationEl.value||'2',10)*60*1000) - Math.max(0, sessionEndAt - Date.now()));
      finalTime.innerHTML = `<strong>${fmtTime(playedMs)}</strong>`;

      try{ endModal.showModal(); }catch{ alert(`Session Complete\nScore: ${score}\nLevel: ${level}`); exitToSettings(); }
    }

    function pauseToggle(force){
      if(!running) return;
      paused = (typeof force === 'boolean') ? force : !paused;
      pauseOverlay.classList.toggle('active', paused);
      pauseOverlay.setAttribute('aria-hidden', String(!paused));
      pauseBtn.setAttribute('aria-pressed', String(paused));
    }

    async function exitToSettings(){
      running=false; paused=false; playback=false;
      clearInterval(timerHandle);
      try{ screen.orientation?.unlock?.(); }catch{}
      await exitFullscreen();
      endModal.close?.();
      showScreen('settings');
    }

    // ===== Events =====
    startBtn.addEventListener('click', startSession);
    pauseBtn.addEventListener('click', () => pauseToggle());
    resumeBtn.addEventListener('click', () => pauseToggle(false));
    exitBtn.addEventListener('click', exitToSettings);

    // Pointer input (tap/click)
    pads.forEach(p=>{
      p.addEventListener('pointerdown',(e)=>{ e.preventDefault(); handleInput(parseInt(p.dataset.id,10)); }, {passive:false});
    });

    // Keyboard 1–9 + controls (no visual flash during playback)
    window.addEventListener('keydown',(e)=>{
      if(endModal.open) return;
      if(e.key==='p' || e.key==='P'){ pauseToggle(); return; }
      if(e.key==='Escape'){ exitToSettings(); return; }
      if(/^[1-9]$/.test(e.key)){
        handleInput(parseInt(e.key,10));
      }
    });

    // Summary actions
    newSessionBtn.addEventListener('click',(e)=>{ e.preventDefault(); endModal.close(); startSession(); });
    closeSummaryBtn.addEventListener('click',(e)=>{ e.preventDefault(); endModal.close(); exitToSettings(); });

    // If fullscreen drops (Android back / iOS gesture), return to settings
    document.addEventListener('fullscreenchange',()=>{ if(!document.fullscreenElement && screens.game.classList.contains('active')) exitToSettings(); });
  </script>
</body>
</html>

