<!DOCTYPE html>
<html lang="en">
<head>
  <!-- BUILD: Rhythm Reach — final fix: cancel global button backgrounds; identical glow for playback & taps — 2025-09-14 -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rhythm Reach | Fine Point Rehab</title>
  <meta name="description" content="Repeat the rhythm pattern by tapping the pads. Mobile-first, accessible therapy exercise." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Design system -->
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/exercises.css">

  <style>
    :root{
      --pad-radius: 16px;
      --halo-fast: 160ms;
      --shadow: 0 8px 24px rgba(0,0,0,0.35);
      --ease: cubic-bezier(.2,.7,.2,1);
    }

    body {
      background:
        radial-gradient(ellipse at 20% 30%, rgba(40,20,80,0.35) 0%, transparent 40%),
        radial-gradient(ellipse at 80% 70%, rgba(20,40,80,0.28) 0%, transparent 40%),
        radial-gradient(ellipse at 50% 50%, rgba(10,20,40,0.45) 0%, transparent 70%),
        linear-gradient(180deg, #0a0e1a 0%, #1a1f3a 50%, #0f1524 100%);
      min-height: 100dvh;
    }

    header.app-header {
      position: sticky; top: 0; z-index: 100; display: flex; align-items: center; gap: var(--space-4);
      padding: var(--space-3) var(--space-4);
      background: linear-gradient(180deg, rgba(8,12,26,0.90) 0%, rgba(8,12,26,0.55) 100%);
      -webkit-backdrop-filter: blur(16px); backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .home-pill { display:inline-flex; align-items:center; gap:.5rem; border:1px solid rgba(255,255,255,0.08); padding:.5rem .75rem; border-radius:999px; background: rgba(20,30,50,0.6); color:#cfe3ff; text-decoration:none; font-weight:600; transition: transform 160ms var(--ease), box-shadow 160ms var(--ease); }
    .home-pill:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    header.app-header h1 { color:#e6f2ff; font-size: var(--font-size-2xl); margin:0; letter-spacing:.2px; }
    .spacer { flex:1; }

    main { display:grid; grid-template-columns: 1fr; gap: var(--space-4); padding: var(--space-4); max-width: 1200px; margin: 0 auto; }
    @media (min-width: 900px){
      main { grid-template-columns: 360px 1fr; align-items:start; }
    }

    .card { background: linear-gradient(180deg, rgba(22,28,50,0.85) 0%, rgba(16,20,38,0.85) 100%); border:1px solid rgba(255,255,255,0.08); border-radius: 16px; box-shadow: var(--shadow); overflow:hidden; }
    .card h2 { margin:0; padding: var(--space-3) var(--space-4); font-size: var(--font-size-xl); color:#e8f1ff; border-bottom:1px solid rgba(255,255,255,0.06); background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0)); }
    .card .content { padding: var(--space-4); color:#d7e4ff; }

    .hud-row { display:flex; flex-wrap:wrap; gap: var(--space-3); align-items:center; }
    .hud-pill { background: rgba(18,26,48,0.8); border:1px solid rgba(255,255,255,0.07); border-radius: 999px; padding:.5rem .75rem; color:#e8f1ff; font-weight:600; min-width: 90px; text-align:center; }

    .pb-box { display:grid; grid-template-columns: 1fr auto; align-items:center; gap: var(--space-2); background: rgba(18,26,48,0.6); border:1px solid rgba(255,255,255,0.08); border-radius: 12px; padding:.75rem .9rem; }
    .pb-box .label { color:#a9b7d9; font-size:.9rem; }
    .pb-box .value { color:#e8f1ff; font-weight:700; font-size:1.1rem; }

    .grid { display:grid; grid-template-columns: repeat(3, minmax(72px, 1fr)); gap: clamp(10px, 3vw, 16px); justify-items: center; align-items: center; max-width: 520px; margin: 0 auto; }

    /* --------- Pads (critical overrides) --------- */

    /* Cancel UA and global button backgrounds across all states */
    button.pad,
    .pad,
    .pad:active,
    .pad:focus,
    .pad:focus-visible,
    .pad.glow,
    .pad.glow:active,
    .pad.glow:focus,
    .pad.glow:focus-visible {
      background: none !important;
      background-image: none !important;
      background-color: transparent !important;
      -webkit-appearance: none;
      appearance: none;
    }

    /* Base pad look (no solid fill) */
    .pad {
      width: 100%; aspect-ratio: 1; border-radius: var(--pad-radius);
      border:1px solid rgba(255,255,255,0.10);
      background:
        radial-gradient(120% 120% at 30% 30%, rgba(120,150,255,0.16) 0%, rgba(120,150,255,0.06) 40%, rgba(20,26,46,0.88) 70%),
        linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0));
      box-shadow: inset 0 0 0 1px rgba(140,170,255,0.15), 0 8px 18px rgba(0,0,0,0.35);
      position: relative; overflow:hidden; cursor:pointer; display:grid; place-items:center;
      color:#cfe3ff; font-weight:700; letter-spacing:.4px;
      transition: transform 120ms var(--ease), box-shadow 160ms var(--ease), border-color 160ms var(--ease);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* Soft halo lives entirely in ::after */
    .pad::after {
      content:""; position:absolute; inset:-20%; opacity:0; pointer-events:none;
      background: radial-gradient(120% 120% at 50% 50%,
                  rgba(120,170,255,0.40) 0%,
                  rgba(120,170,255,0.22) 35%,
                  rgba(120,170,255,0.06) 65%,
                  transparent 75%);
      filter: blur(10px); transform: scale(0.92);
      transition: opacity var(--halo-fast) var(--ease), transform var(--halo-fast) var(--ease);
    }
    .pad.glow {
      border-color: rgba(150,190,255,0.85) !important;
      box-shadow: inset 0 0 0 1px rgba(160,190,255,0.45), 0 0 0 2px rgba(120,170,255,0.12), 0 10px 24px rgba(60,100,200,0.55) !important;
    }
    .pad.glow::after { opacity:1; transform: scale(1); }

    /* Remove any platform focus styling that paints backgrounds */
    .pad:focus { outline: none; }
    .pad:active { transform: translateY(1px); }

    .pad.wrong { box-shadow: inset 0 0 0 1px rgba(255,120,120,0.7), 0 10px 22px rgba(255,60,60,0.45); border-color: rgba(255,140,140,0.9); }

    .controls { display:grid; gap: var(--space-3); }
    .controls label { display:grid; gap:.5rem; color:#cfe3ff; }
    .controls input, .controls select, .controls button { width:100%; }

    .btn-primary { appearance:none; border:none; border-radius: 12px; padding: .8rem 1rem; font-weight: 800; letter-spacing:.3px; cursor:pointer;
      background: linear-gradient(180deg, #4cc0ff, #1a7fd0); color:#001225; box-shadow: 0 10px 22px rgba(0,80,160,0.45), inset 0 1px 0 rgba(255,255,255,0.35);
      transition: transform 160ms var(--ease), filter 160ms var(--ease);
    }
    .btn-primary:hover { transform: translateY(-1px); filter: brightness(1.03); }
    .btn-ghost { background: transparent; color:#d7e4ff; border:1px solid rgba(255,255,255,0.12); border-radius: 12px; padding:.7rem 1rem; font-weight:700; }

    .help { color:#a9b7d9; line-height:1.5; }

    /* Screens */
    [data-screen]{ display:none; }
    [data-screen].active{ display:block; }
  </style>
</head>
<body>
  <header class="app-header">
    <a href="/" class="home-pill" aria-label="Home">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
      Home
    </a>
    <h1>Rhythm Reach</h1>
    <div class="spacer"></div>
  </header>

  <main>
    <!-- Left: Settings -->
    <section class="card" id="settings-screen" data-screen>
      <h2>Settings</h2>
      <div class="content controls">
        <div class="pb-box" aria-live="polite">
          <div class="label">Personal Best</div>
          <div class="value"><span id="best">0</span></div>
        </div>

        <label>
          <span>Starting length</span>
          <input id="startLen" type="number" min="1" max="9" value="3" inputmode="numeric">
        </label>

        <label>
          <span>Show speed</span>
          <select id="speed">
            <option value="slow">Slow</option>
            <option value="med" selected>Medium</option>
            <option value="fast">Fast</option>
          </select>
        </label>

        <label>
          <span>Round gap (ms)</span>
          <select id="roundGap">
            <option value="1200">1200</option>
            <option value="1500" selected>1500</option>
            <option value="2000">2000</option>
          </select>
        </label>

        <button class="btn-primary" id="start">Start</button>

        <div class="help">
          <p><strong>How to play:</strong> Watch the glowing tiles. After the sequence finishes, repeat it by tapping the same tiles in order.</p>
          <p>Tiles glow the same way during playback and when you tap them yourself — no solid fills.</p>
        </div>
      </div>
    </section>

    <!-- Right: Game -->
    <section class="card active" id="game-screen" data-screen>
      <h2>Game</h2>
      <div class="content">
        <div class="hud-row" style="margin-bottom: var(--space-4);">
          <div class="hud-pill">Score: <span id="score">0</span></div>
          <div class="hud-pill">Best: <span id="pb">0</span></div>
          <div class="hud-pill">Time: <span id="time">00:00</span></div>
          <div class="spacer"></div>
          <button class="btn-ghost" id="pause">Pause</button>
          <button class="btn-ghost" id="end">End</button>
        </div>

        <div class="grid" id="grid" aria-label="Rhythm pads">
          <button class="pad" data-idx="1" aria-label="Pad 1">1</button>
          <button class="pad" data-idx="2" aria-label="Pad 2">2</button>
          <button class="pad" data-idx="3" aria-label="Pad 3">3</button>
          <button class="pad" data-idx="4" aria-label="Pad 4">4</button>
          <button class="pad" data-idx="5" aria-label="Pad 5">5</button>
          <button class="pad" data-idx="6" aria-label="Pad 6">6</button>
          <button class="pad" data-idx="7" aria-label="Pad 7">7</button>
          <button class="pad" data-idx="8" aria-label="Pad 8">8</button>
          <button class="pad" data-idx="9" aria-label="Pad 9">9</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ---------- Utilities ----------
    const activeTimeouts = new Set();
    const sleep = (ms) => new Promise(res => { const t=setTimeout(()=>{activeTimeouts.delete(t);res();},ms); activeTimeouts.add(t); });
    function clearAllTimers(){ activeTimeouts.forEach(t=>clearTimeout(t)); activeTimeouts.clear(); }

    // ---------- Elements ----------
    const pads = Array.from(document.querySelectorAll('.pad'));

    const startBtn = document.getElementById('start');
    const pauseBtn = document.getElementById('pause');
    const endBtn   = document.getElementById('end');

    const startLenInput = document.getElementById('startLen');
    const speedSelect   = document.getElementById('speed');
    const roundGapSelect= document.getElementById('roundGap');

    const scoreEl = document.getElementById('score');
    const bestEl  = document.getElementById('best');
    const pbEl    = document.getElementById('pb');
    const timeEl  = document.getElementById('time');

    // ---------- Screens ----------
    function setScreen(which){
      document.querySelectorAll('[data-screen]').forEach(el => el.classList.remove('active'));
      document.getElementById(which + '-screen').classList.add('active');
    }

    // ---------- Lighting (single source of truth) ----------
    const Light = (() => {
      let lit = null;       // index (1..9) or null
      let offTO = null;

      function hardOff(){
        if(offTO){ clearTimeout(offTO); offTO = null; }
        if(lit !== null){
          pads[lit-1]?.classList.remove('glow');
          lit = null;
        }
      }

      function flash(idx, duration=500){
        return new Promise(res=>{
          hardOff();
          pads[idx-1]?.classList.add('glow');
          lit = idx;
          offTO = setTimeout(()=>{ offTO=null; hardOff(); res(); }, Math.max(80, Number(duration)||0));
        });
      }

      function off(){ hardOff(); }
      return { flash, off };
    })();

    // ---------- Game state ----------
    const LS_KEY = 'FPR_v1_rhythm_best';
    let running=false, paused=false, playingBack=false;
    let score=0, best=0, rounds=0;
    let seq=[], userIndex=0;
    let playbackToken=0;

    // Timer (simple elapsed)
    let timerId = null, startTs = 0;
    function startTimer(){
      if(timerId) clearInterval(timerId);
      startTs = Date.now();
      timerId = setInterval(() => {
        const s = Math.floor((Date.now()-startTs)/1000);
        const mm = String(Math.floor(s/60)).padStart(2,'0');
        const ss = String(s%60).padStart(2,'0');
        timeEl.textContent = `${mm}:${ss}`;
      }, 200);
    }
    function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }

    // PB
    function readPB(){
      const v = Number(localStorage.getItem(LS_KEY)||'0');
      best = Number.isFinite(v) ? v : 0;
      bestEl.textContent = best; pbEl.textContent = best;
    }
    function writePB(v){ localStorage.setItem(LS_KEY, String(v)); readPB(); }

    // Helpers
    function randPad(){ return 1 + Math.floor(Math.random()*9); }
    function clamp(v, lo, hi){ return Math.min(hi, Math.max(lo, v)); }
    function clearAllPadStates(){ pads.forEach(p => p.classList.remove('glow','wrong')); }

    // Timings shared by playback and taps
    function playbackTimings(){
      const speed = speedSelect.value;
      if(speed === 'slow') return { glow: 700, gap: 300 };
      if(speed === 'fast') return { glow: 380, gap: 160 };
      return { glow: 550, gap: 220 }; // med
    }

    // ---------- Playback ----------
    async function playSequence(){
      const myToken = ++playbackToken;
      playingBack = true;

      Light.off(); clearAllPadStates();
      const { glow, gap } = playbackTimings();
      const roundDelay = Number(roundGapSelect.value) || 1500;

      await sleep(roundDelay);
      if(myToken !== playbackToken || !running){ playingBack=false; return; }

      for(const idx of seq){
        while(paused && myToken===playbackToken && running){ await sleep(40); }
        if(myToken !== playbackToken || !running) break;

        await Light.flash(idx, glow);   // identical glow used for playback
        await sleep(gap);
      }

      Light.off();
      playingBack = false;
      userIndex = 0;
    }

    // ---------- User input (identical visual to playback) ----------
    function onUserPad(idx, pointerType='mouse'){
      if(!running || paused || playingBack) return;

      const expected = seq[userIndex];
      if(idx === expected){
        const { glow } = playbackTimings();
        Light.flash(idx, glow);                 // exact same glow as playback
        if(navigator.vibrate){ try{ navigator.vibrate(15); }catch(_){} }

        // If the page's global CSS paints focused buttons, blur after tap to avoid sticky focus styles.
        if (pointerType !== 'keyboard') {
          const el = pads[idx-1];
          // blur shortly after so screen readers still announce the press
          setTimeout(()=> el?.blur(), glow + 10);
        }

        score += 10; scoreEl.textContent = String(score);
        userIndex++;
        if(userIndex >= seq.length){
          setTimeout(() => {
            Light.off(); clearAllPadStates();
            rounds++; seq.push(randPad());
            playSequence();
          }, 500);
        }
      } else {
        // wrong feedback (brief red)
        const el = pads[idx-1]; if(el){
          el.classList.add('wrong');
          const t = setTimeout(()=>{ el.classList.remove('wrong'); activeTimeouts.delete(t); }, 280);
          activeTimeouts.add(t);
        }
        score = Math.max(0, score - 5); scoreEl.textContent = String(score);
        userIndex = 0;
      }
    }

    // Pointerdown -> prevents native :active painting and feels snappy
    pads.forEach(p => {
      p.addEventListener('pointerdown', e => {
        e.preventDefault(); // avoid native :active focus/paint on some browsers
        onUserPad(Number(p.dataset.idx), e.pointerType || 'mouse');
      });
      // Keyboard accessibility
      p.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          onUserPad(Number(p.dataset.idx), 'keyboard');
        }
      });
    });

    // ---------- Session control ----------
    function resetSessionState(){
      running=false; paused=false; playingBack=false; ++playbackToken;
      stopTimer(); clearAllTimers(); Light.off(); clearAllPadStates();
      score=0; rounds=0; seq=[]; userIndex=0;
      scoreEl.textContent='0'; timeEl.textContent='00:00';
    }

    async function startSession(){
      resetSessionState(); readPB();

      const startLen = clamp(Number(startLenInput.value)||3, 1, 9);
      for(let i=0;i<startLen;i++) seq.push(randPad());

      running = true; setScreen('game'); startTimer();
      await playSequence();
    }

    function endSession(){
      if(!running && !paused) return;
      running=false; paused=false; playingBack=false; ++playbackToken;
      stopTimer(); Light.off(); clearAllPadStates();
      if(score>best) writePB(score);
      setScreen('settings');
    }

    function togglePause(){
      if(!running) return;
      paused = !paused;
      pauseBtn.textContent = paused ? 'Resume' : 'Pause';
    }

    // Safety: kill any lingering glow when tab hides
    document.addEventListener('visibilitychange', () => { if(document.hidden){ Light.off(); } });

    // ---------- Bindings ----------
    startBtn.addEventListener('click', startSession);
    endBtn.addEventListener('click', endSession);
    pauseBtn.addEventListener('click', togglePause);

    // ---------- Init ----------
    readPB(); setScreen('settings');
  </script>
</body>
</html>
