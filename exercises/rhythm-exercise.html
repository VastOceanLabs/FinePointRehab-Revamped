<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rhythm Reach — Comet Look (Immersive)</title>
  <meta name="description" content="Rhythm Reach with Comet-style settings and immersive start." />

  <!-- Base href for consistent imports -->
  <base href="/">

  <!-- Global styles -->
  <link rel="stylesheet" href="/css/tokens.css" />
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/components.css" />

  <style>
    dialog::backdrop{background:rgba(0,0,0,.5);}
    :root {
      --hud-height: 64px;
      --pad-gap: 12px;
      --pad-radius: 14px;
    }
    body {
      background: radial-gradient(1200px 800px at 10% 10%, rgba(255,255,255,0.05), transparent 60%),
                  radial-gradient(1000px 600px at 90% 30%, rgba(255,255,255,0.06), transparent 60%),
                  var(--bg, #0b1020);
      min-height: 100svh;
      overflow: hidden;
    }
    .screen { display: none; }
    .screen.active { display: block; }

    header.site-header {
      position: sticky;
      top: 0;
      z-index: 30;
      backdrop-filter: blur(6px);
      background: color-mix(in oklab, var(--panel-bg, rgba(255,255,255,0.06)) 90%, transparent);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    header .wrap {
      display: flex; align-items: center; gap: .75rem; padding: .75rem 1rem;
    }
    .home-link { text-decoration: none; }
    .home-link .chev { margin-right: .25rem; }
    .title { font-size: clamp(18px, 2.2vw, 22px); font-weight: 600; }

    .settings-wrap {
      display: grid;
      grid-template-columns: minmax(280px, 360px) 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    @media (max-width: 860px) {
      .settings-wrap { grid-template-columns: 1fr; }
    }
    .panel {
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .panel h2 { margin: 0 0 10px 0; font-size: 1.1rem; }
    .panel p { opacity: .9; }
    .fieldset { display: grid; gap: 12px; }
    .field { display: grid; gap: 6px; }
    .field label { font-weight: 600; font-size: .95rem; }
    .field .hint { font-size: .85rem; opacity: .8; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: .7rem 1rem; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      cursor: pointer; user-select: none; text-decoration: none;
      font-weight: 600;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn-primary {
      border-color: color-mix(in oklab, var(--brand-blue, #8ab4f8) 60%, white 0%);
      background: linear-gradient(180deg, color-mix(in oklab, var(--brand-blue, #8ab4f8) 24%, transparent), rgba(255,255,255,.02));
    }
    .btn-ghost { background: transparent; }

    #gameScreen {
      position: fixed; inset: 0;
      display: grid; grid-template-rows: var(--hud-height) 1fr;
      background: inherit;
      z-index: 100;
    }
    .hud {
      display: grid; grid-template-columns: 1fr auto; align-items: center;
      padding: 8px 12px; gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: color-mix(in oklab, rgba(10,16,32,0.6) 70%, transparent);
      backdrop-filter: blur(6px);
    }
    .stats { display: flex; gap: 16px; align-items: center; font-variant-numeric: tabular-nums; }
    .stat { opacity: .95; }
    .hud-actions { display: flex; gap: 10px; }

    .play-area {
      position: relative; display: grid; place-items: center;
      padding: 14px;
    }
    .grid9 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--pad-gap);
      width: min(90vw, 720px);
      aspect-ratio: 1 / 1;
      touch-action: manipulation;
    }
    .pad {
      border-radius: var(--pad-radius);
      border: 1px solid rgba(255,255,255,.1);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: inset 0 2px 8px rgba(0,0,0,.3);
      display: grid; place-items: center;
      font-size: clamp(18px, 5.2vw, 32px);
      font-weight: 700;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }
    .pad:active { filter: brightness(1.15); }
    .pad.show {
      outline: 3px solid color-mix(in oklab, var(--brand-aqua, #80e6ff) 70%, white 0%);
      box-shadow: 0 0 22px rgba(128,230,255,.45), inset 0 2px 10px rgba(0,0,0,.35);
    }
    .pause-overlay {
      position: absolute; inset: 0; display: grid; place-items: center;
      background: color-mix(in oklab, #000 55%, transparent);
      opacity: 0; pointer-events: none; transition: opacity .2s ease;
    }
    .pause-overlay.active { opacity: 1; pointer-events: auto; }
    .pause-card {
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px; padding: 18px; text-align: center; min-width: 260px;
      box-shadow: 0 14px 24px rgba(0,0,0,.4);
    }
    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); border: 0;
    }
    .size-large .grid9 { width: min(92vw, 820px); }
    .size-medium .grid9 { width: min(90vw, 680px); }
    .size-small .grid9 { width: min(88vw, 560px); }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="wrap">
      <a class="home-link btn btn-ghost" href="/" aria-label="Back to home"><span class="chev">←</span> Home</a>
      <div class="title">Rhythm Reach</div>
      <div style="margin-left:auto;opacity:.8;font-size:.9rem">Comet-style settings • Immersive start</div>
    </div>
  </header>

  <!-- SETTINGS SCREEN -->
  <main id="settingsScreen" class="screen active">
    <div class="settings-wrap">
      <section class="panel" aria-labelledby="settings-title">
        <h2 id="settings-title">Settings</h2>
        <div class="fieldset">
          <div class="field">
            <label for="duration">Session Duration (minutes)</label>
            <input id="duration" type="number" min="1" max="30" value="2" />
            <div class="hint">How long the session runs.</div>
          </div>
          <div class="field">
            <label for="size">Comet Size</label>
            <select id="size">
              <option value="large">Large</option>
              <option value="medium" selected>Medium</option>
              <option value="small">Small</option>
            </select>
          </div>
          <div class="field">
            <label for="speed">Comet Speed</label>
            <select id="speed">
              <option value="slow">Slow</option>
              <option value="medium" selected>Medium</option>
              <option value="fast">Fast</option>
            </select>
          </div>
          <div class="field">
            <label for="spawn">Spawn Rate</label>
            <select id="spawn">
              <option value="slow">Slow (2s)</option>
              <option value="med">Medium (1.5s)</option>
              <option value="fast">Fast (1s)</option>
              <option value="vfast">Very Fast (0.5s)</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button id="startBtn" class="btn btn-primary" type="button">Start</button>
          <button id="pauseBtnSettings" class="btn btn-ghost" type="button" disabled>Pause</button>
          <button id="restartBtnSettings" class="btn btn-ghost" type="button" disabled>Restart</button>
        </div>
      </section>
      <section class="panel" aria-labelledby="howto-title">
        <h2 id="howto-title">How to play</h2>
        <p>Watch the pads light up in a sequence, then repeat the pattern.</p>
      </section>
    </div>
  </main>

  <!-- GAME SCREEN -->
  <section id="gameScreen" class="screen" aria-hidden="true">
    <div class="hud">
      <div class="stats">
        <div class="stat">Score: <span id="score">0</span></div>
        <div class="stat">Personal Best: <span id="best">0</span></div>
        <div class="stat">Time: <span id="time">00:00</span></div>
      </div>
      <div class="hud-actions">
        <button id="pauseBtn" class="btn btn-ghost" type="button">Pause</button>
        <button id="exitBtn" class="btn btn-ghost" type="button">Exit</button>
      </div>
    </div>
    <div class="play-area size-medium" id="playArea">
      <div class="grid9" id="grid">
        <button class="pad" data-id="1">1</button>
        <button class="pad" data-id="2">2</button>
        <button class="pad" data-id="3">3</button>
        <button class="pad" data-id="4">4</button>
        <button class="pad" data-id="5">5</button>
        <button class="pad" data-id="6">6</button>
        <button class="pad" data-id="7">7</button>
        <button class="pad" data-id="8">8</button>
        <button class="pad" data-id="9">9</button>
      </div>
      <div id="pauseOverlay" class="pause-overlay"><div class="pause-card"><h3>Paused</h3><button id="resumeBtn" class="btn btn-primary">Resume</button></div></div>
    </div>
  </section>

  <dialog id="endModal">
    <form method="dialog" class="panel">
      <h2>Session Complete</h2>
      <div id="finalScore">Final Score: 0</div>
      <button id="newSessionBtn" class="btn btn-primary">Start New Session</button>
      <button id="closeSummaryBtn" class="btn btn-ghost">Close</button>
    </form>
  </dialog>

  <script>
    const qs=(s,e=document)=>e.querySelector(s);
    const qsa=(s,e=document)=>[...e.querySelectorAll(s)];
    function fmtTime(ms){const t=Math.max(0,Math.floor(ms/1000));const m=String(Math.floor(t/60)).padStart(2,'0');const s=String(t%60).padStart(2,'0');return m+':'+s;}

    const screens={settings:qs('#settingsScreen'),game:qs('#gameScreen')};
    function showScreen(which){
      Object.values(screens).forEach(s=>s.classList.remove('active'));
      if(which==='settings'){
        screens.settings.classList.add('active');
        screens.settings.removeAttribute('aria-hidden');
        screens.game.setAttribute('aria-hidden','true');
        startBtn.disabled=false; // FIX: always re-enable Start here
      }else{
        screens.game.classList.add('active');
        screens.game.removeAttribute('aria-hidden');
        screens.settings.setAttribute('aria-hidden','true');
      }
    }

    const startBtn=qs('#startBtn');
    const scoreEl=qs('#score'); const bestEl=qs('#best'); const timeEl=qs('#time');
    const pauseBtn=qs('#pauseBtn'); const exitBtn=qs('#exitBtn'); const resumeBtn=qs('#resumeBtn');
    const endModal=qs('#endModal'); const finalScore=qs('#finalScore');
    let running=false,score=0,best=0,sessionEndAt=0,timeTimer;

    function updateTimer(){const r=sessionEndAt-Date.now();timeEl.textContent=fmtTime(r);if(r<=0){clearInterval(timeTimer);endSession();}}
    async function startSession(){
      running=true;score=0;scoreEl.textContent='0';
      sessionEndAt=Date.now()+2*60*1000;
      timeTimer=setInterval(updateTimer,250);
      showScreen('game');
      try{await document.documentElement.requestFullscreen();}catch{}
    }
    function endSession(){running=false;clearInterval(timeTimer);finalScore.textContent='Final Score: '+score;try{endModal.showModal();}catch{alert('Final Score: '+score);exitToSettings();}}
    function exitToSettings(){running=false;clearInterval(timeTimer);endModal.close?.();showScreen('settings');}
    function pauseToggle(){if(!running)return;}

    startBtn.addEventListener('click',startSession);
    exitBtn.addEventListener('click',exitToSettings);
    resumeBtn.addEventListener('click',()=>pauseToggle(false));
    document.addEventListener('fullscreenchange',()=>{if(!document.fullscreenElement&&screens.game.classList.contains('active'))exitToSettings();});
    newSessionBtn.addEventListener('click',()=>{endModal.close();startSession();});
    closeSummaryBtn.addEventListener('click',()=>{endModal.close();exitToSettings();});
  </script>
</body>
</html>
