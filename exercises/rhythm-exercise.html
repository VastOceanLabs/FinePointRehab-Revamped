<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rhythm Reach | Fine Point Rehab</title>
  <meta name="description" content="Repeat the rhythm pattern by tapping the pads. Mobile-first, accessible therapy exercise." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Design system -->
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/exercises.css">

  <style>
    /* ---- Page background & header (match Comet Tap) ---- */
    body {
      background:
        radial-gradient(ellipse at 20% 30%, rgba(40,20,80,0.4) 0%, transparent 40%),
        radial-gradient(ellipse at 80% 70%, rgba(20,40,80,0.3) 0%, transparent 40%),
        radial-gradient(ellipse at 50% 50%, rgba(10,20,40,0.5) 0%, transparent 70%),
        linear-gradient(180deg, #0a0e1a 0%, #1a1f3a 50%, #0f1524 100%);
      min-height: 100dvh;
    }

    header.app-header {
      position: sticky;
      top: 0;
      z-index: var(--z-nav, 100);
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-3) var(--space-4);
      background: linear-gradient(180deg, rgba(8,12,26,0.90) 0%, rgba(8,12,26,0.55) 100%);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .home-pill {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding: .5rem .9rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.30);
      color: #fff;
      text-decoration: none;
      box-shadow: 0 1px 0 rgba(255,255,255,.08) inset;
      transition: transform var(--duration-fast) var(--easing), box-shadow var(--duration-fast) var(--easing);
    }
    .home-pill:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    header.app-header h1 { color: #e6f2ff; font-size: var(--font-size-2xl); margin: 0; }

    /* Hide header while playing */
    body.playing header.app-header { display: none; }

    /* ---- Screens ---- */
    main { max-width: 960px; margin: 0 auto; padding: var(--space-4); }
    .screen { display: none; }
    .screen.active { display: block; animation: fadeIn .24s ease-out; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(8px)} to {opacity:1; transform: none} }

    /* Settings layout */
    .settings-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow);
      padding: var(--space-6);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
    }
    .settings-wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-6);
    }
    @media (max-width: 860px) {
      .settings-wrap { grid-template-columns: 1fr; }
    }
    .settings-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-4);
      margin-top: var(--space-6);
    }

    /* Metric */
    .metric {
      display: grid;
      justify-items: center;
      gap: .25rem;
      padding: .75rem 1rem;
      min-width: 110px;
      border-radius: .75rem;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(8,14,36,.35);
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
    }
    .metric .v { font-size: 1.125rem; color: #d7f2ff; text-shadow: 0 0 8px rgba(160,220,255,.7); font-weight: 700; }
    .metric .t { font-size: .75rem; opacity: .9; color: #cfe8ff; }

    /* HUD */
    .hud {
      position: sticky;
      top: 0;
      z-index: 40;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: .75rem;
      padding: .5rem .75rem;
      margin: 0 auto var(--space-3);
      border-radius: 0 0 .75rem .75rem;
      background: rgba(8,14,36,.85);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }
    .hud .spacer { flex: 1; }

    /* Pads */
    #gameArea {
      position: relative;
      width: 100%;
      margin: 0 auto;
      max-width: 700px;
      aspect-ratio: 1/1;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: .75rem;
      padding: .75rem;
      border-radius: 1rem;
      border: 1px solid rgba(255,255,255,0.09);
      background: linear-gradient(180deg, rgba(8,14,36,0.35), rgba(8,14,36,0.25));
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .pad {
      display: grid;
      place-items: center;
      user-select: none;
      touch-action: manipulation;
      border-radius: 1rem;
      border: 1px solid rgba(255,255,255,0.10);
      background: radial-gradient(circle at 30% 30%, rgba(111,211,245,.25), rgba(111,211,245,.10) 60%, rgba(255,255,255,.04) 100%);
      box-shadow: inset 0 8px 18px rgba(0,0,0,.35), 0 8px 16px rgba(0,0,0,.35);
      color: #e9fbff;
      font-size: 1.25rem;
      font-weight: 700;
      transition: transform .08s, box-shadow .12s, background .12s, border-color .12s;
      min-height: 64px;
    }
    .pad:active { transform: translateY(1px) scale(0.99); }
    .pad.glow {
      border-color: rgba(111,211,245,.65);
      background: radial-gradient(circle at 30% 30%, rgba(111,211,245,.55), rgba(111,211,245,.18) 65%, rgba(255,255,255,.08) 100%);
      box-shadow: 0 0 24px rgba(111,211,245,.6), inset 0 8px 18px rgba(0,0,0,.35);
      transform: scale(1.02);
    }
    .pad.wrong {
      animation: shake .28s;
      border-color: rgba(239,68,68,.75);
      box-shadow: 0 0 18px rgba(239,68,68,.6), inset 0 8px 18px rgba(0,0,0,.35);
    }
    @keyframes shake {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-4px); }
      40%, 60% { transform: translateX(4px); }
    }

    /* Tips/How-to panels */
    .game-description {
      background: linear-gradient(145deg, rgba(111,211,245,0.22), rgba(111,211,245,0.10));
      border-left: 4px solid rgba(111,211,245,0.85);
      color: #f4fbff;
      padding: 18px 18px 14px;
      border-radius: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.12), 0 8px 18px rgba(0,0,0,0.25);
      margin-bottom: 1rem;
    }
    .game-description h3 { color: #d7f2ff; margin: 0 0 10px; font-weight: 700; }
    .game-description p, .game-description li { color: #e9f6ff; font-size: 0.95rem; line-height: 1.55; }
    .game-description ul { margin: 0.25rem 0 0; padding-left: 1.25rem; }
    .game-description kbd {
      font-size: 0.85em;
      padding: 0.1em 0.35em;
      border-radius: 6px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.18);
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>
  <header class="app-header">
    <a class="home-pill" href="/">← Home</a>
    <h1>Rhythm Reach</h1>
  </header>

  <main id="main">
    <!-- Settings Screen -->
    <section id="settingsScreen" class="screen active">
      <div class="settings-wrap">
        <section class="settings-card">
          <div class="game-description">
            <h3>How to play</h3>
            <p>Watch the pads light in a sequence, then repeat the pattern by tapping the pads (or pressing 1–9).</p>
          </div>
          <div class="metric"><div id="pbSetting" class="v">0</div><div class="t">Personal Best</div></div>
          <div class="settings-actions">
            <button id="startBtn" class="btn btn-primary btn-xl">Start</button>
          </div>
        </section>
        <section class="settings-card">
          <h3>Session Options</h3>
          <label>Session Duration <input id="minutes" type="number" value="2"></label>
          <label>Starting Sequence Length <input id="startLen" type="number" value="3"></label>
          <label>Playback Speed
            <select id="speed"><option value="slow">Slow</option><option value="med" selected>Medium</option><option value="fast">Fast</option></select>
          </label>
          <label>Round Gap
            <select id="roundGap"><option value="2000">2s</option><option value="1500" selected>1.5s</option><option value="1000">1s</option></select>
          </label>
          <div class="game-description">
            <h3>Tips</h3>
            <ul><li>Keyboard: press 1–9</li><li>Pause: press P</li><li>Exit: press Esc</li></ul>
          </div>
        </section>
      </div>
    </section>

    <!-- Game Screen -->
    <section id="gameScreen" class="screen">
      <div class="hud">
        <div class="metric"><div id="score" class="v">0</div><div class="t">Score</div></div>
        <div class="metric"><div id="best" class="v">0</div><div class="t">Best</div></div>
        <div class="metric"><div id="time" class="v">00:00</div><div class="t">Time</div></div>
        <div class="spacer"></div>
        <button id="pauseBtn" class="btn btn-ghost">Pause</button>
        <button id="exitBtn" class="btn btn-ghost">Exit</button>
      </div>
      <div id="gameArea">
        <button class="pad" data-idx="1">1</button>
        <button class="pad" data-idx="2">2</button>
        <button class="pad" data-idx="3">3</button>
        <button class="pad" data-idx="4">4</button>
        <button class="pad" data-idx="5">5</button>
        <button class="pad" data-idx="6">6</button>
        <button class="pad" data-idx="7">7</button>
        <button class="pad" data-idx="8">8</button>
        <button class="pad" data-idx="9">9</button>
      </div>
    </section>
  </main>

  <!-- Pause Overlay -->
  <div id="pauseOverlay"><div><button id="resumeBtn">Resume</button><button id="exitOverlayBtn">Exit</button></div></div>
  <!-- Done Dialog -->
  <div id="doneDialog"><div><h2>Session Complete</h2><div id="finalScore"></div><div id="finalRounds"></div><button id="newSessionBtn">New</button></div></div>

  <script>
  (function(){
    const pads = Array.from(document.querySelectorAll('.pad'));
    const scoreEl=document.getElementById('score'),bestEl=document.getElementById('best'),timeEl=document.getElementById('time'),pbSettingEl=document.getElementById('pbSetting');
    let running=false,paused=false,playback=false,score=0,best=0,rounds=0,timer=null,endTime=0,seq=[],userIndex=0;
    const glowTimers=new Map(),LS_KEY='FPR_v1_RhythmReach_PB';
    function clearGlow(i){const t=glowTimers.get(i);if(t){clearTimeout(t);glowTimers.delete(i);}pads[i-1]?.classList.remove('glow');}
    function clearAll(){glowTimers.forEach(t=>clearTimeout(t));glowTimers.clear();pads.forEach(p=>p.classList.remove('glow','wrong'));}
    function glowPad(i,d){clearGlow(i);const el=pads[i-1];if(!el)return;el.classList.add('glow');const to=setTimeout(()=>{el.classList.remove('glow');glowTimers.delete(i);},d);glowTimers.set(i,to);}
    function wrongPad(i){clearGlow(i);const el=pads[i-1];if(!el)return;el.classList.add('wrong');setTimeout(()=>el.classList.remove('wrong'),280);}
    function rand(){return 1+Math.floor(Math.random()*9);}
    function format(ms){const s=Math.floor(ms/1000),m=Math.floor(s/60),sec=s%60;return(m<10?'0':'')+m+':'+(sec<10?'0':'')+sec;}
    function startTimer(min){endTime=Date.now()+min*60000;timer=setInterval(()=>{if(!running||paused)return;const left=endTime-Date.now();timeEl.textContent=format(left);if(left<=0)end();},200);}
    function stopTimer(){clearInterval(timer);timer=null;}
    function playSeq(){return new Promise(async r=>{playback=true;clearAll();await new Promise(x=>setTimeout(x,1500));for(const i of seq){if(!running)break;while(paused)await new Promise(x=>setTimeout(x,50));glowPad(i,500);await new Promise(x=>setTimeout(x,700));}playback=false;userIndex=0;r();});}
    function readPB(){best=+localStorage.getItem(LS_KEY)||0;bestEl.textContent=pbSettingEl.textContent=best;}
    function savePB(){if(score>best){best=score;localStorage.setItem(LS_KEY,best);bestEl.textContent=pbSettingEl.textContent=best;}}
    function start(){running=true;score=0;seq=[rand(),rand(),rand()];document.body.classList.add('playing');readPB();startTimer(2);playSeq();}
    function end(){running=false;paused=false;stopTimer();clearAll();savePB();}
    pads.forEach(p=>p.addEventListener('click',()=>{if(!running||paused||playback)return;const i=+p.dataset.idx;if(i===seq[userIndex]){glowPad(i,180);score+=10;scoreEl.textContent=score;userIndex++;if(userIndex>=seq.length){rounds++;seq.push(rand());playSeq();}}else{wrongPad(i);score=Math.max(0,score-5);scoreEl.textContent=score;userIndex=0;}}));
    document.getElementById('startBtn').onclick=start;
  })();
  </script>
</body>
</html>
