<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKCCWBFKE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RVKCCWBFKE');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Visual Scanner Exercise | Fine Point Rehab</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Interactive visual scanning exercise for improving visual attention, field of vision, and visual search skills. Ideal for stroke rehabilitation, brain injury recovery, and treatment of hemianopia or visual neglect. Evidence-based therapy for occupational therapy and neurological rehabilitation.">
    <link rel="canonical" href="https://finepointrehab.com/visual-scanner-exercise">
    
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Visual Scanner Exercise | Fine Point Rehab">
    <meta property="og:description" content="Interactive visual scanning exercise for improving visual attention, field of vision, and visual search skills. Evidence-based therapy for neurological rehabilitation.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://finepointrehab.com/visual-scanner-exercise">
    <meta property="og:image" content="https://finepointrehab.com/images/visual-scanner-preview.jpg">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            background: #121d33;
            color: white;
            min-height: 100vh;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #scan-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1c2a4e;
            border: 2px solid rgba(111, 211, 245, 0.9);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(111, 211, 245, 0.3);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .visual-object {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .visual-object:hover {
            transform: scale(1.05);
        }
        
        .visual-object.target {
            background-color: rgba(111, 211, 245, 0.3);
        }
        
        .visual-object.found {
            animation: foundAnimation 0.5s ease-out;
            background-color: rgba(46, 204, 113, 0.5);
        }
        
        @keyframes foundAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); background-color: rgba(46, 204, 113, 0.7); }
            100% { transform: scale(1); }
        }
        
        #target-display {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(8, 15, 35, 0.85);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 20;
            text-align: center;
            transition: opacity 0.3s ease;
        }
        
        #target-display h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: rgba(111, 211, 245, 1);
        }
        
        #target-icon {
            font-size: 36px;
            background-color: rgba(111, 211, 245, 0.2);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        
        #settings-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(8, 15, 35, 0.95);
            border-radius: 15px;
            padding: 25px 25px 40px 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1);
            z-index: 100;
            width: 80%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 85vh;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom, 40px);
        }
        
        #settings-panel h2 {
            text-align: center;
            color: white;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 24px;
            letter-spacing: 0.5px;
        }
        
        .game-description {
            background-color: rgba(111, 211, 245, 0.1);
            border: 1px solid rgba(111, 211, 245, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .game-description h3 {
            color: rgba(111, 211, 245, 1);
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .game-description p {
            margin: 0 0 12px 0;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .game-description p:last-child {
            margin-bottom: 0;
        }
        
        #home-button {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background-color: rgba(111, 211, 245, 0.8);
            color: #121d33;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 90;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #home-button:hover {
            background-color: rgba(111, 211, 245, 1);
            transform: translateY(-2px);
        }
        
        .settings-group {
            margin-bottom: 20px;
        }
        
        .settings-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: white;
            font-size: 16px;
        }
        
        .settings-description {
            display: block;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.4;
        }
        
        select, input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 16px;
            background-color: rgba(0, 10, 30, 0.8);
            color: white;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: rgba(111, 211, 245, 0.8);
            box-shadow: 0 0 0 2px rgba(111, 211, 245, 0.3);
        }
        
        button {
            background-color: rgba(111, 211, 245, 0.9);
            color: #121d33;
            border: none;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        button:hover {
            background-color: rgba(111, 211, 245, 1);
            transform: translateY(-2px);
        }
        
        #stats-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(8, 15, 35, 0.8);
            padding: 15px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        
        .stat-box {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: rgba(111, 211, 245, 1);
        }
        
        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        #timer-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 8px;
            background-color: rgba(111, 211, 245, 0.9);
            width: 100%;
            z-index: 20;
        }
        
        .hidden {
            display: none !important;
        }
        
        #completion-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(8, 15, 35, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1);
            text-align: center;
            max-width: 80%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }
        
        #completion-message h2 {
            color: white;
            margin-top: 0;
        }
        
        #completion-scores {
            margin: 20px 0;
            font-size: 18px;
        }
        
        .score-highlight {
            color: rgba(111, 211, 245, 1);
            font-weight: bold;
        }
        
        #stars-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            overflow: hidden;
            pointer-events: none;
        }
        
        .star {
            position: absolute;
            background-color: white;
            width: 2px;
            height: 2px;
            border-radius: 50%;
            opacity: 0.4;
        }
        
        .focus-area {
            position: absolute;
            border: 2px dashed rgba(111, 211, 245, 0.4);
            border-radius: 15px;
            z-index: 5;
            opacity: 0.5;
            pointer-events: none;
        }
        
        @media (prefers-reduced-motion: reduce) {
            .visual-object {
                transition: none;
            }
            
            .visual-object.found {
                animation: none;
            }
        }
        
        @media (max-width: 768px) {
            .stat-value {
                font-size: 20px;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            #target-display {
                padding: 10px 15px;
            }
            
            #target-display h3 {
                font-size: 16px;
            }
            
            #target-icon {
                font-size: 30px;
                width: 50px;
                height: 50px;
            }
            
            #settings-panel {
                width: 90%;
                max-width: none;
                padding: 20px 20px 80px 20px;
                max-height: 80vh;
                top: 45%;
                padding-bottom: max(80px, env(safe-area-inset-bottom, 80px));
            }
            
            .game-description {
                padding: 15px;
            }
            
            button {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="stars-container"></div>
        <div id="timer-bar"></div>
        
        <div id="target-display" role="status" aria-live="polite" class="hidden">
            <h3>Find This Object</h3>
            <div id="target-icon">🔍</div>
        </div>
        
        <div id="scan-area"></div>
        
        <button id="home-button" type="button" aria-label="Go to home">Home</button>
        
        <div id="settings-panel">
            <h2>Visual Scanner Exercise</h2>
            
            <div class="game-description">
                <h3>How It Works</h3>
                <p>This exercise helps improve your visual scanning and attention skills. Multiple objects will appear on screen, and you need to find and click the specific target object shown at the top.</p>
                <p>Each time you find the correct object, a new target will appear. Try to find objects as quickly and accurately as possible!</p>
                <p>This exercise is helpful for improving visual field awareness, attention, and search skills after stroke or brain injury.</p>
            </div>
            
            <div class="settings-group">
                <label class="settings-label">Difficulty:</label>
                <span class="settings-description">Choose how many objects appear on screen. More objects make it harder to find the target.</span>
                <select id="difficulty">
                    <option value="easy">Easy (Fewer Objects)</option>
                    <option value="medium" selected>Medium</option>
                    <option value="hard">Hard (Many Objects)</option>
                </select>
            </div>
            
            <div class="settings-group">
                <label class="settings-label">Focus Area:</label>
                <span class="settings-description">Practice scanning specific areas of your vision. Useful for working on visual field deficits.</span>
                <select id="focus-area">
                    <option value="none">None (Full Field)</option>
                    <option value="left">Left Visual Field</option>
                    <option value="right">Right Visual Field</option>
                    <option value="top">Upper Visual Field</option>
                    <option value="bottom">Lower Visual Field</option>
                </select>
            </div>
            
            <div class="settings-group">
                <label class="settings-label">Object Type:</label>
                <span class="settings-description">Choose what type of objects to search for during the exercise.</span>
                <select id="object-type">
                    <option value="shapes" selected>Shapes</option>
                    <option value="letters">Letters</option>
                    <option value="numbers">Numbers</option>
                    <option value="emoji">Emoji</option>
                </select>
            </div>
            
            <div class="settings-group">
                <label class="settings-label">Session Duration (minutes):</label>
                <span class="settings-description">How long you want to practice. Start with shorter sessions and work your way up.</span>
                <input type="number" id="session-duration" min="1" max="10" value="3">
            </div>
            
            <button id="start-session" type="button">Start Therapy Session</button>
        </div>
        
        <div id="stats-panel" class="hidden">
            <div class="stat-box">
                <div id="score" class="stat-value">0</div>
                <div class="stat-label">Score</div>
            </div>
            <div class="stat-box">
                <div id="found" class="stat-value">0</div>
                <div class="stat-label">Objects Found</div>
            </div>
            <div class="stat-box">
                <div id="time-left" class="stat-value">3:00</div>
                <div class="stat-label">Time Left</div>
            </div>
            <div class="stat-box">
                <div id="avg-time" class="stat-value">0.0s</div>
                <div class="stat-label">Avg. Search Time</div>
            </div>
        </div>
        
        <div id="completion-message" class="hidden">
            <h2>Session Complete!</h2>
            <div id="completion-scores">
                <p>Final Score: <span id="final-score" class="score-highlight">0</span></p>
                <p>Objects Found: <span id="final-found" class="score-highlight">0</span></p>
                <p>Average Search Time: <span id="final-avg-time" class="score-highlight">0.0s</span> seconds</p>
            </div>
            <button id="restart-button" type="button">Start New Session</button>
        </div>
    </div>
    
    <!-- SESSION ENHANCEMENT + GAMIFICATION INTEGRATION -->
    <script type="module">
        // Core utils and session enhancement - UPDATED TO ROOT-RELATIVE IMPORTS
        import { storage, starfield, theme, viewport, audio, initUtils } from '/js/utils.js';
        import { sessionEnhancement } from '/js/session-enhancement.js';

        // Initialize utils
        initUtils();
        
        // Safe localStorage helpers for private mode compatibility
        function safeGet(key, fallback = null) {
            try {
                return localStorage.getItem(key) ?? fallback;
            } catch {
                return fallback;
            }
        }
        
        function safeSet(key, val) {
            try {
                localStorage.setItem(key, val);
            } catch {
                // Silent fail in private mode
            }
        }
        
        // Exercise identity
        const currentExerciseId = 'visual-scanner';
        
        function getCurrentDifficulty() {
            const difficultySelect = document.getElementById('difficulty');
            return difficultySelect ? difficultySelect.value : 'medium';
        }
        
        // Initialize with current settings
        sessionEnhancement.initializeExercise(currentExerciseId, getCurrentDifficulty());
        
        // Re-initialize when difficulty changes
        const difficultySelect = document.getElementById('difficulty');
        if (difficultySelect) {
            difficultySelect.addEventListener('change', () => {
                sessionEnhancement.initializeExercise(currentExerciseId, getCurrentDifficulty());
            });
        }
        
        // Game elements
        const gameContainer = document.getElementById('game-container');
        const scanArea = document.getElementById('scan-area');
        const timerBar = document.getElementById('timer-bar');
        const settingsPanel = document.getElementById('settings-panel');
        const statsPanel = document.getElementById('stats-panel');
        const completionMessage = document.getElementById('completion-message');
        const starsContainer = document.getElementById('stars-container');
        const targetDisplay = document.getElementById('target-display');
        const targetIcon = document.getElementById('target-icon');
        
        // Create stars for background effect
        const starsCount = 50;
        for (let i = 0; i < starsCount; i++) {
            const star = document.createElement('div');
            star.classList.add('star');
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            const size = Math.random() * 2 + 0.5;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.opacity = Math.random() * 0.4 + 0.1;
            starsContainer.appendChild(star);
        }
        
        // Settings elements
        const focusAreaSelect = document.getElementById('focus-area');
        const objectTypeSelect = document.getElementById('object-type');
        const sessionDurationInput = document.getElementById('session-duration');
        const startSessionButton = document.getElementById('start-session');
        const restartButton = document.getElementById('restart-button');
        
        // Stats elements
        const scoreElement = document.getElementById('score');
        const foundElement = document.getElementById('found');
        const timeLeftElement = document.getElementById('time-left');
        const avgTimeElement = document.getElementById('avg-time');
        
        // Completion elements
        const finalScoreElement = document.getElementById('final-score');
        const finalFoundElement = document.getElementById('final-found');
        const finalAvgTimeElement = document.getElementById('final-avg-time');
        
        // Game state variables
        let isSessionActive = false;
        let sessionDuration = 3 * 60 * 1000; // 3 minutes in milliseconds
        let timeRemaining = 0;
        let timerInterval = null;
        let score = 0;
        let objectsFound = 0;
        let totalSearchTime = 0;
        let lastTargetTime = 0;
        let currentTarget = null;
        let visualObjects = [];
        
        // Home button functionality
        document.getElementById('home-button').addEventListener('click', function() {
            window.location.href = '../index.html';
        });
        
        // Start new session
        startSessionButton.addEventListener('click', startSession);
        restartButton.addEventListener('click', () => {
            completionMessage.classList.add('hidden');
            settingsPanel.classList.remove('hidden');
        });
        
        // Object libraries
        const objectLibraries = {
            shapes: ['●', '■', '▲', '◆', '★', '◐', '○', '□', '△', '◇', '☆', '▣', '▬', '▮', '◎', '◉', '◑', '◒', '◕'],
            letters: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T'],
            numbers: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '11', '22', '33', '44', '55', '66', '77', '88', '99'],
            emoji: ['🔍', '⚡', '🔓', '🔒', '🌟', '🎯', '🏆', '💡', '🎮', '🎨', '📌', '⏰', '📊', '🚀', '🎊', '🔎', '🔍', '📢', '🔮']
        };
        
        // Difficulty settings
        const difficultySetting = {
            easy: { objectCount: 10, minSize: 50, maxSize: 70 },
            medium: { objectCount: 20, minSize: 40, maxSize: 60 },
            hard: { objectCount: 30, minSize: 30, maxSize: 50 }
        };
        
        function startSession() {
            // Get settings
            const difficulty = difficultySelect.value;
            const focusArea = focusAreaSelect.value;
            const objectType = objectTypeSelect.value;
            sessionDuration = parseInt(sessionDurationInput.value) * 60 * 1000;
            
            // Reset game state
            score = 0;
            objectsFound = 0;
            totalSearchTime = 0;
            timeRemaining = sessionDuration;
            visualObjects = [];
            
            // Set up scan area size based on window size
            const areaWidth = Math.min(700, window.innerWidth * 0.9);
            const areaHeight = Math.min(500, window.innerHeight * 0.7);
            scanArea.style.width = `${areaWidth}px`;
            scanArea.style.height = `${areaHeight}px`;
            
            // Create visual objects
            createVisualObjects(difficulty, objectType, focusArea);
            
            // Update UI
            updateStats();
            updateTimer();
            
            // Hide settings, show stats and target
            settingsPanel.classList.add('hidden');
            statsPanel.classList.remove('hidden');
            targetDisplay.classList.remove('hidden');
            
            // Start session
            isSessionActive = true;
            setNewTarget();
            
            // Clear any existing timer and start new one
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining -= 100;
                
                // Update timer bar with clamping to prevent negative width
                const progress = Math.max(0, timeRemaining / sessionDuration);
                timerBar.style.width = `${progress * 100}%`;
                
                // Update time display
                updateTimer();
                
                // Check if session is over
                if (timeRemaining <= 0) {
                    endSessionInternal();
                }
            }, 100);
        }
        
        function createVisualObjects(difficulty, objectType, focusArea) {
            // Clear existing objects
            scanArea.innerHTML = '';
            if (focusArea !== 'none') {
                const focusElement = document.createElement('div');
                focusElement.className = 'focus-area';
                
                const areaWidth = parseInt(scanArea.style.width);
                const areaHeight = parseInt(scanArea.style.height);
                
                switch (focusArea) {
                    case 'left':
                        focusElement.style.left = '10px';
                        focusElement.style.top = '10px';
                        focusElement.style.width = `${areaWidth / 2 - 20}px`;
                        focusElement.style.height = `${areaHeight - 20}px`;
                        break;
                    case 'right':
                        focusElement.style.left = `${areaWidth / 2 + 10}px`;
                        focusElement.style.top = '10px';
                        focusElement.style.width = `${areaWidth / 2 - 20}px`;
                        focusElement.style.height = `${areaHeight - 20}px`;
                        break;
                    case 'top':
                        focusElement.style.left = '10px';
                        focusElement.style.top = '10px';
                        focusElement.style.width = `${areaWidth - 20}px`;
                        focusElement.style.height = `${areaHeight / 2 - 20}px`;
                        break;
                    case 'bottom':
                        focusElement.style.left = '10px';
                        focusElement.style.top = `${areaHeight / 2 + 10}px`;
                        focusElement.style.width = `${areaWidth - 20}px`;
                        focusElement.style.height = `${areaHeight / 2 - 20}px`;
                        break;
                }
                
                scanArea.appendChild(focusElement);
            }
            
            // Get difficulty settings
            const settings = difficultySetting[difficulty];
            
            // Get available area dimensions
            const areaWidth = parseInt(scanArea.style.width);
            const areaHeight = parseInt(scanArea.style.height);
            
            // Get objects library
            const objects = objectLibraries[objectType].slice();
            
            // Shuffle objects
            shuffleArray(objects);
            
            // Create visual objects
            for (let i = 0; i < settings.objectCount; i++) {
                // Create object element
                const obj = document.createElement('div');
                obj.className = 'visual-object';
                obj.dataset.index = i;
                
                // Set size (random within range)
                const size = Math.floor(Math.random() * (settings.maxSize - settings.minSize + 1)) + settings.minSize;
                obj.style.width = `${size}px`;
                obj.style.height = `${size}px`;
                
                // Set symbol (repeat if necessary)
                const symbolIndex = i % objects.length;
                obj.textContent = objects[symbolIndex];
                obj.dataset.symbol = objects[symbolIndex];
                
                // Set color
                const hue = Math.random() * 360;
                obj.style.color = `hsl(${hue}, 70%, 70%)`;
                
                // Set position based on focus area with safety checks
                let x, y;
                let validPosition = false;
                let attempts = 0;
                const maxAttempts = 100; // Prevent infinite loops
                
                // Calculate available space for focus areas
                let availableWidth = areaWidth - size;
                let availableHeight = areaHeight - size;
                let minX = 0;
                let minY = 0;
                
                // Adjust available space based on focus area
                if (focusArea === 'left') {
                    availableWidth = Math.max(10, (areaWidth / 2) - size - 10);
                    if (availableWidth <= 0) {
                        // Fallback to full area if left area is too small
                        availableWidth = areaWidth - size;
                        focusArea = 'none';
                    }
                } else if (focusArea === 'right') {
                    availableWidth = Math.max(10, (areaWidth / 2) - size - 10);
                    minX = areaWidth / 2 + 10;
                    if (availableWidth <= 0) {
                        // Fallback to full area if right area is too small
                        availableWidth = areaWidth - size;
                        minX = 0;
                        focusArea = 'none';
                    }
                } else if (focusArea === 'top') {
                    availableHeight = Math.max(10, (areaHeight / 2) - size - 10);
                    if (availableHeight <= 0) {
                        // Fallback to full area if top area is too small
                        availableHeight = areaHeight - size;
                        focusArea = 'none';
                    }
                } else if (focusArea === 'bottom') {
                    availableHeight = Math.max(10, (areaHeight / 2) - size - 10);
                    minY = areaHeight / 2 + 10;
                    if (availableHeight <= 0) {
                        // Fallback to full area if bottom area is too small
                        availableHeight = areaHeight - size;
                        minY = 0;
                        focusArea = 'none';
                    }
                }
                
                while (!validPosition && attempts < maxAttempts) {
                    attempts++;
                    
                    // Generate random position within available space
                    x = minX + Math.random() * availableWidth;
                    y = minY + Math.random() * availableHeight;
                    
                    // Ensure position is within bounds
                    x = Math.max(0, Math.min(x, areaWidth - size));
                    y = Math.max(0, Math.min(y, areaHeight - size));
                    
                    // Check for overlap with existing objects
                    validPosition = true;
                    for (const existingObj of visualObjects) {
                        const existingX = parseInt(existingObj.style.left);
                        const existingY = parseInt(existingObj.style.top);
                        const existingSize = parseInt(existingObj.style.width);
                        
                        // Calculate distance between centers
                        const distance = Math.sqrt(
                            Math.pow(x + size/2 - (existingX + existingSize/2), 2) +
                            Math.pow(y + size/2 - (existingY + existingSize/2), 2)
                        );
                        
                        // Check if objects overlap (with padding)
                        if (distance < (size + existingSize) / 2 + 5) {
                            validPosition = false;
                            break;
                        }
                    }
                    
                    // If we've tried many times, reduce overlap requirement
                    if (attempts > 50) {
                        validPosition = true;
                        for (const existingObj of visualObjects) {
                            const existingX = parseInt(existingObj.style.left);
                            const existingY = parseInt(existingObj.style.top);
                            const existingSize = parseInt(existingObj.style.width);
                            
                            // More lenient overlap check
                            const distance = Math.sqrt(
                                Math.pow(x + size/2 - (existingX + existingSize/2), 2) +
                                Math.pow(y + size/2 - (existingY + existingSize/2), 2)
                            );
                            
                            if (distance < (size + existingSize) / 2) {
                                validPosition = false;
                                break;
                            }
                        }
                    }
                }
                
                // If still no valid position found, place anyway
                if (!validPosition) {
                    x = minX + Math.random() * availableWidth;
                    y = minY + Math.random() * availableHeight;
                    x = Math.max(0, Math.min(x, areaWidth - size));
                    y = Math.max(0, Math.min(y, areaHeight - size));
                }
                
                // Set position
                obj.style.left = `${x}px`;
                obj.style.top = `${y}px`;
                
                // Add click handler
                obj.addEventListener('click', handleObjectClick);
                
                // Add to scan area and objects array
                scanArea.appendChild(obj);
                visualObjects.push(obj);
            }
        }
        
        function setNewTarget() {
            if (!isSessionActive) return;
            
            // Select a random target that hasn't been found yet
            const availableObjects = visualObjects.filter(obj => !obj.classList.contains('found'));
            
            if (availableObjects.length === 0) {
                // All objects found, end session
                endSessionInternal();
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * availableObjects.length);
            
            // Remove target class from previous target
            if (currentTarget) {
                currentTarget.classList.remove('target');
            }
            
            currentTarget = availableObjects[randomIndex];
            
            // Optional: Add subtle highlight to guide users (remove this line if too easy)
            // currentTarget.classList.add('target');
            
            // Update target display
            targetIcon.textContent = currentTarget.dataset.symbol;
            targetIcon.style.color = currentTarget.style.color;
            
            // Start timing
            lastTargetTime = Date.now();
        }
        
        function handleObjectClick(e) {
            if (!isSessionActive) return;
            
            const clickedSymbol = e.target.dataset.symbol;
            const targetSymbol = currentTarget.dataset.symbol;
            
            if (clickedSymbol === targetSymbol && !e.target.classList.contains('found')) {
                // Correct object found
                const now = Date.now();
                const searchTime = now - lastTargetTime;
                totalSearchTime += searchTime;
                
                // Update score based on search time (faster = more points)
                const basePoints = 100;
                const timeBonus = Math.max(0, Math.floor((5000 - searchTime) / 100));
                const points = basePoints + timeBonus;
                score += points;
                objectsFound++;
                
                // Update stats
                updateStats();
                
                // Mark object as found
                e.target.classList.add('found');
                
                // Set new target after a short delay
                setTimeout(() => {
                    setNewTarget();
                }, 500);
            }
        }
        
        function updateStats() {
            scoreElement.textContent = score;
            foundElement.textContent = objectsFound;
            
            // Calculate and display average search time
            const avgTime = objectsFound > 0 ? (totalSearchTime / objectsFound / 1000).toFixed(1) : '0.0';
            avgTimeElement.textContent = avgTime + 's';
        }
        
        function updateTimer() {
            const minutes = Math.floor(timeRemaining / 60000);
            const seconds = Math.floor((timeRemaining % 60000) / 1000);
            timeLeftElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function endSessionInternal() {
            clearInterval(timerInterval);
            isSessionActive = false;
            
            // Calculate final stats
            const avgSearchTime = objectsFound > 0 ? (totalSearchTime / objectsFound / 1000).toFixed(2) : '0.00';
            
            // SESSION ENHANCEMENT INTEGRATION: Handle session completion
            sessionEnhancement.handleSessionComplete({
                score: score,
                objectsFound: objectsFound,
                avgSearchTime: parseFloat(avgSearchTime)
            });
            
            // Hide game elements
            targetDisplay.classList.add('hidden');
            statsPanel.classList.add('hidden');
            
            // Show completion message
            finalScoreElement.textContent = score;
            finalFoundElement.textContent = objectsFound;
            finalAvgTimeElement.textContent = avgSearchTime;
            completionMessage.classList.remove('hidden');
            
            // Reset timer bar
            timerBar.style.width = '0%';

            // Call standardized endSession hook
            if (typeof window.endSession === 'function') {
                window.endSession(score, getCurrentDifficulty());
            }
        }
        
        // Helper function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // Load/save settings with localStorage
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved settings if they exist
            if (safeGet('scannerDifficulty')) {
                difficultySelect.value = safeGet('scannerDifficulty');
            }
            
            if (safeGet('scannerFocusArea')) {
                focusAreaSelect.value = safeGet('scannerFocusArea');
            }
            
            if (safeGet('scannerObjectType')) {
                objectTypeSelect.value = safeGet('scannerObjectType');
            }
            
            if (safeGet('scannerDuration')) {
                sessionDurationInput.value = safeGet('scannerDuration');
            }
            
            // Save settings when they change
            difficultySelect.addEventListener('change', saveSettings);
            focusAreaSelect.addEventListener('change', saveSettings);
            objectTypeSelect.addEventListener('change', saveSettings);
            sessionDurationInput.addEventListener('change', saveSettings);
        });
        
        // Save settings to localStorage
        function saveSettings() {
            safeSet('scannerDifficulty', difficultySelect.value);
            safeSet('scannerFocusArea', focusAreaSelect.value);
            safeSet('scannerObjectType', objectTypeSelect.value);
            safeSet('scannerDuration', sessionDurationInput.value);
        }
        
        // Resize handler to adjust scan area size
        window.addEventListener('resize', function() {
            if (isSessionActive) {
                const areaWidth = Math.min(700, window.innerWidth * 0.9);
                const areaHeight = Math.min(500, window.innerHeight * 0.7);
                scanArea.style.width = `${areaWidth}px`;
                scanArea.style.height = `${areaHeight}px`;
            }
        });
    </script>

    <!-- STANDARDIZED GAMIFICATION INTEGRATION -->
    <script type="module">
        import { recordSession } from '/js/progress.js';
        import { checkAndUnlockAchievements, markExerciseTried } from '/js/achievements.js';

        const EXERCISE_ID = 'visual-scanner';

        // Standardized endSession function exposed on window
        window.endSession = function(score, difficulty = 'easy') {
            recordSession(EXERCISE_ID, difficulty, score);
            
            try {
                markExerciseTried(EXERCISE_ID);
            } catch (e) {
                // Silent fail if signature differs
            }
            
            try {
                checkAndUnlockAchievements();
            } catch (e) {
                // Silent fail if not available
            }
        };
    </script>
</body>
</html>