<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKCCWBFKE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-RVKCCWBFKE');
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Sort & Categorize Exercise | Cognitive-Motor Training | Fine Point Rehab</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="Interactive sorting and categorization exercise that combines cognitive processing with motor skills. Enhance visual discrimination, decision-making, and upper limb control while improving attention and cognitive flexibility. Ideal for stroke rehabilitation, brain injury recovery, and cognitive therapy.">

  <!-- Canonical URL -->
  <link rel="canonical" href="https://finepointrehab.com/exercises/sort-categorize-exercise">

  <!-- Open Graph / Social Media Meta Tags -->
  <meta property="og:title" content="Sort & Categorize Exercise | Cognitive-Motor Training | Fine Point Rehab">
  <meta property="og:description" content="Interactive categorization exercise combining cognitive processing with motor skills. Enhance visual discrimination, decision-making, and upper limb control.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://finepointrehab.com/exercises/sort-categorize-exercise">
  <meta property="og:image" content="https://finepointrehab.com/images/sort-categorize-preview.jpg">
  <meta property="og:site_name" content="Fine Point Rehab">

  <style>
    :root{
      --bg:#121d33;
      --panel:#1c2a4e;
      --ink:#fff;
      --accent:rgba(111,211,245,1);
      --accent-40:rgba(111,211,245,0.4);
      --accent-70:rgba(111,211,245,0.7);
      --good:#2ecc71;
      --bad:#e74c3c;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--ink);
      min-height:100vh;
      overflow:hidden;
      touch-action: manipulation;
      user-select: none; -webkit-user-select: none;
    }

    /* Header */
    header.app-header{
      position: sticky; top:0; z-index:200;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:10px 16px env(safe-area-inset-right,16px) 16px;
      background: linear-gradient(180deg, rgba(0,0,0,0.5), rgba(0,0,0,0));
      border-bottom:1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(6px);
    }
    header .left{
      display:flex; align-items:center; gap:12px;
    }
    header h1{
      margin:0; font-size:18px; letter-spacing:.3px;
    }
    a.home-link{
      display:inline-block; padding:8px 10px;
      border-radius:10px; text-decoration:none; font-weight:600;
      background: rgba(111,211,245,0.15);
      color: var(--ink); border:1px solid rgba(111,211,245,0.35);
    }
    .hud{
      display:flex; align-items:center; gap:14px;
      font-size:14px; opacity:.95;
      white-space:nowrap;
    }
    .hud strong{color:var(--accent)}

    /* Layout */
    #game-container{ position:relative; width:100vw; height:calc(100vh - 56px); overflow:hidden; }
    #stars-container{ position:absolute; inset:0; z-index:1; pointer-events:none; overflow:hidden; }
    #timer-bar{ position:absolute; top:0; left:0; height:8px; background-color: var(--accent); width:100%; z-index:20; }

    #challenge-display{
      position:absolute; top:16px; left:50%; transform:translateX(-50%);
      padding:12px 18px; background: rgba(8,15,35,.85);
      border:2px solid rgba(111,211,245,.5); border-radius:14px;
      z-index:20; font-size:18px; font-weight:700; text-align:center; max-width:80%;
    }

    #sort-area{
      position:absolute; inset:64px 20px 120px 20px;
      background: var(--panel);
      border:2px solid rgba(111,211,245,.9);
      border-radius:15px; overflow:hidden;
      box-shadow:0 0 20px rgba(111,211,245,.3);
      z-index:10; display:flex; flex-direction:column;
    }
    #objects-container{
      flex:1; position:relative; padding:15px;
      display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:15px;
    }
    #categories-container{
      display:flex; justify-content:space-evenly; padding:15px;
      border-top:1px solid rgba(111,211,245,.5); background: rgba(8,15,35,.5);
      min-height:150px;
    }

    .category-box{
      width:130px; height:130px; border:3px dashed var(--accent-70);
      border-radius:15px; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px;
      transition:.2s ease; background:rgba(8,15,35,.4);
      position:relative;
    }
    .category-box.highlight{ background: rgba(111,211,245,.2); box-shadow:0 0 20px rgba(111,211,245,.5); transform:scale(1.05) }
    .category-box.correct{ border-color: rgba(46,204,113,.9); background: rgba(46,204,113,.15); box-shadow:0 0 20px rgba(46,204,113,.5); animation: correctPulse .8s ease }
    .category-box.incorrect{ border-color: rgba(231,76,60,.9); background: rgba(231,76,60,.15); box-shadow:0 0 20px rgba(231,76,60,.5); animation: incorrectShake .5s ease }

    @keyframes correctPulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    @keyframes incorrectShake{
      0%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-10px)}80%{transform:translateX(10px)}100%{transform:translateX(0)}
    }

    .category-icon{ font-size:38px; margin-bottom:8px }
    .category-label{ font-size:16px; text-align:center; font-weight:700; color:rgba(255,255,255,.9);
      background: rgba(8,15,35,.6); padding:4px 10px; border-radius:10px; width:90% }

    .sort-object{
      width:70px; height:70px; border-radius:12px; position:relative; z-index:5;
      display:flex; align-items:center; justify-content:center; font-size:30px; cursor:grab;
      box-shadow:0 0 15px var(--accent-40); transition: transform .15s ease, box-shadow .15s ease;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(111,211,245,.9));
      border:3px solid transparent; touch-action:none; user-select:none;
    }
    .sort-object:active{ cursor:grabbing; transform: scale(1.05); z-index:12 }

    /* Category hint on objects */
    .category-hint{
      position:absolute; bottom:-24px; left:50%; transform:translateX(-50%);
      font-size:12px; background: rgba(8,15,35,.75);
      padding:3px 8px; border-radius:8px; opacity:0; transition:opacity .2s ease; pointer-events:none; white-space:nowrap;
    }
    .sort-object:hover .category-hint{ opacity:1 }

    .object-clone{ position:absolute; opacity:.85; pointer-events:none; z-index:15; transition: transform .08s ease }

    /* Settings Panel */
    #settings-panel{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background: rgba(8,15,35,.95);
      border-radius:15px; padding:25px 25px calc(25px + env(safe-area-inset-bottom,20px));
      box-shadow:0 10px 30px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.1);
      z-index:100; width:80%; max-width:420px; max-height:calc(85vh - env(safe-area-inset-bottom,40px));
      border:1px solid rgba(255,255,255,.1); overflow-y:auto; margin-bottom: env(safe-area-inset-bottom, 20px);
    }
    #settings-panel h2{ margin:0 0 18px; text-align:center }
    .settings-group{ margin-bottom:18px }
    .settings-label{ display:block; margin-bottom:8px; font-weight:700 }
    select,input{
      width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,.2);
      background: rgba(0,10,30,.8); color:#fff; font-size:16px;
    }
    select:focus,input:focus{ outline:none; border-color: var(--accent); box-shadow:0 0 0 2px rgba(111,211,245,.3) }
    button{
      background: var(--accent); color:#121d33; border:none; border-radius:10px; padding:12px 15px;
      font-size:16px; font-weight:700; cursor:pointer; width:100%; transition:.15s ease; box-shadow:0 4px 6px rgba(0,0,0,.2);
    }
    button:hover{ filter:brightness(1.05); transform: translateY(-1px) }

    /* Stats / HUD row at bottom */
    #stats-panel{
      position:absolute; bottom:0; left:0; right:0;
      background: rgba(8,15,35,.8); padding:12px 15px; display:flex; gap:10px; justify-content:space-around; align-items:center;
      box-shadow:0 -2px 10px rgba(0,0,0,.3); z-index:30;
    }
    .stat-box{text-align:center}
    .stat-value{ font-size:22px; font-weight:800; color: var(--accent) }
    .stat-label{ font-size:12px; color: rgba(255,255,255,.8) }
    .hidden{ display:none !important }

    /* Round progress bar */
    #round-progress{ position:relative; height:10px; flex:1; background: rgba(255,255,255,.08); border-radius:999px; overflow:hidden; margin:0 10px }
    #round-progress-fill{ position:absolute; top:0; left:0; height:100%; width:0%; background: linear-gradient(90deg, var(--accent), #7cf5ff); }

    /* Feedback toast */
    #feedback-message{
      position:absolute; top:20%; left:50%; transform:translateX(-50%);
      padding:14px 20px; border-radius:10px; font-size:18px; font-weight:800; opacity:0; transition:opacity .25s ease; z-index:50; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,.3);
    }
    #feedback-message.show{ opacity:1 }
    #feedback-message.correct{ background: rgba(46,204,113,.95); color:#fff }
    #feedback-message.incorrect{ background: rgba(231,76,60,.95); color:#fff }

    /* Completion dialog */
    #completion-message{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background: rgba(8,15,35,.95); padding:28px; border-radius:15px;
      box-shadow:0 10px 30px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.1);
      text-align:center; max-width:80%; border:1px solid rgba(255,255,255,.1); z-index:100;
    }
    #completion-message h2{ margin:0 0 8px }
    #completion-scores{ margin:18px 0; font-size:18px }
    .score-highlight{ color: var(--accent); font-weight:800 }

    /* Helpers */
    #help-button, #hint-toggle, #home-button{ display:none } /* superseded by header */

    /* Mobile tweaks */
    @media (max-width: 768px){
      header h1{ font-size:16px }
      .stat-value{ font-size:18px }
      .category-box{ width:110px; height:110px }
      .category-icon{ font-size:30px }
      .category-label{ font-size:14px }
      .sort-object{ width:60px; height:60px; font-size:24px }
      #challenge-display{ font-size:16px; padding:10px 15px }
      #settings-panel{ width:90%; max-width:350px; top:46% }
    }
  </style>
</head>
<body>
  <header class="app-header" role="banner" aria-label="Exercise Header">
    <div class="left">
      <a class="home-link" href="/" aria-label="Home">‚Üê Home</a>
      <h1>Sort &amp; Categorize</h1>
    </div>
    <div class="hud" role="group" aria-label="HUD">
      <span>Score <strong id="hud-score">0</strong></span>
      <span>‚Ä¢ Progress <strong id="hud-progress">0/0</strong></span>
      <span>‚Ä¢ Difficulty <strong id="hud-difficulty">Medium</strong></span>
    </div>
  </header>

  <div id="game-container" role="application" aria-label="Sort & Categorize exercise">
    <div id="stars-container"></div>
    <div id="timer-bar"></div>

    <div id="challenge-display" role="status" aria-live="polite" class="hidden">Sort the objects by their categories</div>
    <div id="feedback-message" role="status" aria-live="polite"></div>

    <div id="sort-area" aria-label="Play area">
      <div id="objects-container" aria-label="Objects to sort"></div>
      <div id="categories-container" aria-label="Category boxes"></div>
    </div>

    <!-- Settings -->
    <div id="settings-panel" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <h2 id="settings-title">Sort &amp; Categorize Settings</h2>

      <div class="settings-group">
        <div style="background-color: rgba(111, 211, 245, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 18px; border: 1px solid rgba(111, 211, 245, 0.3);">
          <p style="margin: 0; font-size: 15px; line-height: 1.4; color: rgba(255, 255, 255, 0.9);">
            Drag and drop objects into their correct categories to train visual discrimination, decision-making, and hand-eye coordination.
          </p>
        </div>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="difficulty">Difficulty</label>
        <select id="difficulty" aria-label="Difficulty">
          <option value="easy">Easy (3 Categories)</option>
          <option value="medium" selected>Medium (4 Categories)</option>
          <option value="hard">Hard (5 Categories)</option>
        </select>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="category-type">Category Type</label>
        <select id="category-type" aria-label="Category Type">
          <option value="colors">Colors</option>
          <option value="shapes" selected>Shapes</option>
          <option value="numbers">Numbers</option>
          <option value="letters">Letters</option>
        </select>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="objects-count">Objects Per Round</label>
        <select id="objects-count" aria-label="Objects per round">
          <option value="6">Few (6)</option>
          <option value="9" selected>Medium (9)</option>
          <option value="12">Many (12)</option>
        </select>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="session-duration">Session Duration (minutes)</label>
        <input type="number" id="session-duration" min="1" max="10" value="3">
      </div>

      <div class="settings-group">
        <label class="settings-label" for="hint-setting">Show Category Hints</label>
        <select id="hint-setting">
          <option value="off">Off</option>
          <option value="hover">Show on Hover</option>
          <option value="always">Always Show</option>
        </select>
      </div>

      <button id="start-session">Start Therapy Session</button>
    </div>

    <!-- Bottom HUD -->
    <div id="stats-panel" class="hidden" aria-live="polite">
      <div class="stat-box">
        <div id="score" class="stat-value">0</div>
        <div class="stat-label">Score</div>
      </div>
      <div class="stat-box">
        <div id="rounds-completed" class="stat-value">0</div>
        <div class="stat-label">Rounds</div>
      </div>
      <div id="round-progress" aria-label="Round progress">
        <div id="round-progress-fill"></div>
      </div>
      <div class="stat-box">
        <div id="time-left" class="stat-value">3:00</div>
        <div class="stat-label">Time Left</div>
      </div>
      <div class="stat-box">
        <div id="accuracy" class="stat-value">0%</div>
        <div class="stat-label">Accuracy</div>
      </div>
    </div>

    <!-- Completion -->
    <div id="completion-message" class="hidden" role="dialog" aria-modal="true" aria-labelledby="completed-title">
      <h2 id="completed-title">Session Complete!</h2>
      <div id="completion-scores">
        <p>Final Score: <span id="final-score" class="score-highlight">0</span></p>
        <p>Rounds Completed: <span id="final-rounds" class="score-highlight">0</span></p>
        <p>Accuracy: <span id="final-accuracy" class="score-highlight">0%</span></p>
      </div>
      <button id="restart-button">Start New Session</button>
    </div>
  </div>

  <!-- STANDARDIZED MODULE IMPORTS & SESSION INTEGRATION -->
  <script type="module">
    import { recordSession } from '/js/progress.js';
    import { checkAndUnlockAchievements, markExerciseTried } from '/js/achievements.js';
    const EXERCISE_ID = 'sort-categorize';

    // Call this when an exercise session ends
    window.endSession = function(score, difficulty = 'medium') {
      recordSession(EXERCISE_ID, difficulty, score);
      try { markExerciseTried(EXERCISE_ID); } catch (e) { /* no-op */ }
      try { checkAndUnlockAchievements(); } catch (e) { /* optional */ }
    };
  </script>

  <!-- MAIN GAME SCRIPT -->
  <script type="module">
    import { initUtils } from '/js/utils.js';
    import { sessionEnhancement } from '/js/session-enhancement.js';
    initUtils(); // starfield utils etc (if any)

    /* --------- State --------- */
    const el = (id) => document.getElementById(id);
    const objectsContainer = el('objects-container');
    const categoriesContainer = el('categories-container');
    const statsPanel = el('stats-panel');
    const challengeDisplay = el('challenge-display');
    const feedbackMessage = el('feedback-message');
    const timerBar = el('timer-bar');

    const scoreEl = el('score');
    const roundsEl = el('rounds-completed');
    const timeLeftEl = el('time-left');
    const accuracyEl = el('accuracy');

    const hudScore = el('hud-score');
    const hudProgress = el('hud-progress');
    const hudDifficulty = el('hud-difficulty');

    const progressFill = el('round-progress-fill');

    const settingsPanel = el('settings-panel');
    const startBtn = el('start-session');
    const restartBtn = el('restart-button');
    const completionMsg = el('completion-message');

    const stars = el('stars-container');

    let sessionActive = false;
    let sessionEndsAt = 0;
    let sessionTimerId = null;
    let totalSessionSeconds = 0;

    let score = 0;
    let rounds = 0;
    let attempts = 0;
    let correct = 0;

    let totalInRound = 0;
    let placedInRound = 0;

    let dragging = null;
    let dragClone = null;
    let dragOffset = {x:0,y:0};

    /* --------- Utilities --------- */
    function starfield(n=120){
      stars.innerHTML = '';
      const frag = document.createDocumentFragment();
      for(let i=0;i<n;i++){
        const s = document.createElement('div');
        s.className = 'star';
        s.style.left = (Math.random()*100)+'%';
        s.style.top  = (Math.random()*100)+'%';
        s.style.opacity = (0.25 + Math.random()*0.6).toFixed(2);
        s.style.transform = `scale(${0.8 + Math.random()*1.6})`;
        frag.appendChild(s);
      }
      stars.appendChild(frag);
    }
    starfield();

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    /* --------- Difficulty --------- */
    function getCurrentDifficulty(){
      const difficultySelect = document.getElementById('difficulty');
      if (!difficultySelect) return 'medium';
      const val = (difficultySelect.value || 'medium').toLowerCase();
      if (val !== 'easy' && val !== 'medium' && val !== 'hard') return 'medium';
      return val;
    }

    function categoryCountFor(difficulty){
      return difficulty === 'easy' ? 3 : (difficulty === 'hard' ? 5 : 4);
    }

    /* --------- Category Sets --------- */
    const emoji = {
      Red:'üî¥', Blue:'üîµ', Green:'üü¢', Yellow:'üü°', Purple:'üü£',
      Round:'üîµ', Square:'üü•', Triangle:'üî∫', Stars:'‚≠ê', Hearts:'‚ù§Ô∏è'
    };

    function buildCategories(type, difficulty){
      const n = categoryCountFor(difficulty);
      if (type === 'colors'){
        const base = ['Red','Blue','Green','Yellow','Purple'];
        return base.slice(0,n).map(label => ({ key:label, label, icon: emoji[label] || '‚¨ú' }));
      }
      if (type === 'shapes'){
        const base = ['Round','Square','Triangle','Stars','Hearts'];
        return base.slice(0,n).map(label => ({ key:label, label, icon: emoji[label] || '‚óªÔ∏è' }));
      }
      if (type === 'numbers'){
        // group buckets by ranges
        const defs = {
          easy:  [ [1,3], [4,6], [7,9] ],
          medium:[ [1,3], [4,6], [7,9], [10,12] ],
          hard:  [ [1,3], [4,6], [7,9], [10,12], [13,15] ]
        }[difficulty];
        return defs.map(([a,b]) => {
          const label = `${a}-${b}`;
          return { key:label, label, icon:'üî¢', range:[a,b] };
        });
      }
      if (type === 'letters'){
        // alphabet buckets
        const defs = {
          easy:  [ ['A','I'], ['J','R'], ['S','Z'] ],
          medium:[ ['A','F'], ['G','L'], ['M','R'], ['S','Z'] ],
          hard:  [ ['A','E'], ['F','J'], ['K','O'], ['P','T'], ['U','Z'] ]
        }[difficulty];
        return defs.map(([a,b]) => {
          const label = `${a}‚Äì${b}`;
          return { key:label, label, icon:'üî§', range:[a.charCodeAt(0), b.charCodeAt(0)] };
        });
      }
      return [];
    }

    function pickObjects(type, categories, count){
      const items = [];
      if (type === 'colors'){
        const pool = categories.map(c => c.key);
        for(let i=0;i<count;i++){
          const cat = pool[Math.floor(Math.random()*pool.length)];
          const icon = emoji[cat] || '‚¨ú';
          items.push({ display:icon, category:cat, hint:`Drop into ${cat}` });
        }
        return items;
      }
      if (type === 'shapes'){
        const pool = categories.map(c => c.key);
        const iconFor = (c)=> emoji[c] || '‚óªÔ∏è';
        for(let i=0;i<count;i++){
          const cat = pool[Math.floor(Math.random()*pool.length)];
          items.push({ display: iconFor(cat), category:cat, hint:`${cat}` });
        }
        return items;
      }
      if (type === 'numbers'){
        // derive min/max across ranges we use
        const min = Math.min(...categories.map(c => c.range[0]));
        const max = Math.max(...categories.map(c => c.range[1]));
        for(let i=0;i<count;i++){
          const num = Math.floor(Math.random()*(max-min+1))+min;
          const cat = categories.find(c => num>=c.range[0] && num<=c.range[1]).key;
          items.push({ display:String(num), category:cat, hint:`${cat}` });
        }
        return items;
      }
      if (type === 'letters'){
        const [min,max] = [
          Math.min(...categories.map(c => c.range[0])),
          Math.max(...categories.map(c => c.range[1]))
        ];
        for(let i=0;i<count;i++){
          const code = Math.floor(Math.random()*(max-min+1))+min;
          const letter = String.fromCharCode(code);
          const cat = categories.find(c => code>=c.range[0] && code<=c.range[1]).key;
          items.push({ display:letter, category:cat, hint:`${cat}` });
        }
        return items;
      }
      return items;
    }

    /* --------- Rendering --------- */
    function clearRoundUI(){
      objectsContainer.innerHTML = '';
      categoriesContainer.innerHTML = '';
      placedInRound = 0;
      updateRoundProgress();
    }

    function renderCategories(categories){
      const frag = document.createDocumentFragment();
      categories.forEach(c => {
        const box = document.createElement('div');
        box.className = 'category-box';
        box.setAttribute('role','button');
        box.setAttribute('aria-label', `Category ${c.label}`);
        box.dataset.category = c.key;

        const icon = document.createElement('div');
        icon.className = 'category-icon';
        icon.textContent = c.icon || '‚óªÔ∏è';

        const label = document.createElement('div');
        label.className = 'category-label';
        label.textContent = c.label;

        box.appendChild(icon); box.appendChild(label);
        frag.appendChild(box);
      });
      categoriesContainer.appendChild(frag);
    }

    function renderObjects(items, showHintsMode){
      const frag = document.createDocumentFragment();
      items.forEach((it, idx) => {
        const ob = document.createElement('div');
        ob.className = 'sort-object';
        ob.dataset.category = it.category;
        ob.dataset.index = String(idx);
        ob.setAttribute('tabindex', '0');
        ob.setAttribute('role','button');
        ob.setAttribute('aria-label', `Object ${it.display}, category ${it.category}`);

        const span = document.createElement('span');
        span.textContent = it.display;
        ob.appendChild(span);

        const hint = document.createElement('div');
        hint.className = 'category-hint';
        hint.textContent = it.hint || it.category;
        ob.appendChild(hint);

        if (showHintsMode === 'always'){
          hint.style.opacity = '1';
        } else if (showHintsMode === 'off'){
          hint.style.display = 'none';
        }

        attachDragHandlers(ob);
        frag.appendChild(ob);
      });
      objectsContainer.appendChild(frag);
    }

    /* --------- Drag & Drop (pointer-based) --------- */
    function pointerPos(e){
      if (e.touches && e.touches[0]) return { x:e.touches[0].clientX, y:e.touches[0].clientY };
      return { x:e.clientX, y:e.clientY };
    }

    function attachDragHandlers(elm){
      const onDown = (e) => {
        if (!sessionActive) return;
        e.preventDefault();
        elm.setPointerCapture?.(e.pointerId || undefined);

        const {x,y} = pointerPos(e);
        const rect = elm.getBoundingClientRect();
        dragOffset = { x: x - rect.left, y: y - rect.top };

        dragging = elm;
        dragClone = elm.cloneNode(true);
        dragClone.classList.add('object-clone');
        dragClone.style.width = rect.width+'px';
        dragClone.style.height = rect.height+'px';
        dragClone.style.left = rect.left+'px';
        dragClone.style.top = rect.top+'px';
        document.body.appendChild(dragClone);

        elm.style.opacity = '0.25';
      };

      const onMove = (e) => {
        if (!dragClone) return;
        const {x,y} = pointerPos(e);
        dragClone.style.transform = `translate(${x - dragOffset.x - parseFloat(dragClone.style.left)}px, ${y - dragOffset.y - parseFloat(dragClone.style.top)}px)`;

        // highlight hovered category
        const target = categoryAtPoint(x,y);
        for (const box of categoriesContainer.children){
          box.classList.toggle('highlight', box === target);
        }
      };

      const onUp = (e) => {
        if (!dragClone) return;
        const {x,y} = pointerPos(e);
        const target = categoryAtPoint(x,y);
        finalizeDrop(target);
      };

      // Pointer events for broad device support
      elm.addEventListener('pointerdown', onDown, {passive:false});
      window.addEventListener('pointermove', onMove, {passive:false});
      window.addEventListener('pointerup', onUp, {passive:false});

      // Touch fallback (older browsers)
      elm.addEventListener('touchstart', onDown, {passive:false});
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('touchend', onUp, {passive:false});

      // Mouse fallback
      elm.addEventListener('mousedown', onDown);
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
    }

    function categoryAtPoint(x,y){
      const boxes = Array.from(categoriesContainer.children);
      for (const b of boxes){
        const r = b.getBoundingClientRect();
        if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom) return b;
      }
      return null;
    }

    function finalizeDrop(targetBox){
      const obj = dragging;
      const clone = dragClone;
      dragging = null; dragClone = null;

      // clear highlights
      for (const box of categoriesContainer.children){ box.classList.remove('highlight'); }

      if (!obj){ return; }

      const correctCat = obj.dataset.category;
      attempts++;

      if (targetBox && targetBox.dataset.category === correctCat){
        // Correct placement
        targetBox.classList.add('correct');
        setTimeout(()=> targetBox.classList.remove('correct'), 350);

        showFeedback(true);
        correct++;
        score += 10;
        placedInRound++;
        updateRoundProgress();

        // Remove object
        obj.remove();
      } else {
        if (targetBox){
          targetBox.classList.add('incorrect');
          setTimeout(()=> targetBox.classList.remove('incorrect'), 350);
        }
        showFeedback(false);
        score = Math.max(0, score - 2);
      }

      // cleanup clone + restore obj opacity if still present
      if (clone && clone.parentNode) clone.parentNode.removeChild(clone);
      if (obj && obj.parentNode) obj.style.opacity = '1';

      updateScoreAccuracy();
      updateHud();

      // Round complete?
      if (placedInRound >= totalInRound){
        rounds++;
        roundsEl.textContent = String(rounds);
        startNextRound();
      }
    }

    function showFeedback(isCorrect){
      const msg = isCorrect ? 'Nice!' : 'Try again';
      feedbackMessage.textContent = msg;
      feedbackMessage.className = 'show ' + (isCorrect ? 'correct' : 'incorrect');
      setTimeout(()=> { feedbackMessage.className = feedbackMessage.className.replace('show','').trim(); }, 600);
    }

    function updateScoreAccuracy(){
      const acc = attempts ? Math.round((correct/attempts)*100) : 0;
      scoreEl.textContent = String(score);
      accuracyEl.textContent = acc + '%';
    }

    function updateHud(){
      hudScore.textContent = String(score);
      hudProgress.textContent = `${placedInRound}/${totalInRound}`;
      hudDifficulty.textContent = capitalize(getCurrentDifficulty());
    }

    function updateRoundProgress(){
      const pct = totalInRound ? (placedInRound/totalInRound)*100 : 0;
      progressFill.style.width = pct + '%';
      hudProgress.textContent = `${placedInRound}/${totalInRound}`;
    }

    function capitalize(s){ return (s||'').slice(0,1).toUpperCase() + (s||'').slice(1) }

    /* --------- Rounds --------- */
    function startRound(){
      const difficulty = getCurrentDifficulty();
      const type = document.getElementById('category-type').value;
      const count = parseInt(document.getElementById('objects-count').value,10);

      const categories = buildCategories(type, difficulty);
      clearRoundUI();
      renderCategories(categories);

      const items = pickObjects(type, categories, count);
      totalInRound = items.length;
      placedInRound = 0;

      const hintMode = document.getElementById('hint-setting').value; // 'off' | 'hover' | 'always'
      renderObjects(items, hintMode);

      challengeDisplay.classList.remove('hidden');
      challengeDisplay.textContent = `Sort by ${capitalize(type)} (${categories.length} categories)`;
      updateRoundProgress();
      updateHud();
    }

    function startNextRound(){
      // brief pause then new round
      setTimeout(()=> startRound(), 500);
    }

    /* --------- Session Timer --------- */
    function formatTime(s){
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}:${String(r).padStart(2,'0')}`;
    }

    function startTimer(totalSeconds){
      totalSessionSeconds = totalSeconds;
      sessionEndsAt = Date.now() + totalSeconds*1000;

      if (sessionTimerId) clearInterval(sessionTimerId);

      sessionTimerId = setInterval(() => {
        const remaining = Math.max(0, Math.ceil((sessionEndsAt - Date.now())/1000));
        timeLeftEl.textContent = formatTime(remaining);

        const pct = clamp(remaining/totalSessionSeconds, 0, 1);
        timerBar.style.width = (pct*100) + '%';

        if (remaining <= 0){
          clearInterval(sessionTimerId);
          endExercise();
        }
      }, 250);
    }

    function endExercise(){
      sessionActive = false;
      statsPanel.classList.add('hidden');

      const acc = attempts ? Math.round((correct/attempts)*100) : 0;
      document.getElementById('final-score').textContent = String(score);
      document.getElementById('final-rounds').textContent = String(rounds);
      document.getElementById('final-accuracy').textContent = acc + '%';

      completionMsg.classList.remove('hidden');

      // Record session via shared hook
      window.endSession(score, getCurrentDifficulty());
    }

    /* --------- Session Flow --------- */
    function resetState(){
      score = 0; rounds = 0; attempts = 0; correct = 0;
      scoreEl.textContent = '0'; roundsEl.textContent = '0'; accuracyEl.textContent = '0%';
      hudScore.textContent = '0'; hudProgress.textContent = '0/0';
      timerBar.style.width = '100%';
    }

    startBtn.addEventListener('click', () => {
      settingsPanel.classList.add('hidden');
      statsPanel.classList.remove('hidden');
      completionMsg.classList.add('hidden');
      sessionActive = true;
      resetState();

      // start round + timer
      startRound();
      const mins = clamp(parseInt(document.getElementById('session-duration').value,10) || 3, 1, 10);
      startTimer(mins * 60);
    });

    restartBtn.addEventListener('click', () => {
      completionMsg.classList.add('hidden');
      settingsPanel.classList.remove('hidden');
    });

    // Reflect HUD difficulty on change
    document.getElementById('difficulty').addEventListener('change', ()=> updateHud());

    // Accessibility: keyboard "drop" (Enter/Space) to nearest category center
    objectsContainer.addEventListener('keydown', (e) => {
      if (!sessionActive) return;
      const tgt = e.target.closest('.sort-object');
      if (!tgt) return;
      if (e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        // snap to closest category by distance
        const objRect = tgt.getBoundingClientRect();
        const oc = { x: objRect.left + objRect.width/2, y: objRect.top + objRect.height/2 };
        let best = null, bestD = Infinity;
        for (const b of categoriesContainer.children){
          const r = b.getBoundingClientRect();
          const bc = { x: r.left + r.width/2, y: r.top + r.height/2 };
          const d = Math.hypot(oc.x - bc.x, oc.y - bc.y);
          if (d < bestD){ bestD = d; best = b; }
        }
        finalizeDrop(best);
      }
    });

    /* --------- Init enhance --------- */
    try{ sessionEnhancement?.(); }catch(e){ /* optional */ }

  </script>
</body>
</html>
