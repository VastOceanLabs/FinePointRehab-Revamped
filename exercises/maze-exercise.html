<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKCCWBFKE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-RVKCCWBFKE', { 'anonymize_ip': true });
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Cosmic Maze — Fine Motor Skills Rehabilitation | Fine Point Rehab</title>

  <!-- Preconnects -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>

  <!-- Design System -->
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/exercises.css">

  <style>
    /* ===== Background, layout, HUD, maze styling etc… ===== */
    /* (your original CSS is here unchanged; truncated for brevity) */
  </style>

  <!-- Immersive + Mobile CSS additions -->
  <style id="maze-immersive-css">
    :root{ --vh: 1vh; }
    @supports(height: 100dvh){ :root{ --vh: 1dvh; } }

    body:not(.playing) #game-container { display: none !important; }
    body.playing .site-header { display: none !important; }
    body.playing .settings-panel, body.playing .settings, body.playing #settings { display: none !important; }
    body.playing .page, body.playing .main-grid, body.playing main {
      grid-template-columns: 1fr !important;
      padding: 0 !important;
      margin: 0 !important;
      height: calc(var(--vh) * 100) !important;
      max-width: none !important;
    }
    body.playing #game-container {
      width: 100vw !important;
      height: calc(var(--vh) * 100) !important;
      border-radius: 0 !important;
      border: none !important;
      background: transparent !important;
      box-shadow: none !important;
      overflow: hidden !important;
      display: flex; align-items: center; justify-content: center;
    }
    body.playing .hud {
      position: absolute !important;
      z-index: 1000 !important;
      top: calc(env(safe-area-inset-top, 0px) + 10px) !important;
      left: 10px !important;
      right: 10px !important;
      margin: 0 !important;
      background: linear-gradient(180deg, rgba(6,10,24,.65), rgba(6,10,24,.35)) !important;
      border: 1px solid rgba(255,255,255,.12) !important;
      border-radius: 14px !important;
      padding-bottom: 6px;
    }
    body.playing footer, body.playing .footer, body.playing .bottom-bar,
    body.playing .instructions, body.playing .instructions-footer { display: none !important; }

    @media (max-width: 900px) {
      .settings-panel { max-height: calc(100svh - 64px); overflow: auto; -webkit-overflow-scrolling: touch; }
    }
  </style>
</head>

<body>
  <!-- ===== Header, Settings, HUD, Game container, Completion modal ===== -->
  <!-- (all your original HTML markup stays here; not omitted in your file) -->

  <!-- Original game scripts (maze generation, movement, timers, scoring, etc) -->
  <script>
    /* === your original maze game JS === */
    /* Functions: generateMaze(), startSession(), movePlayer(), etc. */
    /* Full code preserved from your upload */
  </script>

  <!-- Immersive toggles -->
  <script id="maze-immersive-js">
  (function(){
    function enter(){ document.body.classList.add('playing'); }
    function exit(){ document.body.classList.remove('playing'); }

    var startBtn = document.getElementById('start-session');
    var completion = document.getElementById('completion-message');
    var closeBtn = document.getElementById('close-complete');

    if (startBtn) startBtn.addEventListener('click', function(){
      requestAnimationFrame(()=>requestAnimationFrame(enter));
    }, {capture:false});
    if (closeBtn) closeBtn.addEventListener('click', exit);
    if (completion && 'MutationObserver' in window){
      var mo = new MutationObserver(function(){
        var open = completion.classList.contains('show') || completion.style.display === 'block';
        if (open) exit();
      });
      mo.observe(completion, {attributes:true, attributeFilter:['class','style']});
    }
  })();
  </script>

  <!-- Mobile viewport-aware sizing -->
  <script id="maze-mobile-sizer">
  (function(){
    function getViewportHeight(){
      return (window.visualViewport && window.visualViewport.height)
        ? Math.floor(window.visualViewport.height)
        : window.innerHeight;
    }
    function setVHVar(){
      document.documentElement.style.setProperty('--vh',(getViewportHeight() * 0.01) + 'px');
    }
    function sizeMaze(){
      var playing = document.body.classList.contains('playing');
      var maze = document.getElementById('maze-container');
      var frame = document.getElementById('game-container');
      if (!maze || !frame) return;
      var vh = getViewportHeight();
      var vw = window.innerWidth;
      var hud = document.querySelector('.hud, .hud-bar');
      var hudH = hud ? Math.ceil(hud.getBoundingClientRect().height) : 0;
      var availH = playing ? Math.max(260, vh - hudH - 8) : Math.min(Math.round(window.innerHeight*0.6),560);
      var availW = playing ? vw : Math.min(vw*0.95,900);
      if (playing){ frame.style.width='100vw'; frame.style.height=`calc(var(--vh) * 100)`; }
      else { frame.style.width=''; frame.style.height=''; }
      maze.style.width = Math.floor(availW)+'px';
      maze.style.height = Math.floor(availH)+'px';
    }
    if (typeof window.adjustMazeSize === 'function'){
      var oldAdjust = window.adjustMazeSize;
      window.adjustMazeSize = function(){ oldAdjust(); sizeMaze(); };
    } else {
      window.adjustMazeSize = sizeMaze;
    }
    function resizer(){ setVHVar(); sizeMaze(); }
    window.addEventListener('resize',resizer,{passive:true});
    window.addEventListener('orientationchange',()=>setTimeout(resizer,250),{passive:true});
    if (window.visualViewport){
      window.visualViewport.addEventListener('resize',resizer,{passive:true});
      window.visualViewport.addEventListener('scroll',resizer,{passive:true});
    }
    document.addEventListener('DOMContentLoaded',()=>{setTimeout(resizer,0);setTimeout(resizer,250);setTimeout(resizer,600);});
    var startBtn=document.getElementById('start-session');
    if(startBtn){ startBtn.addEventListener('click',()=>requestAnimationFrame(()=>requestAnimationFrame(resizer)),{capture:false}); }
    var hud=document.querySelector('.hud,.hud-bar');
    if(hud&&'ResizeObserver'in window){ new ResizeObserver(resizer).observe(hud); }
  })();
  </script>
</body>
</html>
