<!DOCTYPE html>
<html lang="en">
<head>
  <!-- BUILD: Maze — Comet-style immersive shell | 2025-09-14 -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cosmic Maze — Fine Point Rehab</title>

  <!-- Design System -->
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">

  <style>
    :root{
      --vh: 1vh;
      --bg-1:#070b16; --bg-2:#0f1630; --bg-3:#0b1024;
      --accent: var(--brand-aqua, #6fd3f5);
      --radius: 14px;
      --panel: rgba(10,16,36,.9);
      --panel-border: rgba(255,255,255,.08);
      --text: #eaf6ff;
    }
    /* Background + base */
    body{ margin:0; color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 25%, rgba(70,30,120,.35), transparent 60%),
        radial-gradient(900px 700px at 75% 65%, rgba(20,120,160,.28), transparent 55%),
        linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 50%, var(--bg-3) 100%);
      min-height: calc(var(--vh) * 100);
      touch-action: manipulation;
    }
    body.playing { overflow: hidden; }
    body.playing header.app { display: none; }

    /* Header (matches Comet) */
    header.app{
      position: sticky; top:0; z-index: 50;
      padding:12px 16px; display:flex; gap:12px; align-items:center;
      background: linear-gradient(180deg, rgba(8,12,26,.9), rgba(8,12,26,.55));
      border-bottom: 1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(6px);
    }
    header .home { text-decoration:none; color:var(--text); font-weight:700;
      border:1px solid rgba(255,255,255,.18); border-radius:999px; padding:8px 12px; }
    header h1{ margin:0; font-size: clamp(18px,3vw,24px); }

    /* Grid layout */
    .layout{ display:grid; grid-template-columns: 1fr; gap:16px; padding:16px; height:auto; }
    .panel{ background: var(--panel); border: 1px solid var(--panel-border); border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.05); }

    /* Settings */
    #settings { padding:18px; overflow:auto; position:relative; z-index: 5; max-width: 820px; margin: 0 auto; }
    #settings h2{ margin:0 0 10px; font-size:20px; text-align:center; }
    .desc{ margin-bottom:12px; background: rgba(111,211,245,.08);
           border-left: 4px solid rgba(111,211,245,.7); padding:10px; border-radius:8px; font-size:14px; line-height:1.5; }

    .stats-row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:12px; }
    .metric{ flex:0 0 auto; display:flex; flex-direction:column; align-items:center; justify-content:center;
             text-align:center; padding:8px 12px; border:1px solid rgba(255,255,255,.12); border-radius:12px;
             background: rgba(255,255,255,.05); min-width:110px; }
    .v{ font-weight:900; font-size:18px; color:#bfe6ff; text-shadow: 0 0 6px rgba(150,220,255,.5); line-height:1.1; }
    .t{ font-size:11px; opacity:.9; margin-top:3px; }

    .group{ margin-bottom:12px; }
    .label{ display:block; margin-bottom:6px; font-weight:700; letter-spacing:.2px; }
    select, input[type="number"]{
      width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,.2);
      background: rgba(5,10,26,.8); color:var(--text); font-size:16px;
    }
    select:focus, input[type="number"]:focus{
      outline:none; border-color: rgba(111,211,245,.9); box-shadow: 0 0 0 2px rgba(111,211,245,.25);
    }
    .btn{
      min-height:46px; border:1px solid rgba(111,211,245,.35); background: rgba(111,211,245,.12);
      color:var(--text); border-radius:10px; font-weight:800; letter-spacing:.2px; cursor:pointer; transition:.2s;
    }
    .btn:hover:not(:disabled){ background: rgba(111,211,245,.22); transform: translateY(-1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn-primary{ background: rgba(111,211,245,.95); color:#07101e; border-color: rgba(111,211,245,1); }
    .btn-primary:hover:not(:disabled){ background: rgba(111,211,245,1); box-shadow: 0 6px 18px rgba(111,211,245,.45); }

    .settings-actions { display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px; }

    /* Game column */
    .right{ display:grid; grid-template-rows: auto 1fr; gap:10px; }

    .hud{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; padding:8px 10px; margin-bottom:10px;
          background: rgba(8,14,36,.85); border: 1px solid var(--panel-border); border-radius: var(--radius);
          box-shadow: 0 6px 16px rgba(0,0,0,.35); position:relative; z-index:4; }
    .actions{ flex:0 0 auto; display:flex; gap:8px; margin-left:auto; }
    .btn-ghost{ min-height:34px; padding:6px 10px; font-weight:800; border:1px solid rgba(255,255,255,.22);
                border-radius:999px; background: rgba(255,255,255,.06); color:var(--text); cursor:pointer; white-space:nowrap; }
    .btn-ghost:hover{ background: rgba(255,255,255,.12); }

    .frame{ position:relative; border-radius: var(--radius); overflow:hidden;
            border:1px solid var(--panel-border); box-shadow: inset 0 0 40px rgba(0,0,0,.35);
            background: radial-gradient(60% 45% at 50% 40%, rgba(80,160,200,.12), transparent 68%); }

    /* Starfield canvas (behind maze) */
    #stars{ position:absolute; inset:0; display:block; width:100%; height:62vh; max-height:760px; }

    /* Maze container adopts within frame */
    #maze-container{ position:relative; margin:0 auto; background-color: rgba(0,0,0,0.3);
      border: 2px solid var(--accent); border-radius: 12px; overflow:hidden; box-shadow: 0 0 20px rgba(111,211,245,.2);
      touch-action:none; outline: none; }

    /* Timer bar */
    .timer-bar{ position:absolute; top:0; left:0; height:8px; width:100%;
      background: linear-gradient(90deg, var(--accent), rgba(111,211,245,.35)); transform-origin:left center;
      transition: transform .1s linear; border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); }

    /* Immersive mode (full-bleed game space) */
    body.playing .layout{ grid-template-columns: 1fr; padding:0; height: calc(var(--vh) * 100); }
    body.playing #settings{ display:none; }
    body.playing .right{ height: calc(var(--vh) * 100); }
    body.playing .frame{ border:none; border-radius:0; height: calc(var(--vh) * 100); box-shadow: none; background: transparent; }
    body.playing #stars{ width:100vw; height: calc(var(--vh) * 100); max-height:none; }
    body.playing .hud{ position:absolute; top: calc(env(safe-area-inset-top, 0px) + 10px); left: 10px; right: 10px; margin:0;
      background: linear-gradient(180deg, rgba(6,10,24,.65), rgba(6,10,24,.35)); border: 1px solid rgba(255,255,255,.12); }

    /* A11y */
    :focus-visible{ outline: 3px solid rgba(111,211,245,.85); outline-offset:2px; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <header class="app" role="banner" aria-label="Exercise header">
    <a class="home" href="/" aria-label="Back to Home">← Home</a>
    <h1>Cosmic Maze</h1>
  </header>

  <main class="layout">
    <!-- SETTINGS (keeps existing Maze IDs for JS compatibility) -->
    <aside id="settings" class="panel" aria-label="Settings">
      <h2>Session Settings</h2>
      <div class="desc"><strong>How to play:</strong> guide the ship along the dotted paths from <em>Start</em> to <em>Earth</em>. Drag or use arrow keys. Avoid walls.</div>

      <div class="stats-row" role="region" aria-label="Player stats">
        <div class="metric" aria-live="polite">
          <div id="pbSettings" class="v">0</div>
          <div class="t">Personal Best</div>
        </div>
      </div>

      <div class="group">
        <label class="label" for="difficulty-select">Difficulty</label>
        <select id="difficulty-select">
          <option value="easy" selected>Easy — wide paths</option>
          <option value="medium">Medium — standard paths</option>
          <option value="hard">Hard — narrow paths</option>
        </select>
      </div>

      <div class="group">
        <label class="label" for="session-duration">Session Duration (minutes)</label>
        <input id="session-duration" type="number" min="1" max="10" value="5" inputmode="decimal" />
      </div>

      <div class="group">
        <label class="label" for="show-trace">Movement Trail</label>
        <select id="show-trace">
          <option value="yes" selected>Show trail</option>
          <option value="no">Hide trail</option>
        </select>
      </div>

      <div class="settings-actions">
        <button id="start-session" class="btn btn-primary" type="button">Start</button>
        <button id="pause-session" class="btn" type="button" aria-pressed="false">Pause</button>
        <button id="restart-session" class="btn" type="button">Restart</button>
      </div>
    </aside>

    <!-- GAME -->
    <section class="right" aria-label="Game area">
      <div class="hud panel" role="region" aria-label="Session HUD">
        <div class="metric" aria-live="polite"><div id="hud-score" class="v">0</div><div class="t">Score</div></div>
        <div class="metric" aria-live="polite"><div id="hud-pb" class="v">0</div><div class="t">Personal Best</div></div>
        <div class="metric" aria-live="polite"><div id="hud-difficulty" class="v">easy</div><div class="t">Difficulty</div></div>
        <div class="metric" aria-live="polite"><div id="hud-completed" class="v">0</div><div class="t">Mazes</div></div>
        <div class="metric" aria-live="polite"><div id="hud-moves" class="v">0</div><div class="t">Moves</div></div>
        <div class="metric" aria-live="polite"><div id="hud-avg" class="v">0.0s</div><div class="t">Avg</div></div>
        <div class="metric" aria-live="polite"><div id="hud-time" class="v">5:00</div><div class="t">Time</div></div>
        <div class="actions">
          <button id="pauseHud" class="btn-ghost" type="button" aria-label="Pause or resume">Pause</button>
          <button id="exitHud" class="btn-ghost" type="button" aria-label="Exit to results">Exit</button>
        </div>
      </div>

      <div class="frame panel">
        <div class="timer-bar" id="timer-bar" aria-hidden="true"></div>
        <canvas id="stars" width="1280" height="720" aria-hidden="true"></canvas>
        <div id="maze-container" tabindex="0" role="application" aria-label="Cosmic maze game area. Use arrow keys or drag to move."></div>
      </div>
    </section>
  </main>

  <!-- Completion (reuse existing IDs so your current JS keeps working) -->
  <div id="completion-message" class="panel hidden" role="dialog" aria-modal="true" aria-labelledby="complete-title" style="max-width:min(560px, 92vw); margin: 20px auto; padding: 22px; text-align:center;">
    <h2 id="complete-title">Therapy Session Complete!</h2>
    <div id="completion-scores" aria-live="polite">
      <p>Mazes Completed: <span id="final-completed" class="v">0</span></p>
      <p>Average Completion Time: <span id="final-avg-time" class="v">0.0s</span></p>
      <p>Motor Performance Score: <span id="final-score" class="v">0</span></p>
      <p>XP Earned: <span id="final-xp" class="v">0</span></p>
    </div>
    <div class="settings-actions" style="grid-template-columns:1fr 1fr;">
      <button id="restart-button" class="btn btn-primary" type="button">Start New Session</button>
      <button class="btn" id="close-complete" type="button">Close</button>
    </div>
  </div>

  <script>
  (function(){
    // ===== Viewport unit for mobile safe (like Comet)
    function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
    setVH(); window.addEventListener('resize', setVH, {passive:true});

    // ===== Starfield (canvas, lightweight parallax)
    const stars = document.getElementById('stars');
    const ctx = stars.getContext('2d');
    let DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    const layers = [
      { count: 80, speed: .02, stars: [], alpha:.45 },
      { count: 50, speed: .06, stars: [], alpha:.75 },
      { count: 25, speed: .12, stars: [], alpha:1.0 }
    ];
    function fit(){ const r = stars.getBoundingClientRect(); stars.width = Math.max(640, Math.floor(r.width * DPR)); stars.height = Math.max(360, Math.floor((r.height||window.innerHeight*0.62) * DPR)); ctx.setTransform(DPR,0,0,DPR,0,0); }
    function initStars(){ layers.forEach((L,i)=>{ L.stars = Array.from({length:L.count}, () => ({ x: Math.random()*stars.width/DPR, y: Math.random()*stars.height/DPR, r: Math.random()*(i+1)*.8 + .5, tw: Math.random()*2*Math.PI })); }); }
    function drawStars(dt){ ctx.clearRect(0,0,stars.width,stars.height); layers.forEach(L=>{ ctx.save(); ctx.globalAlpha = L.alpha; L.stars.forEach(s=>{ s.x -= L.speed * dt * 0.06; if (s.x < -4) s.x = stars.width/DPR + 4, s.y = Math.random()*stars.height/DPR; s.tw += dt*0.002; const o = 0.65 + Math.sin(s.tw)*0.35; ctx.fillStyle = `rgba(255,255,255,${o})`; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill(); }); ctx.restore(); }); }
    let last = performance.now(); function loop(t){ const dt = t-last; last=t; drawStars(dt); requestAnimationFrame(loop); } fit(); initStars(); requestAnimationFrame(loop); new ResizeObserver(()=>{ fit(); initStars(); }).observe(stars);

    // ===== Immersive toggles: tie into existing Maze controls
    const startBtn = document.getElementById('start-session');
    const pauseBtn = document.getElementById('pause-session');
    const restartBtn = document.getElementById('restart-session');
    const pauseHudBtn = document.getElementById('pauseHud');
    const exitHudBtn = document.getElementById('exitHud');
    const completion = document.getElementById('completion-message');
    const closeComplete = document.getElementById('close-complete');
    const restartModalBtn = document.getElementById('restart-button');

    function toImmersive(){ document.body.classList.add('playing'); window.scrollTo({ top: 0, behavior: 'smooth' }); try{ const el=document.documentElement; if (el.requestFullscreen) el.requestFullscreen({ navigationUI:'hide' }); }catch{ /* noop */ } }
    function fromImmersive(){ document.body.classList.remove('playing'); try{ if (document.fullscreenElement) document.exitFullscreen(); }catch{ /* noop */ } }

    if(startBtn){ startBtn.addEventListener('click', ()=>{ toImmersive(); }); }
    if(restartBtn){ restartBtn.addEventListener('click', ()=>{ /* keep immersive */ }); }

    // HUD mirror pause/exit to existing controls
    if(pauseHudBtn){ pauseHudBtn.addEventListener('click', ()=>{ if(pauseBtn){ pauseBtn.click(); pauseHudBtn.textContent = (pauseBtn.getAttribute('aria-pressed') === 'true') ? 'Resume' : 'Pause'; } }); }
    if(exitHudBtn){ exitHudBtn.addEventListener('click', ()=>{ // best-effort: show completion if your game exposes an end
      fromImmersive(); completion?.classList.remove('hidden'); completion?.classList.add('show');
    }); }

    // When completion is dismissed, leave immersive
    if(closeComplete){ closeComplete.addEventListener('click', ()=>{ completion?.classList.remove('show'); completion?.classList.add('hidden'); fromImmersive(); }); }
    if(restartModalBtn){ restartModalBtn.addEventListener('click', ()=>{ /* immersive stays */ }); }

    // If your game code toggles completion via class="show", observe it
    const mo = new MutationObserver(() => {
      const isOpen = completion && (completion.classList.contains('show') || completion.style.display === 'block');
      if(isOpen){ fromImmersive(); }
    });
    if(completion) mo.observe(completion, { attributes:true, attributeFilter:['class','style'] });

    // Sync PB onto settings card if your game stores it
    try {
      const pbSettingsEl = document.getElementById('pbSettings');
      const pbHudEl = document.getElementById('hud-pb');
      const localPB = JSON.parse(localStorage.getItem('mazePersonalBest')||'0');
      if (pbSettingsEl) pbSettingsEl.textContent = String(localPB||0);
      if (pbHudEl && (pbHudEl.textContent==='0')) pbHudEl.textContent = String(localPB||0);
    } catch {}
  })();
  </script>

  <!--
    NOTE: This file preserves your current Maze JS IDs (difficulty-select, session-duration, show-trace,
    start-session, pause-session, restart-session, timer-bar, completion-message, etc.),
    so your existing game logic can be kept as-is. Drop your current <script type="module"> block below or import it.
  -->
</body>
</html>
