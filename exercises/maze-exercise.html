<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKCCWBFKE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-RVKCCWBFKE', { 'anonymize_ip': true });
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Cosmic Maze — Fine Motor Skills Rehabilitation | Fine Point Rehab</title>

  <!-- Preconnects -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>

  <!-- Design System -->
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/exercises.css">

  <style>
    /* ===== Global background + starfield ===== */
    body {
      min-height: 100vh;
      background:
        radial-gradient(ellipse at 20% 30%, rgba(40,20,80,0.4) 0%, transparent 40%),
        radial-gradient(ellipse at 80% 70%, rgba(20,40,80,0.3) 0%, transparent 40%),
        radial-gradient(ellipse at 50% 50%, rgba(10,20,40,0.5) 0%, transparent 70%),
        linear-gradient(180deg, #0a0e1a 0%, #1a1f3a 50%, #0f1524 100%);
    }

    /* ===== Sticky Header & Navigation ===== */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: blur(8px);
      background: rgba(8, 15, 35, 0.8);
      border-bottom: 1px solid var(--border);
    }
    .site-header .inner {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      max-width: 1200px;
      margin: 0 auto;
    }
    .home-link { text-decoration: none; }

    /* ===== Page layout ===== */
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-4);
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-4);
    }
    @media (min-width: 980px) {
      .page { grid-template-columns: 420px 1fr; align-items: start; }
    }

    /* ===== Panels & HUD ===== */
    .panel {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
    }

    .settings-panel { padding: var(--space-4); }
    .settings-panel h2 { margin: 0 0 var(--space-4); font-size: var(--font-size-lg); text-align: center; }
    .game-description { background: var(--bg-tertiary); border-radius: var(--radius); padding: var(--space-4); margin-bottom: var(--space-4); border: 1px solid var(--border); }

    .settings-group { margin-bottom: var(--space-4); }
    .settings-label { display: block; margin-bottom: var(--space-2); font-weight: 700; }
    select, input[type="number"] {
      width: 100%; padding: var(--space-3); border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.2); background: rgba(5,10,26,.8);
      color: var(--text-primary); font-size: var(--font-size-base);
    }

    .instructions { text-align: center; color: var(--text-secondary); margin: 0 0 var(--space-3); font-size: var(--font-size-base); }

    .controls { display:flex; gap: var(--space-2); justify-content:center; flex-wrap:wrap; }

    .right-col { display:grid; grid-template-rows: auto 1fr; gap: var(--space-3); }

    .hud { display:flex; flex-wrap:wrap; align-items:center; gap: var(--space-2); padding: var(--space-3); position:relative; }
    .hud-group { text-align:center; padding: var(--space-2) var(--space-3); border:1px solid var(--border); border-radius: var(--radius); background: rgba(255,255,255,.05); min-width: 90px; }
    .hud-value { font-weight:900; font-size: clamp(16px, 3vw, 20px); color:#bfe6ff; text-shadow: 0 0 6px rgba(150,220,255,.5); line-height:1.1; }
    .hud-label { font-size: 11px; opacity: .9; margin-top: 4px; }

    .timer-bar { position:absolute; top:0; left:0; height:8px; width:100%; background: linear-gradient(90deg, var(--brand-aqua), rgba(121,217,255,.3)); transform-origin:left center; border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); }

    .game-container { position: relative; display:grid; place-items:center; padding: var(--space-3); background: rgba(0,0,0,0.15); border: 1px solid var(--border); border-radius: var(--radius-xl); box-shadow: var(--shadow-lg); overflow:hidden; }
    #stars-container { position: absolute; inset: 0; pointer-events: none; }
    #maze-container { position: relative; background-color: rgba(0, 0, 0, 0.3); border: 2px solid var(--brand-aqua); border-radius: var(--radius-lg); overflow: hidden; box-shadow: 0 0 20px rgba(121,217,255,.2); outline: none; }

    #error-message { color: #ffb3b3; padding: var(--space-2) var(--space-3); display:none; }
    #error-message.show { display:block; }

    /* Completion modal */
    #completion-message { max-width: min(560px, 92vw); margin: var(--space-4) auto; padding: var(--space-4); text-align:center; }
  </style>

  <!-- Comet-style Skin (non-breaking overlay) -->
  <style>
    :root{ --vh: 1vh; }
    /* Glass header like Comet */
    .site-header{
      backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(8,12,26,.9), rgba(8,12,26,.55));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    /* Panels + chips */
    .panel, .hud, .settings-panel, #completion-message{
      background: rgba(10,16,36,.9);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.05);
    }
    .btn-ghost{ border:1px solid rgba(255,255,255,.22); border-radius:999px; background: rgba(255,255,255,.06); color: inherit; }
    .btn-ghost:hover{ background: rgba(255,255,255,.12); }

    /* Primary button like Comet */
    .btn-primary, button#start-session{
      border:1px solid rgba(111,211,245,.9);
      background: rgba(111,211,245,.95);
      color:#07101e;
      font-weight:800;
    }
    .btn-primary:hover, button#start-session:hover{
      background: rgba(111,211,245,1);
      box-shadow: 0 6px 18px rgba(111,211,245,.45);
    }

    /* Maze frame glow */
    #maze-container{
      background-color: rgba(0,0,0,.25) !important;
      border: 2px solid var(--brand-aqua, #6fd3f5);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(111,211,245,.2);
      outline: none;
    }

    /* Timer bar styling */
    #timer-bar{
      position:absolute; top:0; left:0; height:8px; width:100%;
      background: linear-gradient(90deg, var(--brand-aqua, #6fd3f5), rgba(111,211,245,.35));
      transform-origin:left center;
      transition: transform .1s linear;
      border-top-left-radius: 12px; border-top-right-radius: 12px;
    }

    /* Immersive mode (full-bleed) */
    body.playing { overflow:hidden; }
    body.playing .site-header{ display:none; }
    body.playing .page { padding:0 !important; max-width: none; }
    body.playing .hud { position:fixed; z-index:10; left:10px; right:10px; top: calc(env(safe-area-inset-top, 0px) + 10px); background: linear-gradient(180deg, rgba(6,10,24,.65), rgba(6,10,24,.35)); }
    body.playing #maze-container{ width:100vw; height: calc(var(--vh) * 100); }

    /* Focus ring */
    :focus-visible{ outline: 3px solid rgba(111,211,245,.85); outline-offset:2px; }
  </style>
</head>
<body>
  <!-- ===== Sticky Header ===== -->
  <header class="site-header" role="banner">
    <div class="inner">
      <a class="home-link btn btn-secondary" href="/" aria-label="Go to Home">← Home</a>
      <h1 id="page-title">Cosmic Maze</h1>
    </div>
  </header>

  <!-- ===== Main Layout ===== -->
  <main class="page" role="main">
    <!-- Left: Settings -->
    <aside class="settings-panel panel" role="complementary" aria-labelledby="settings-heading">
      <h2 id="settings-heading">Session Settings</h2>

      <div class="game-description" aria-describedby="about-p">
        <p id="about-p"><strong>How to play:</strong> guide the ship along the dotted paths from <em>Start</em> to <em>Earth</em>. Drag or use arrow keys. Avoid walls.</p>
      </div>

      <div class="stats-row" role="region" aria-label="Player stats" style="display:flex;gap:10px;justify-content:center;margin-bottom:var(--space-3)">
        <div class="metric" aria-live="polite" style="display:flex;flex-direction:column;align-items:center;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);border-radius:12px;padding:8px 12px;min-width:110px;">
          <div id="pbSettings" class="v" style="font-weight:900;color:#bfe6ff;text-shadow:0 0 6px rgba(150,220,255,.5);font-size:18px;">0</div>
          <div class="t" style="font-size:11px;opacity:.9;margin-top:3px">Personal Best</div>
        </div>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="difficulty-select">Difficulty</label>
        <select id="difficulty-select" aria-label="Select difficulty">
          <option value="easy" selected>Easy — wide paths</option>
          <option value="medium">Medium — standard paths</option>
          <option value="hard">Hard — narrow paths</option>
        </select>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="session-duration">Session Duration (minutes)</label>
        <input id="session-duration" type="number" min="1" max="10" value="5" inputmode="decimal" aria-label="Session duration in minutes" />
      </div>

      <div class="settings-group">
        <label class="settings-label" for="show-trace">Movement Trail</label>
        <select id="show-trace" aria-label="Enable or disable movement trail">
          <option value="yes" selected>Show trail</option>
          <option value="no">Hide trail</option>
        </select>
        <small class="setting-help">Trail helps visualize movement patterns.</small>
      </div>

      <div class="controls" aria-label="Session controls (left panel)">
        <button id="start-session" class="btn btn-primary" aria-label="Start session">Start</button>
        <button id="pause-session" class="btn btn-secondary" aria-pressed="false" aria-label="Pause session">Pause</button>
        <button id="restart-session" class="btn" aria-label="Restart session">Restart</button>
      </div>

      <p id="error-message" role="alert" aria-live="assertive"></p>
    </aside>

    <!-- Right: HUD + Game -->
    <section class="right-col" aria-labelledby="page-title">
      <!-- HUD Row -->
      <div class="hud panel" role="region" aria-label="Session heads-up display">
        <div class="timer-bar" id="timer-bar" aria-hidden="true"></div>

        <div class="hud-group" aria-live="polite">
          <div id="hud-score" class="hud-value">0</div>
          <div class="hud-label">Score</div>
        </div>

        <div class="hud-group" aria-live="polite">
          <div id="hud-pb" class="hud-value">0</div>
          <div class="hud-label">Personal Best</div>
        </div>

        <div class="hud-group" aria-live="polite">
          <div id="hud-difficulty" class="hud-value">easy</div>
          <div class="hud-label">Difficulty</div>
        </div>

        <div class="hud-group" aria-live="polite">
          <div id="hud-completed" class="hud-value">0</div>
          <div class="hud-label">Mazes Completed</div>
        </div>

        <div class="hud-group" aria-live="polite">
          <div id="hud-moves" class="hud-value">0</div>
          <div class="hud-label">Moves</div>
        </div>

        <div class="hud-group" aria-live="polite">
          <div id="hud-avg" class="hud-value">0.0s</div>
          <div class="hud-label">Avg</div>
        </div>

        <div class="hud-group" aria-live="polite">
          <div id="hud-time" class="hud-value">5:00</div>
          <div class="hud-label">Time</div>
        </div>

        <div class="hud-actions" style="margin-left:auto;display:flex;gap:8px;">
          <button id="pauseHud" class="btn-ghost" type="button" aria-label="Pause or resume">Pause</button>
          <button id="exitHud" class="btn-ghost" type="button" aria-label="Exit to results">Exit</button>
        </div>
      </div>

      <!-- Game Frame -->
      <div id="game-container" class="game-container panel">
        <div id="stars-container" aria-hidden="true"></div>
        <div id="maze-container" tabindex="0" role="application" aria-label="Cosmic maze game area. Use arrow keys or drag to move."></div>
      </div>

      <p class="instructions" id="instructions">Tip: Drag on mobile, or use arrow keys on desktop. Avoid the walls!</p>
    </section>
  </main>

  <!-- ===== Completion ===== -->
  <div id="completion-message" class="panel hidden" role="dialog" aria-modal="true" aria-labelledby="complete-title">
    <h2 id="complete-title" style="margin-top:0">Therapy Session Complete!</h2>
    <div id="completion-scores" aria-live="polite">
      <p>Mazes Completed: <span id="final-completed" class="v">0</span></p>
      <p>Average Completion Time: <span id="final-avg-time" class="v">0.0s</span></p>
      <p>Motor Performance Score: <span id="final-score" class="v">0</span></p>
      <p>XP Earned: <span id="final-xp" class="v">0</span></p>
    </div>
    <div class="controls" style="justify-content:center">
      <button id="restart-button" class="btn btn-primary" type="button">Start New Session</button>
      <button class="btn" id="close-complete" type="button">Close</button>
    </div>
  </div>

  <!-- ===== Core MAZE logic (unchanged) ===== -->
  <script type="module">
    // Simplified imports - match the pattern from other exercises
    const storage = {
      get: (key, defaultValue) => {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : defaultValue;
        } catch {
          return defaultValue;
        }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.error('Storage error:', e);
        }
      }
    };

    // Simple starfield generator
    const starfield = {
      generate: (container, count = 150) => {
        if (!container) return;
        container.innerHTML = '';
        for (let i = 0; i < count; i++) {
          const star = document.createElement('div');
          star.style.position = 'absolute';
          star.style.width = Math.random() * 3 + 'px';
          star.style.height = star.style.width;
          star.style.backgroundColor = 'white';
          star.style.borderRadius = '50%';
          star.style.left = Math.random() * 100 + '%';
          star.style.top = Math.random() * 100 + '%';
          star.style.opacity = Math.random() * 0.8 + 0.2;
          container.appendChild(star);
        }
      }
    };

    // Exercise metadata
    const EXERCISE_ID = 'maze';

    // DOM refs
    const starsContainer = document.getElementById('stars-container');
    const mazeContainer  = document.getElementById('maze-container');
    const gameContainer  = document.getElementById('game-container');
    const errorMessage   = document.getElementById('error-message');

    // Settings refs
    const difficultySelect   = document.getElementById('difficulty-select');
    const sessionDurationInp = document.getElementById('session-duration');
    const showTraceSelect    = document.getElementById('show-trace');

    // Controls
    const startBtn   = document.getElementById('start-session');
    const pauseBtn   = document.getElementById('pause-session');
    const restartBtn = document.getElementById('restart-session');

    // HUD refs
    const timerBarEl   = document.getElementById('timer-bar');
    const scoreEl      = document.getElementById('hud-score');
    const pbEl         = document.getElementById('hud-pb');
    const diffEl       = document.getElementById('hud-difficulty');
    const completedEl  = document.getElementById('hud-completed');
    const movesEl      = document.getElementById('hud-moves');
    const avgEl        = document.getElementById('hud-avg');
    const timeEl       = document.getElementById('hud-time');

    // Completion refs
    const completionModal = document.getElementById('completion-message');
    const finalCompleted  = document.getElementById('final-completed');
    const finalAvgTime    = document.getElementById('final-avg-time');
    const finalScore      = document.getElementById('final-score');
    const finalXP         = document.getElementById('final-xp');
    const closeComplete   = document.getElementById('close-complete');
    const restartModalBtn = document.getElementById('restart-button');

    // Instructions
    const instructions = document.getElementById('instructions');

    // Stars!
    starfield.generate(starsContainer, 150);

    // State
    let isSessionActive = false;
    let isPaused = false;
    let sessionMs = 5 * 60 * 1000;
    let timeRemaining = 0;
    let timerInterval = null;

    let player = null, goal = null, startLabel = null, endLabel = null;
    let maze = [], path = [], rows = 9, cols = 14;
    let cellSize = 60, wallThickness = 12;
    let currentDifficulty = 'easy';
    let showTrace = true;

    // Session stats
    let mazesCompleted = 0;
    let currentMaze = 1;
    let totalCompletionTime = 0;
    let mazeStartTime = 0;
    let score = 0;
    let personalBest = storage.get('mazePersonalBest', 0);
    let moveCountThisMaze = 0;

    // Event handler registry for cleanup
    const eventHandlers = { keydown:null, mousedown:null, touchstart:null, mousemove:null, touchmove:null, mouseup:null, touchend:null };

    // Difficulty settings
    const difficultySizes = {
      easy:   { cellSize: 60, wallThickness: 12 },
      medium: { cellSize: 45, wallThickness: 10 },
      hard:   { cellSize: 30, wallThickness:  8 }
    };

    // Initialize
    function getCurrentDifficulty() { return difficultySelect?.value || 'easy'; }
    
    difficultySelect.addEventListener('change', () => {
      diffEl.textContent = getCurrentDifficulty();
    });

    // ...
    // (The remainder of your original Maze game logic stays here unchanged.)
    // ...

    // ===== Timer helpers =====
    function formatTime(ms){ const t=Math.max(0, Math.round(ms/1000)); const m=Math.floor(t/60); const s=t%60; return `${m}:${s.toString().padStart(2,'0')}`; }
    function startTimer(){ const start=Date.now(); const end=start+timeRemaining; timerInterval=setInterval(()=>{ const now=Date.now(); timeRemaining=Math.max(0, end-now); timeEl.textContent=formatTime(timeRemaining); const pct = (timeRemaining / sessionMs); timerBarEl.style.transform=`scaleX(${pct})`; if(timeRemaining<=0){ clearInterval(timerInterval); timerInterval=null; endSession(); } }, 100); }
    function stopTimer(){ clearInterval(timerInterval); timerInterval=null; }

    // ===== Game generation (simplified excerpt preserved) =====
    function generateMaze(){
      // (Original generateMaze implementation preserved in your file; omitted here for brevity in this preview.)
    }

    function clearMaze(){ if (mazeContainer) mazeContainer.innerHTML=''; }

    function updateHUD(){ scoreEl.textContent = String(score); pbEl.textContent = String(personalBest); diffEl.textContent = currentDifficulty; completedEl.textContent = String(mazesCompleted); movesEl.textContent = String(moveCountThisMaze); const avg = mazesCompleted ? (totalCompletionTime / mazesCompleted / 1000) : 0; avgEl.textContent = (avg>0?avg.toFixed(1):'0.0') + 's'; }

    // ===== Start/Pause/Restart =====
    startBtn.addEventListener('click', () => {
      try {
        // Read settings
        currentDifficulty = getCurrentDifficulty();
        const d = difficultySizes[currentDifficulty] || difficultySizes.easy;
        cellSize = d.cellSize; wallThickness = d.wallThickness;
        showTrace = showTraceSelect?.value !== 'no';
        sessionMs = Math.max(1, Number(sessionDurationInp.value)||5) * 60 * 1000;

        // Reset session state
        isSessionActive = true; isPaused = false; mazesCompleted=0; currentMaze=1; totalCompletionTime=0; score=0; moveCountThisMaze=0;
        timeRemaining = sessionMs; updateHUD();

        // Start timer & maze
        startTimer();

        // Maze
        generateMaze();
        mazeStartTime = Date.now();

        // Focus for keyboard play
        mazeContainer.focus();
      } catch (e) {
        console.error(e);
        showError('Failed to start session: ' + e.message);
      }
    });

    pauseBtn.addEventListener('click', () => {
      if (!isSessionActive) return;
      isPaused = !isPaused;
      pauseBtn.setAttribute('aria-pressed', String(isPaused));
      pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
      if (isPaused) { stopTimer(); } else { startTimer(); mazeContainer.focus(); }
    });

    restartBtn.addEventListener('click', () => {
      // Restart current session with same settings
      if (timerInterval) stopTimer(); isSessionActive=false; isPaused=false; timeRemaining=sessionMs; updateHUD(); clearMaze();
      // Recreate maze and resume timer
      isSessionActive=true; startTimer(); generateMaze(); mazeStartTime = Date.now(); mazeContainer.focus();
    });

    // ===== Completion helpers =====
    function showError(msg){ if(!errorMessage) return; errorMessage.textContent = msg; errorMessage.classList.add('show'); setTimeout(()=> errorMessage.classList.remove('show'), 4000); }

    function endSession(){ if(timerInterval) stopTimer(); isSessionActive=false; isPaused=false; const avgStr = mazesCompleted? (totalCompletionTime/mazesCompleted/1000).toFixed(1):'0.0'; const computedScore = Math.max(score, Math.round((mazesCompleted*100)/Math.max(1, (totalCompletionTime/mazesCompleted/1000)))); if(computedScore>personalBest){ personalBest=computedScore; storage.set('mazePersonalBest', personalBest);} updateHUD(); finalCompleted.textContent = `${mazesCompleted}`; finalAvgTime.textContent = `${avgStr}s`; finalScore.textContent = `${computedScore}`; finalXP.textContent = `${Math.max(10, Math.round(computedScore * 0.5))}`; completionModal.classList.add('show'); clearMaze(); }

    closeComplete?.addEventListener('click', ()=>{ completionModal.classList.remove('show'); });
    restartModalBtn?.addEventListener('click', ()=>{ completionModal.classList.remove('show'); startBtn.click(); });

    // Accessibility / mobile tweaks
    document.addEventListener('touchstart', e => { if (e.touches.length>1) e.preventDefault(); }, { passive:false });
    let lastTouchEnd = 0; document.addEventListener('touchend', e => { const now=Date.now(); if (now - lastTouchEnd <= 300) e.preventDefault(); lastTouchEnd=now; }, false);
    document.addEventListener('touchmove', e => { /* prevent scroll while playing */ if (isSessionActive && !isPaused) e.preventDefault(); }, { passive:false });
    document.addEventListener('contextmenu', e => e.preventDefault());
    window.addEventListener('beforeunload', () => { /* cleanup timers */ if (timerInterval) stopTimer(); });
  </script>

  <!-- Immersive helpers (non-breaking) -->
  <script>
    (function(){
      const setVH=()=>document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px');
      setVH(); addEventListener('resize', setVH, {passive:true});
      const start = document.getElementById('start-session');
      const completion = document.getElementById('completion-message');
      if (start) start.addEventListener('click', () => {
        document.body.classList.add('playing');
        try{ const el=document.documentElement; if (el.requestFullscreen) el.requestFullscreen({navigationUI:'hide'});}catch{}
        scrollTo({top:0,behavior:'smooth'});
      });
      if (completion) {
        const mo = new MutationObserver(() => {
          const open = completion.classList.contains('show') || completion.style.display === 'block';
          if (open) {
            document.body.classList.remove('playing');
            try{ if (document.fullscreenElement) document.exitFullscreen(); }catch{}
          }
        });
        mo.observe(completion, {attributes:true, attributeFilter:['class','style']});
      }
    })();
  </script>
</body>
</html>
