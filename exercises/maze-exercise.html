<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKCCWBFKE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-RVKCCWBFKE', { 'anonymize_ip': true });
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Cosmic Maze — Fine Motor Skills Rehabilitation | Fine Point Rehab</title>

  <!-- Preconnects -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>

  <!-- Design System -->
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/exercises.css">

  <!-- Existing styles (kept) -->
  <style>
    :root {
      --bg: #0a0e1a;
      --panel: rgba(12,18,40,0.88);
      --panel-border: rgba(255,255,255,0.06);
      --text: #e6f0ff;
      --accent: var(--brand-aqua, #79d9ff);
      --radius: 14px;
      --grid-gap: 14px;
      --shadow-1: 0 10px 30px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.05);
      --border: rgba(255,255,255,.08);
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      color: var(--text);
      background:
        radial-gradient(1000px 700px at 15% 25%, rgba(70,30,120,0.28) 0%, transparent 60%),
        radial-gradient(900px 600px at 80% 70%, rgba(20,120,160,0.22) 0%, transparent 60%),
        radial-gradient(ellipse at 50% 50%, rgba(10,20,40,0.5) 0%, transparent 70%),
        linear-gradient(180deg, #0a0e1a 0%, #1a1f3a 50%, #0f1524 100%);
    }

    /* ===== Sticky Header & Navigation ===== */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: blur(8px);
      background: rgba(8, 15, 35, 0.8);
      border-bottom: 1px solid var(--border);
    }
    .site-header .inner {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .home-link {
      display: inline-flex;
      align-items: center;
      gap: .5ch;
      text-decoration: none;
    }

    /* ===== Two-column shared layout ===== */
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--grid-gap);
    }

    @media (min-width: 980px) {
      .page {
        grid-template-columns: 420px 1fr;
        align-items: start;
      }
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-1);
    }

    /* ===== Settings Card ===== */
    .settings { padding: 16px; }
    .settings h2 { margin: 0 0 8px; font-size: 20px; text-align: center; }
    .howto { margin: 10px 0 14px; padding: 10px; border-left: 4px solid rgba(121,217,255,.7); border-radius: 8px; background: rgba(121,217,255,.08); font-size: 14px; }

    .group { margin-bottom: 12px; }
    .label { display:block; margin-bottom:6px; font-weight:700; }
    select, input[type="number"] {
      width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.2);
      background: rgba(5,10,26,.8); color: var(--text); font-size: 16px;
    }
    select:focus, input[type="number"]:focus {
      outline: none; border-color: rgba(121,217,255,.9); box-shadow: 0 0 0 2px rgba(121,217,255,.25);
    }

    .stats-row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 10px 0 12px; }
    .metric { flex:0 0 auto; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:8px 12px; border:1px solid rgba(255,255,255,.12); border-radius:12px; background: rgba(255,255,255,.05); min-width:110px; }
    .metric .v { font-weight: 900; font-size: 18px; color: #bfe6ff; text-shadow: 0 0 6px rgba(150,220,255,.5); line-height: 1.1; }
    .metric .t { font-size: 11px; opacity: .9; margin-top: 3px; }

    .btn { min-height:46px; border:1px solid rgba(121,217,255,.35); background: rgba(121,217,255,.12); color:var(--text); border-radius:10px; font-weight:800; letter-spacing:.2px; cursor:pointer; transition:.2s; }
    .btn:hover:not(:disabled){ background: rgba(121,217,255,.22); transform: translateY(-1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn-primary { background: rgba(121,217,255,.95); color:#07101e; border-color: rgba(121,217,255,1); }
    .btn-primary:hover:not(:disabled){ background: rgba(121,217,255,1); box-shadow: 0 6px 18px rgba(121,217,255,.45); }

    .settings-actions { display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px; }

    /* ===== HUD + Game ===== */
    .game-col { display:grid; grid-template-rows: auto 1fr; gap: 10px; }
    .hud-bar { display:flex; flex-wrap:wrap; align-items:center; gap:8px; padding:8px 10px; margin-bottom: 10px; background: rgba(8,14,36,.85); border: 1px solid var(--panel-border); border-radius: var(--radius); box-shadow: 0 6px 16px rgba(0,0,0,.35); position: relative; z-index: 4; }
    .hud-actions { margin-left: auto; display: flex; gap: 8px; }
    .btn-ghost { min-height:34px; padding:6px 10px; font-weight:800; border:1px solid rgba(255,255,255,.22); border-radius:999px; background: rgba(255,255,255,.06); color:var(--text); cursor:pointer; white-space:nowrap; }
    .btn-ghost:hover{ background: rgba(255,255,255,.12); }

    .frame { position:relative; border-radius: var(--radius); overflow:hidden; border:1px solid var(--panel-border); box-shadow: inset 0 0 40px rgba(0,0,0,.35); background: radial-gradient(60% 45% at 50% 40%, rgba(80,160,200,.12), transparent 68%); }

    /* Timer bar */
    #timer-bar { position:absolute; top:0; left:0; height:8px; width:100%; background: linear-gradient(90deg, var(--accent), rgba(121,217,255,.35)); transform-origin:left center; transition: transform .1s linear; border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); }

    /* Maze container */
    #maze-container { position: relative; margin: 0 auto; background-color: rgba(0,0,0,0.25); border: 2px solid var(--accent); border-radius: 12px; overflow: hidden; box-shadow: 0 0 20px rgba(121,217,255,.2); touch-action: none; outline: none; }

    /* Immersive mode */
    :root { --vh: 1vh; }
    body.playing { overflow: hidden; }
    body.playing .site-header { display: none; }
    body.playing .page { padding: 0 !important; max-width: none; }
    body.playing .hud-bar { position: fixed; z-index: 10; left: 10px; right: 10px; top: calc(env(safe-area-inset-top, 0px) + 10px); background: linear-gradient(180deg, rgba(6,10,24,.65), rgba(6,10,24,.35)); }
    body.playing .frame { border-radius: 0; border: none; box-shadow: none; background: transparent; }
    body.playing #maze-container { width: 100vw; height: calc(var(--vh) * 100); }

    /* A11y */
    :focus-visible { outline: 3px solid rgba(121,217,255,.85); outline-offset: 2px; }
    .hidden{ display:none !important; }
  </style>

  <!-- Comet-style MAZE SKIN (non-breaking) -->
  <style>
    /* === Comet-style Skin for Maze (non-breaking) === */
    :root{
      --vh: 1vh;
      --panel: rgba(10,16,36,.9);
      --panel-border: rgba(255,255,255,.08);
    }

    body {
      background:
        radial-gradient(1200px 800px at 20% 25%, rgba(70,30,120,.35), transparent 60%),
        radial-gradient(900px 700px at 75% 65%, rgba(20,120,160,.28), transparent 55%),
        linear-gradient(180deg, #070b16 0%, #0f1630 50%, #0b1024 100%);
    }

    /* Header glass */
    .site-header {
      backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(8,12,26,.9), rgba(8,12,26,.55));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    /* Panels + chips */
    .card, .hud-bar, .settings, #completion-message {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.05);
    }

    .hud-chip, .stat-chip, .btn-ghost {
      border:1px solid rgba(255,255,255,.22);
      border-radius:999px;
      background: rgba(255,255,255,.06);
    }
    .btn-ghost:hover{ background: rgba(255,255,255,.12); }

    /* Primary button like Comet */
    .btn-primary, button#start-session {
      border:1px solid rgba(111,211,245,.9);
      background: rgba(111,211,245,.95);
      color:#07101e;
      font-weight:800;
    }
    .btn-primary:hover, button#start-session:hover{
      background: rgba(111,211,245,1);
      box-shadow: 0 6px 18px rgba(111,211,245,.45);
    }

    /* Maze frame glow */
    #maze-container{
      background-color: rgba(0,0,0,.25) !important;
      border: 2px solid var(--brand-aqua, #6fd3f5);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(111,211,245,.2);
      outline: none;
    }

    /* Timer bar styling */
    #timer-bar{
      position:absolute; top:0; left:0; height:8px; width:100%;
      background: linear-gradient(90deg, var(--brand-aqua, #6fd3f5), rgba(111,211,245,.35));
      transform-origin:left center;
      transition: transform .1s linear;
      border-top-left-radius: 12px; border-top-right-radius: 12px;
    }

    /* Immersive mode (full-bleed) */
    body.playing { overflow:hidden; }
    body.playing .site-header{ display:none; }
    body.playing .main-grid, body.playing main { padding:0 !important; }
    body.playing #maze-container{ position:relative; z-index:1; width: min(100vw, 100%); height: calc(var(--vh) * 100); }
    body.playing .hud-bar{ position:fixed; z-index:2; left:10px; right:10px; top: calc(env(safe-area-inset-top, 0px) + 10px); background: linear-gradient(180deg, rgba(6,10,24,.65), rgba(6,10,24,.35)); }

    /* A11y focus */
    :focus-visible{ outline: 3px solid rgba(111,211,245,.85); outline-offset:2px; }
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
  <header class="site-header" role="banner">
    <div class="inner">
      <a href="/" class="home-link" aria-label="Back to Home">← Home</a>
      <h1 style="margin:0;font-size:clamp(18px,3vw,24px)">Cosmic Maze</h1>
    </div>
  </header>

  <main class="page">
    <!-- ===== Settings ===== -->
    <aside class="settings card" id="settings" aria-label="Settings">
      <h2>Session Settings</h2>
      <div class="howto"><strong>How to play:</strong> guide the ship along the dotted paths from <em>Start</em> to <em>Earth</em>. Drag or use arrow keys. Avoid walls.</div>

      <div class="stats-row" role="region" aria-label="Player stats">
        <div class="metric" aria-live="polite">
          <div id="pbSettings" class="v">0</div>
          <div class="t">Personal Best</div>
        </div>
      </div>

      <!-- Keep existing controls/IDs -->
      <div class="group">
        <label class="label" for="difficulty-select">Difficulty</label>
        <select id="difficulty-select">
          <option value="easy" selected>Easy — wide paths</option>
          <option value="medium">Medium — standard paths</option>
          <option value="hard">Hard — narrow paths</option>
        </select>
      </div>

      <div class="group">
        <label class="label" for="session-duration">Session Duration (minutes)</label>
        <input id="session-duration" type="number" min="1" max="10" value="5" inputmode="decimal" />
      </div>

      <div class="group">
        <label class="label" for="show-trace">Movement Trail</label>
        <select id="show-trace">
          <option value="yes" selected>Show trail</option>
          <option value="no">Hide trail</option>
        </select>
      </div>

      <div class="settings-actions">
        <button id="start-session" class="btn btn-primary" type="button">Start</button>
        <button id="pause-session" class="btn" type="button" aria-pressed="false">Pause</button>
        <button id="restart-session" class="btn" type="button">Restart</button>
      </div>
    </aside>

    <!-- ===== Game ===== -->
    <section class="game-col" aria-label="Game area">
      <div class="hud-bar card" role="region" aria-label="Session HUD">
        <div class="metric" aria-live="polite"><div id="hud-score" class="v">0</div><div class="t">Score</div></div>
        <div class="metric" aria-live="polite"><div id="hud-pb" class="v">0</div><div class="t">Personal Best</div></div>
        <div class="metric" aria-live="polite"><div id="hud-difficulty" class="v">easy</div><div class="t">Difficulty</div></div>
        <div class="metric" aria-live="polite"><div id="hud-completed" class="v">0</div><div class="t">Mazes</div></div>
        <div class="metric" aria-live="polite"><div id="hud-moves" class="v">0</div><div class="t">Moves</div></div>
        <div class="metric" aria-live="polite"><div id="hud-avg" class="v">0.0s</div><div class="t">Avg</div></div>
        <div class="metric" aria-live="polite"><div id="hud-time" class="v">5:00</div><div class="t">Time</div></div>
        <div class="hud-actions">
          <button id="pauseHud" class="btn-ghost" type="button" aria-label="Pause or resume">Pause</button>
          <button id="exitHud" class="btn-ghost" type="button" aria-label="Exit to results">Exit</button>
        </div>
      </div>

      <div class="frame card">
        <div class="timer-bar" id="timer-bar" aria-hidden="true"></div>
        <div id="maze-container" tabindex="0" role="application" aria-label="Cosmic maze game area. Use arrow keys or drag to move."></div>
      </div>
    </section>
  </main>

  <!-- ===== Completion ===== -->
  <div id="completion-message" class="card hidden" role="dialog" aria-modal="true" aria-labelledby="complete-title" style="max-width:min(560px, 92vw); margin: 20px auto; padding: 22px; text-align:center;">
    <h2 id="complete-title">Therapy Session Complete!</h2>
    <div id="completion-scores" aria-live="polite">
      <p>Mazes Completed: <span id="final-completed" class="v">0</span></p>
      <p>Average Completion Time: <span id="final-avg-time" class="v">0.0s</span></p>
      <p>Motor Performance Score: <span id="final-score" class="v">0</span></p>
      <p>XP Earned: <span id="final-xp" class="v">0</span></p>
    </div>
    <div class="settings-actions" style="grid-template-columns:1fr 1fr;">
      <button id="restart-button" class="btn btn-primary" type="button">Start New Session</button>
      <button class="btn" id="close-complete" type="button">Close</button>
    </div>
  </div>

  <!-- Existing JS and modules (unchanged) -->
  <script>
  (function(){
    // Sync PB into HUD/settings if present
    try {
      const pbSettingsEl = document.getElementById('pbSettings');
      const pbHudEl = document.getElementById('hud-pb');
      const localPB = JSON.parse(localStorage.getItem('mazePersonalBest')||'0');
      if (pbSettingsEl) pbSettingsEl.textContent = String(localPB||0);
      if (pbHudEl && (pbHudEl.textContent==='0')) pbHudEl.textContent = String(localPB||0);
    } catch {}

    // Mirror HUD pause/exit to core controls if your main JS wires them
    const pauseBtn = document.getElementById('pause-session');
    const pauseHudBtn = document.getElementById('pauseHud');
    const exitHudBtn  = document.getElementById('exitHud');
    if (pauseHudBtn && pauseBtn) pauseHudBtn.addEventListener('click', ()=>{ pauseBtn.click(); });
    if (exitHudBtn) exitHudBtn.addEventListener('click', ()=>{ const c=document.getElementById('completion-message'); c?.classList.remove('hidden'); c?.classList.add('show'); });
  })();
  </script>

  <!-- Comet-style immersive helpers (non-breaking) -->
  <script>
    (function(){
      const setVH=()=>document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px');
      setVH(); addEventListener('resize', setVH, {passive:true});

      const start = document.getElementById('start-session');
      const completion = document.getElementById('completion-message');

      if (start) start.addEventListener('click', () => {
        document.body.classList.add('playing');
        try{ const el=document.documentElement; if (el.requestFullscreen) el.requestFullscreen({navigationUI:'hide'});}catch{}
        scrollTo({top:0,behavior:'smooth'});
      });

      if (completion) {
        const mo = new MutationObserver(() => {
          const open = completion.classList.contains('show') || completion.style.display === 'block';
          if (open) {
            document.body.classList.remove('playing');
            try{ if (document.fullscreenElement) document.exitFullscreen(); }catch{}
          }
        });
        mo.observe(completion, {attributes:true, attributeFilter:['class','style']});
      }
    })();
  </script>

  <!--
    NOTE: This merged file keeps all of your original Maze IDs and logic hooks intact
    (start-session, pause-session, restart-session, timer-bar, completion-message, etc.).
    It adds Comet-style visuals and an immersive toggle without touching core game code.
  -->
</body>
</html>

